<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Choose a Puzzle | Salam Adventures</title>
  <style>
    :root{
      --ink:#111827; --muted:#6b7280;
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(255,79,163,.22), transparent 60%),
        radial-gradient(1000px 650px at 85% 30%, rgba(56,189,248,.22), transparent 55%),
        radial-gradient(900px 550px at 45% 90%, rgba(251,191,36,.18), transparent 55%),
        linear-gradient(135deg, #ffe9f3, #e9fbff);
      overflow:hidden;
      color:var(--ink);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    /* THE FIX: We use a pseudo-element for the animated border */
    .panel{
      width:min(1020px, 100%);
      position:relative;
      border-radius:calc(var(--r) + 10px);
      padding:6px;
      background: transparent; /* Background is now handled by ::before */
      box-shadow: 0 18px 45px rgba(0,0,0,.16);
      z-index: 1;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: conic-gradient(from 0deg,
        #ff4fa3, #38bdf8, #fbbf24, #34d399, #a78bfa, #ff4fa3);
      animation: borderHue 2.9s linear infinite;
      z-index: -1; /* Keeps the flash BEHIND the content */
    }
    
    @keyframes borderHue {
      to { filter: hue-rotate(360deg); }
    }

    .panel::after{
      content:"";
      position:absolute;
      inset:-6px;
      border-radius:calc(var(--r) + 16px);
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.85), transparent 30%),
        radial-gradient(circle at 80% 25%, rgba(255,255,255,.75), transparent 28%),
        radial-gradient(circle at 60% 85%, rgba(255,255,255,.65), transparent 30%),
        radial-gradient(circle at 30% 80%, rgba(255,255,255,.55), transparent 32%);
      filter: drop-shadow(0 0 12px rgba(255,255,255,.55));
      opacity:.55;
      animation: sparkle 1.6s ease-in-out infinite alternate;
      pointer-events:none;
      mix-blend-mode: screen;
      z-index: 2; /* Sparkles stay on top */
    }

    @keyframes sparkle{from{opacity:.28; transform:scale(1)}to{opacity:.80; transform:scale(1.01)}}

    .inner{
      background:rgba(255,255,255,.94); /* Increased opacity to block any bleed-through */
      backdrop-filter: blur(10px);
      border-radius:var(--r);
      padding:18px;
      border: 1px solid rgba(0,0,0,.06);
      position: relative;
    }

    /* Rest of the styling remains exactly the same */
    .top{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:14px; }
    h1{ margin:0; font-weight:1000; letter-spacing:-.02em; font-size: clamp(18px, 3.2vw, 28px); }
    .sub{ margin:6px 0 0; color:var(--muted); font-size:14px; line-height:1.35; }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .btn{ appearance:none; border:none; border-radius:16px; padding:10px 13px; font-weight:1000; cursor:pointer; font-size:13px; box-shadow: 0 10px 0 rgba(0,0,0,.12), 0 18px 26px rgba(0,0,0,.16); transition: transform .08s ease; background: linear-gradient(180deg, #111827, #0b1220); color:#fff; touch-action: manipulation; }
    .btn.secondary{ background: linear-gradient(180deg, #ffffff, #f3f4f6); color:#111827; border:1px solid rgba(0,0,0,.12); box-shadow: 0 10px 0 rgba(0,0,0,.08), 0 18px 26px rgba(0,0,0,.12); }
    .btn:active{transform: translateY(2px); box-shadow: 0 8px 0 rgba(0,0,0,.12), 0 14px 22px rgba(0,0,0,.14);}
    .pill{ border-radius:999px; padding:8px 10px; font-weight:1000; font-size:13px; border:1px solid rgba(0,0,0,.12); background: rgba(255,255,255,.72); box-shadow: 0 10px 0 rgba(0,0,0,.08), 0 18px 26px rgba(0,0,0,.10); display:flex; gap:8px; align-items:center; color:#111827; }
    .grid{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:14px; }
    @media (max-width: 820px){ .grid{grid-template-columns: 1fr;} }
    .card{ border-radius:18px; border:1px solid rgba(0,0,0,.10); overflow:hidden; background: rgba(255,255,255,.75); box-shadow: 0 18px 40px rgba(0,0,0,.10); cursor:pointer; transition: transform .12s ease; touch-action: manipulation; }
    .card:active{transform: scale(.99)}
    .thumb{ height:170px; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, rgba(191,231,255,.55), rgba(255,230,242,.55)); }
    .thumb img{ max-height:170px; width:auto; max-width:100%; display:block; }
    .cardBody{ padding:12px 12px 14px; }
    .cardTitle{ margin:0; font-weight:1000; font-size:16px; }
    .cardNote{ margin:6px 0 0; color:var(--muted); font-weight:800; font-size:13px; }
    .stageWrap{ display:none; gap:14px; align-items:start; }
    .stageWrap.on{display:grid; grid-template-columns: 1fr 280px;}
    @media (max-width: 980px){ .stageWrap.on{grid-template-columns: 1fr;} }
    .stage{ position:relative; border-radius:18px; border:1px solid rgba(0,0,0,.10); overflow:hidden; background: radial-gradient(900px 450px at 30% 20%, rgba(255,255,255,.65), transparent 60%), linear-gradient(180deg, rgba(191,231,255,.85), rgba(255,230,242,.75)); box-shadow: 0 18px 40px rgba(0,0,0,.12); height: 560px; }
    @media (max-width: 680px){ .stage{height: 520px;} }
    canvas{display:block; width:100%; height:100%;}
    .side{ border-radius:18px; border:1px solid rgba(0,0,0,.10); background: rgba(255,255,255,.72); box-shadow: 0 18px 40px rgba(0,0,0,.10); padding:12px; }
    .side h2{ margin:0 0 8px; font-size:16px; font-weight:1000; }
    .side p{ margin:0 0 12px; color:var(--muted); font-weight:800; font-size:13px; line-height:1.35; }
    .toggleRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:6px;}
    .toggleBtn{ appearance:none; border:1px solid rgba(0,0,0,.12); background: linear-gradient(180deg, #ffffff, #f3f4f6); color:#111827; padding:10px 12px; border-radius:14px; font-weight:1000; cursor:pointer; box-shadow: 0 10px 0 rgba(0,0,0,.08), 0 18px 26px rgba(0,0,0,.12); }
    .toggleBtn.on{ background: linear-gradient(180deg, #111827, #0b1220); color:#fff; border-color: rgba(0,0,0,.25); }
    .hintImg{ width:100%; border-radius:14px; border:1px solid rgba(0,0,0,.10); overflow:hidden; background:#fff; }
    .hintImg img{width:100%; height:auto; display:block;}
    .tiny{margin-top:10px; font-size:12px; color:var(--muted); font-weight:800;}
    .centerNote{text-align:center; margin-top:12px; color:var(--muted); font-weight:800; font-size:13px;}
    .glitter{ position:absolute; width:10px; height:10px; border-radius:50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,1), rgba(255,255,255,0) 70%); filter: drop-shadow(0 0 12px rgba(255,255,255,.85)); pointer-events:none; animation: pop 700ms ease-out forwards; }
    @keyframes pop{ 0%{opacity:0; transform: translate(0,0) scale(.6);} 15%{opacity:1;} 100%{opacity:0; transform: translate(var(--dx), var(--dy)) scale(1.2);} }
  </style>
</head>

<body>
  <main class="panel">
    <div class="inner">
      <div class="top">
        <div>
          <h1>Choose a Puzzle</h1>
          <p class="sub">Pick a picture, then drag the pieces to complete it. üß©‚ú®</p>
        </div>
        <div class="controls">
          <div class="pill">‚úÖ Solved: <span id="solvedCount">0</span></div>
          <button class="btn secondary" id="homeBtn" type="button" style="display:none;">Back to pictures</button>
          <button class="btn secondary" id="shuffleBtn" type="button" style="display:none;">Shuffle</button>
        </div>
      </div>

      <section id="gallery">
        <div class="grid">
          <div class="card" data-pick="star">
            <div class="thumb"><img id="thumbStar" alt="Star"></div>
            <div class="cardBody">
              <p class="cardTitle">Star in the Clouds</p>
              <p class="cardNote">A dreamy night puzzle üåô‚≠ê</p>
            </div>
          </div>
          <div class="card" data-pick="balloon">
            <div class="thumb"><img id="thumbBalloon" alt="Balloon"></div>
            <div class="cardBody">
              <p class="cardTitle">Balloon Surprise</p>
              <p class="cardNote">Pop of colour and magic üéà‚ú®</p>
            </div>
          </div>
          <div class="card" data-pick="salam">
            <div class="thumb"><img id="thumbSalam" alt="Salam"></div>
            <div class="cardBody">
              <p class="cardTitle">Salam Adventures</p>
              <p class="cardNote">Put our mascot together! ü¶éüìö</p>
            </div>
          </div>
        </div>
        <div class="centerNote">Tip: 2√ó2 is easy, 3√ó3 is a little challenge.</div>
      </section>

      <section id="stageWrap" class="stageWrap">
        <div class="stage" id="stage"><canvas id="cv"></canvas></div>
        <aside class="side">
          <h2 id="pTitle">Puzzle</h2>
          <p>Drag the pieces into place. They snap when they‚Äôre close.</p>
          <div class="toggleRow">
            <button class="toggleBtn on" id="btn2">2√ó2</button>
            <button class="toggleBtn" id="btn3">3√ó3</button>
          </div>
          <div style="height:10px"></div>
          <div class="hintImg"><img id="hintImg" alt="Hint"></div>
          <div class="tiny">Made for little hands (tablet-friendly). üéâ</div>
        </aside>
      </section>
    </div>
  </main>

<script>
  /* All JavaScript remains identical to your working logic */
  const IMAGES = {
    star:   { title: "Star in the Clouds", file: "star.png" },
    balloon:{ title: "Balloon Surprise",   file: "balloon.png" },
    salam:  { title: "Salam Adventures",   file: "salam.png" }
  };

  const gallery = document.getElementById("gallery"), stageWrap = document.getElementById("stageWrap"), homeBtn = document.getElementById("homeBtn"), shuffleBtn = document.getElementById("shuffleBtn"), solvedCountEl = document.getElementById("solvedCount");
  const btn2 = document.getElementById("btn2"), btn3 = document.getElementById("btn3"), pTitle = document.getElementById("pTitle"), hintImg = document.getElementById("hintImg"), cv = document.getElementById("cv"), ctx2d = cv.getContext("2d");
  const thumbStar = document.getElementById("thumbStar"), thumbBalloon = document.getElementById("thumbBalloon"), thumbSalam = document.getElementById("thumbSalam");

  let solvedCount = 0, gridN = 2, currentKey = null, img = null, pieces = [], dragging = null, board = { x: 0, y: 0, w: 0, h: 0 }, anim = null, completed = false;

  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;
  function ensureAudio(){ if (!audioCtx) audioCtx = new AudioCtx(); if (audioCtx.state === "suspended") audioCtx.resume(); }
  function successChime(){
    ensureAudio(); if (!audioCtx || audioCtx.state !== "running") return;
    const now = audioCtx.currentTime; const g = audioCtx.createGain(); g.gain.value = 0.06; g.connect(audioCtx.destination);
    [523.25, 659.25, 783.99].forEach((f,i)=>{
      const o = audioCtx.createOscillator(), og = audioCtx.createGain(); o.type = "sine"; o.frequency.value = f;
      og.gain.setValueAtTime(0.001, now + i*0.09); og.gain.exponentialRampToValueAtTime(1.0, now + i*0.09 + 0.01); og.gain.exponentialRampToValueAtTime(0.001, now + i*0.09 + 0.12);
      o.connect(og); og.connect(g); o.start(now + i*0.09); o.stop(now + i*0.09 + 0.13);
    });
  }

  function resizeCanvas(){
    const rect = cv.getBoundingClientRect(), dpr = Math.max(1, window.devicePixelRatio || 1);
    cv.width = Math.floor(rect.width * dpr); cv.height = Math.floor(rect.height * dpr);
    ctx2d.setTransform(dpr,0,0,dpr,0,0);
    const pad = 18, w = rect.width, h = rect.height, size = Math.min(w, h) - pad*2;
    board.w = size; board.h = size; board.x = (w - size)/2; board.y = (h - size)/2;
  }

  function loadImage(key){ return new Promise((res, rej)=>{ const im = new Image(); im.onload = ()=> res(im); im.onerror = ()=> rej(new Error("Fail")); im.src = IMAGES[key].file; }); }
  function setDifficulty(n){ gridN = n; btn2.classList.toggle("on", n === 2); btn3.classList.toggle("on", n === 3); if (img) startPuzzle(currentKey); }

  function makePieces(){
    pieces = []; completed = false; const N = gridN, pw = board.w / N, ph = board.h / N, iw = img.naturalWidth, ih = img.naturalHeight;
    for (let r=0;r<N;r++) for (let c=0;c<N;c++) pieces.push({ r, c, sx: (c / N) * iw, sy: (r / N) * ih, sw: iw / N, sh: ih / N, tx: board.x + c*pw, ty: board.y + r*ph, x: 0, y: 0, w: pw, h: ph, placed: false });
  }

  function shufflePieces(){
    const rect = cv.getBoundingClientRect(), margin = 16;
    const spawnZones = [ {x: margin, y: margin, w: rect.width - margin*2, h: board.y - margin*2}, {x: margin, y: board.y + board.h + margin, w: rect.width - margin*2, h: rect.height - (board.y + board.h) - margin*2}, {x: margin, y: board.y + margin, w: board.x - margin*2, h: board.h - margin*2}, {x: board.x + board.w + margin, y: board.y + margin, w: rect.width - (board.x + board.w) - margin*2, h: board.h - margin*2} ].filter(z => z.w > 60 && z.h > 60);
    pieces.forEach(p=>{ p.placed = false; const z = spawnZones.length ? spawnZones[Math.floor(Math.random()*spawnZones.length)] : {x: margin, y: margin, w: rect.width - margin*2, h: rect.height - margin*2}; p.x = z.x + Math.random() * Math.max(1,(z.w - p.w)); p.y = z.y + Math.random() * Math.max(1,(z.h - p.h)); });
    pieces.sort(()=> Math.random() - 0.5);
  }

  function draw(){
    const rect = cv.getBoundingClientRect(); ctx2d
