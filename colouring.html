<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>Magic Colour Tap: Fixed Edition</title>
  <style>
    :root {
      --rainbow: linear-gradient(45deg, #ff5f6d, #ffc371, #eeff41, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    
    body { 
      margin: 0; padding: 10px; background: #f0f9ff; 
      font-family: 'system-ui', sans-serif;
      display: flex; flex-direction: column; height: 100vh;
      overflow: hidden; /* Stops page bouncing */
    }

    /* THE RAINBOW CONSOLE */
    .toy-shell {
      flex: 1; display: flex; flex-direction: column;
      background: var(--rainbow); background-size: 200% 200%;
      animation: rainbowFlow 8s linear infinite;
      padding: 8px; border-radius: 40px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
      max-width: 1000px; margin: auto; width: 100%;
    }
    @keyframes rainbowFlow { 0% {background-position:0% 50%} 100% {background-position:200% 50%} }

    .main-screen {
      background: white; border-radius: 32px; flex: 1;
      display: flex; flex-direction: column; overflow: hidden; position: relative;
    }

    header {
      padding: 12px 20px; background: #fff; border-bottom: 2px solid #f1f5f9;
      display: flex; justify-content: space-between; align-items: center;
    }
    .brand { font-size: 20px; font-weight: 900; color: #ff00c8; }

    /* VIEWPORT: MOVED UP TO LEAVE ROOM FOR PALETTE */
    .art-frame { flex: 1.5; display: flex; align-items: center; justify-content: center; padding: 10px; }
    svg { height: 100%; width: 100%; max-height: 55vh; }
    
    .p { fill: #fff; stroke: #2d3436; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; transition: fill 0.3s; cursor: pointer; }
    .ink { fill: none; stroke: #b2bec3; stroke-width: 1.5; pointer-events: none; }

    /* THE PALETTE: FIXED HEIGHT & POSITION */
    .palette-container {
      background: #f8fafc; padding: 15px; border-top: 3px solid #f1f5f9;
      height: 140px; /* Locked height so it can't disappear */
      display: flex; flex-direction: column; align-items: center; gap: 10px;
    }
    .swatches {
      display: flex; justify-content: center; gap: 10px; width: 100%; overflow-x: auto; padding-bottom: 5px;
    }
    .swatch {
      min-width: 48px; height: 48px; border-radius: 12px; border: 3px solid white;
      cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex-shrink: 0;
    }
    .swatch.active { transform: scale(1.1); border-color: #2d3436; box-shadow: 0 0 15px rgba(0,0,0,0.2); }

    /* BUTTONS */
    .btn {
      padding: 8px 16px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer;
      background: #eee; font-size: 14px;
    }
    .btn-gal { background: #00b894; color: white; }

    /* OVERLAY */
    #gal { position: absolute; inset: 0; background: white; z-index: 10; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .card { border: 2px solid #eee; border-radius: 20px; padding: 10px; text-align: center; }
    .card svg { height: 80px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="toy-shell">
  <div class="main-screen">
    <header>
      <div class="brand">MAGIC TAP</div>
      <div style="display:flex; gap:8px">
        <button class="btn" onclick="toggleMusic()" id="mu-btn">ðŸŽµ Music</button>
        <button class="btn btn-gal" onclick="openGal()">GALLERY</button>
      </div>
    </header>

    <div id="gal" class="hidden"></div>
    
    <div class="art-frame" id="stage"></div>

    <div class="palette-container">
      <div class="swatches" id="palette"></div>
      <div style="font-size: 12px; color: #636e72; font-weight: bold;">TAP TO PICK A COLOUR</div>
    </div>
  </div>
</div>

<script>
  const COLS = ['#ff7675', '#fab1a0', '#fdcb6e', '#55efc4', '#81ecec', '#74b9ff', '#a29bfe', '#fd79a8', '#636e72', '#ffffff'];
  let pen = COLS[0], aCtx = null, mus = false;

  const SCENES = [
    { name: "Super Dino", svg: `<path class="p" d="M200 500 q200-400 500 0 v50 h-500 z"/><path class="p" d="M200 500 q-150 0-150-180 t150-140 h50"/><circle class="p" cx="150" cy="280" r="15"/><circle class="p" cx="155" cy="275" r="5" fill="#000"/><path class="p" d="M350 350 l-30-60 l30 60"/><path class="p" d="M450 350 l-30-60 l30 60"/><path class="p" d="M600 500 v80"/><path class="ink" d="M250 500 q100 30 250 0"/>`},
    { name: "Magic Kitty", svg: `<circle class="p" cx="400" cy="300" r="180"/><path class="p" d="M280 180 l-50-80 l100 50 z"/><path class="p" d="M520 180 l50-80 l-100 50 z"/><circle class="p" cx="330" cy="280" r="25"/><circle class="p" cx="470" cy="280" r="25"/><path class="p" d="M380 350 q20 30 40 0"/><path class="p" d="M250 350 c-50 0-50 50 0 50"/><path class="p" d="M550 350 c50 0 50 50 0 50"/>`},
    { name: "Castle Joy", svg: `<path class="p" d="M150 500 h500 v-220 h-500 z"/><path class="p" d="M180 280 v-180 h100 v180 z"/><path class="p" d="M520 280 v-180 h100 v180 z"/><path class="p" d="M340 500 v-140 q50-60 100 0 v140 z"/><path class="p" d="M160 100 l70-80 l70 80 z"/><path class="p" d="M500 100 l70-80 l70 80 z"/><circle class="p" cx="700" cy="100" r="40"/>`},
    { name: "Rocket Star", svg: `<path class="p" d="M400 50 c150 0 150 400 150 500 h-300 c0-100 0-500 150-500 z"/><circle class="p" cx="400" cy="220" r="60"/><circle class="p" cx="400" cy="220" r="35"/><path class="p" d="M280 450 l-100 120 h100 z"/><path class="p" d="M520 450 l100 120 h-100 z"/><circle class="p" cx="150" cy="150" r="30"/>`},
    { name: "Ocean Whale", svg: `<path class="p" d="M150 350 c0-150 500-150 500 0 c0 150-500 150-500 0"/><path class="p" d="M600 350 l150-100 v200 z"/><path class="p" d="M300 250 q100-100 200 0"/><circle class="p" cx="250" cy="330" r="20"/><circle class="p" cx="500" cy="150" r="30"/><circle class="p" cx="580" cy="100" r="15"/>`},
    { name: "Fun Robot", svg: `<rect class="p" x="300" y="250" width="200" height="240" rx="30"/><rect class="p" x="330" y="300" width="140" height="100" rx="15"/><rect class="p" x="350" y="120" width="100" height="100" rx="20"/><circle class="p" cx="375" cy="170" r="12"/><circle class="p" cx="425" cy="170" r="12"/><path class="p" d="M220 300 q-50 0-50 50 t50 50 h80"/>`},
  ];

  function init() {
    const pal = document.getElementById('palette');
    COLS.forEach(c => {
      const s = document.createElement('div');
      s.className = 'swatch' + (c === pen ? ' active' : '');
      s.style.backgroundColor = c;
      s.onclick = () => {
        document.querySelectorAll('.swatch').forEach(x => x.classList.remove('active'));
        s.classList.add('active');
        pen = c;
        play(440, 0.05);
      };
      pal.appendChild(s);
    });

    const g = document.getElementById('gal');
    SCENES.forEach((s, i) => {
      const c = document.createElement('div');
      c.className = 'card';
      c.innerHTML = `<svg viewBox="0 0 800 600">${s.svg}</svg><div style="font-weight:bold">${s.name}</div>`;
      c.onclick = () => load(i);
      g.appendChild(c);
    });
    load(0);
  }

  function load(idx) {
    const stage = document.getElementById('stage');
    stage.innerHTML = `<svg viewBox="0 0 800 600">${SCENES[idx].svg}</svg>`;
    document.getElementById('gal').classList.add('hidden');
    stage.querySelectorAll('.p').forEach(p => {
      p.onclick = (e) => {
        e.stopPropagation();
        p.style.fill = pen;
        hiss();
      };
    });
  }

  function openGal() { document.getElementById('gal').classList.toggle('hidden'); }

  function getA() {
    if (!aCtx) aCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (aCtx.state === 'suspended') aCtx.resume();
    return aCtx;
  }

  function play(f, d) {
    const c = getA();
    const o = c.createOscillator();
    const g = c.createGain();
    o.frequency.value = f;
    g.gain.setValueAtTime(0.1, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + d);
    o.connect(g); g.connect(c.destination);
    o.start(); o.stop(c.currentTime + d);
  }

  function hiss() {
    const c = getA();
    const b = c.createBuffer(1, c.sampleRate * 0.1, c.sampleRate);
    const d = b.getChannelData(0);
    for (let i = 0; i < b.length; i++) d[i] = Math.random() * 2 - 1;
    const s = c.createBufferSource();
    s.buffer = b;
    const f = c.createBiquadFilter();
    f.type = 'lowpass'; f.frequency.value = 800;
    const g = c.createGain();
    g.gain.setValueAtTime(0.05, c.currentTime);
    g.gain.linearRampToValueAtTime(0, c.currentTime + 0.1);
    s.connect(f); f.connect(g); g.connect(c.destination);
    s.start();
  }

  function toggleMusic() {
    getA(); mus = !mus;
    document.getElementById('mu-btn').innerText = mus ? "ðŸŽµ ON" : "ðŸŽµ OFF";
    if (mus) loop();
  }

  function loop() {
    if (!mus) return;
    play([261, 329, 392, 523][Math.floor(Math.random()*4)], 1.5);
    setTimeout(loop, 1000);
  }

  init();
</script>
</body>
</html>
