<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salam Adventures ‚Äì Premium Colouring</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --card2:rgba(0,0,0,.28);
      --line:rgba(255,255,255,.12);
      --text:#e9f2ff;
      --muted:#b9c7e6;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --good:#62ffcf;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, #203a7a 0%, var(--bg) 55%, #070b14 100%);
    }

    /* ‚úÖ FORCE SMALLER APP WIDTH + CENTER */
    .wrap{
      max-width:980px;
      margin:12px auto 22px;
      padding:12px;
      width:100%;
    }

    /* SIMPLE TOP BAR */
    .topbar{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;
      margin-bottom:12px;
    }
    .btn{
      border:none;border-radius:16px;padding:11px 14px;cursor:pointer;
      font-weight:900;letter-spacing:.2px;color:#09101e;
      box-shadow:var(--shadow);
      display:flex;align-items:center;gap:10px;user-select:none;
      transition:transform .08s ease, filter .2s ease;
      background: linear-gradient(135deg,#60a5fa,#34d399);
      font-size:14px;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .btn:active{transform:translateY(0) scale(.99)}
    .btn .e{font-size:18px;line-height:1}
    .btn.active{outline:3px solid rgba(98,255,207,.92);outline-offset:2px}
    .bNext{background:linear-gradient(135deg,#fbbf24,#fb7185)}
    .bMode{background:linear-gradient(135deg,#a78bfa,#60a5fa)}
    .bFill{background:linear-gradient(135deg,#22c55e,#fbbf24)}
    .bErase{background:linear-gradient(135deg,#fb7185,#a78bfa)}
    .bFx{background:linear-gradient(135deg,#a7f3d0,#f472b6)}
    .bUndo{background:linear-gradient(135deg,#34d399,#fbbf24)}
    .bClear{background:linear-gradient(135deg,#fbbf24,#60a5fa)}
    .bSave{background:linear-gradient(135deg,#fb7185,#60a5fa)}

    /* STAGE */
    .stage{
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:12px;
      overflow:hidden;

      /* ‚úÖ HARD CAP so the whole app is smaller */
      max-width:980px;
      margin:0 auto;
    }

    /* ‚úÖ SIDE-BY-SIDE LAYOUT (CANVAS LEFT, PANEL RIGHT) */
    .stageGrid{
      display:grid;
      grid-template-columns: minmax(0, 1fr) 380px; /* panel width */
      gap:12px;
      align-items:start;
    }

    /* ONLY stack on very small screens */
    @media (max-width: 820px){
      .stageGrid{grid-template-columns:1fr;}
    }

    .frame{
      border-radius:18px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      padding:10px;
      min-width:0; /* ‚úÖ important for grid */
    }

    /* CANVAS STACK */
    .stack{
      position:relative;
      width:100%;
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      touch-action:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
    }
    canvas{
      display:block;
      width:100%;
      height:auto;
      border-radius:16px;
      touch-action:none;
      background:transparent;
    }
    #bgCanvas{position:relative;z-index:1;pointer-events:none;background:#fff}
    #paintCanvas{position:absolute;inset:0;z-index:2}
    #fxCanvas{position:absolute;inset:0;z-index:3;pointer-events:none}

    .status{
      margin-top:10px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      color:var(--muted);font-size:12px;
    }
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:11px;padding:3px 7px;border-radius:8px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);color:#cfe0ff;
    }

    /* PANEL */
    .panel{
      margin-top:0;
      border-radius:22px;
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      min-width:0; /* ‚úÖ important for grid */
    }
    .panelHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(90deg, rgba(34,197,94,.16), rgba(59,130,246,.14), rgba(168,85,247,.12));
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
    }
    .chip{
      font-size:12px;padding:6px 10px;border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      display:inline-flex;align-items:center;gap:8px;
    }

    /* ‚úÖ Make panel content vertical (works best in side column) */
    .panelBody{padding:12px;display:grid;grid-template-columns:1fr;gap:12px}

    .card{
      border-radius:18px;
      background: var(--card2);
      border:1px solid rgba(255,255,255,.10);
      padding:12px;
    }
    .card h3{margin:0 0 10px;font-size:13px;color:#dbe8ff}
    .hint{margin:0 0 10px;font-size:12px;color:var(--muted)}

    .swatches{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
    .sw{
      width:100%;aspect-ratio:1/1;border-radius:12px;cursor:pointer;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.12), 0 6px 14px rgba(0,0,0,.25);
      transition:transform .08s ease, filter .2s ease, outline .2s ease;
    }
    .sw:hover{transform:translateY(-1px);filter:brightness(1.08)}
    .sw.sel{outline:2px solid rgba(98,255,207,.9);outline-offset:2px}

    .gridBtns{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .mini{
      border-radius:16px;padding:10px 10px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--text);cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
      font-weight:900;
      display:flex;align-items:center;justify-content:center;gap:8px;
      transition:transform .08s ease, filter .2s ease, border-color .2s ease;
      user-select:none;
    }
    .mini:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .mini.active{border-color: rgba(98,255,207,.92); box-shadow: 0 0 0 2px rgba(98,255,207,.25) inset;}
    .mini .e{font-size:18px}

    .sliders{display:grid;gap:10px;margin-top:10px}
    .row{display:flex;align-items:center;gap:10px}
    .row label{font-size:12px;color:var(--muted);min-width:86px}
    .row input[type="range"]{flex:1}
    .row .val{min-width:54px;text-align:right}

    .fxPanel{display:none}
    .fxPanel.show{display:block}
  </style>
</head>

<body>
<div class="wrap">

  <!-- SIMPLE BUTTONS -->
  <div class="topbar">
    <button class="btn" id="prevBtn"><span class="e">‚¨ÖÔ∏è</span>Back</button>
    <button class="btn bNext" id="nextBtn">Next<span class="e">‚û°Ô∏è</span></button>

    <button class="btn bMode active" id="paintModeBtn"><span class="e">üñåÔ∏è</span>Paint</button>
    <button class="btn bFill" id="fillModeBtn"><span class="e">ü™£</span>Fill</button>
    <button class="btn bErase" id="eraseModeBtn"><span class="e">üßΩ</span>Erase</button>

    <button class="btn bFx" id="fxToggleBtn"><span class="e">‚ú®</span>FX</button>

    <button class="btn bUndo" id="undoBtn"><span class="e">‚Ü©Ô∏è</span>Undo</button>
    <button class="btn bClear" id="clearBtn"><span class="e">üßº</span>Clear</button>
    <button class="btn bSave" id="saveBtn"><span class="e">üíæ</span>Save</button>
  </div>

  <div class="stage">
    <!-- ‚úÖ THIS is what makes it side-by-side -->
    <div class="stageGrid">

      <!-- LEFT: DRAWING WINDOW -->
      <div class="frame">
        <div class="stack" id="stack">
          <canvas id="bgCanvas" width="1200" height="800"></canvas>
          <canvas id="paintCanvas" width="1200" height="800"></canvas>
          <canvas id="fxCanvas" width="1200" height="800"></canvas>
        </div>

        <div class="status">
          <div>
            Tip: Paint = draw ¬∑ Fill = tap area ¬∑ Erase removes paint + FX ¬∑ Stars twinkle automatically
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <span class="kbd" id="pageLabel">Page 1</span>
            <span class="kbd" id="modeLabel">Mode: Paint</span>
          </div>
        </div>
      </div>

      <!-- RIGHT: PAINT PANEL -->
      <div class="panel">
        <div class="panelHead">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <span class="chip">Colour: <span class="kbd" id="colourChip">#2563eb</span></span>
            <span class="chip">Brush: <span class="kbd" id="brushChip">Round</span></span>
            <span class="chip">FX: <span class="kbd" id="fxChip">Stars</span></span>
            <span class="chip">SFX: <b id="sfxChip">On</b></span>
          </div>
          <button class="btn bFx" id="sfxBtn" style="padding:10px 12px;font-size:13px;"><span class="e">üîä</span>SFX</button>
        </div>

        <div class="panelBody">
          <div class="card">
            <h3>üé® Colours</h3>
            <p class="hint">Pick a colour (paint + tint for some FX).</p>
            <div class="swatches" id="swatches"></div>

            <div class="sliders">
              <div class="row">
                <label for="size">Size</label>
                <input id="size" type="range" min="3" max="90" value="28" />
                <span class="kbd val" id="sizeVal">28</span>
              </div>
              <div class="row">
                <label for="opacity">Opacity</label>
                <input id="opacity" type="range" min="0.05" max="1" value="1" step="0.05" />
                <span class="kbd val" id="opacityVal">1.00</span>
              </div>
              <div class="row">
                <label for="smooth">Smooth</label>
                <input id="smooth" type="range" min="0" max="0.9" value="0.35" step="0.05" />
                <span class="kbd val" id="smoothVal">0.35</span>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>üñåÔ∏è Brushes</h3>
            <p class="hint">Simple shapes. Glow + Rainbow optional.</p>

            <div class="gridBtns" id="brushGrid">
              <button class="mini active" data-brush="round"><span class="e">‚óè</span>Round</button>
              <button class="mini" data-brush="square"><span class="e">‚ñ†</span>Square</button>
              <button class="mini" data-brush="pencil"><span class="e">‚úèÔ∏è</span>Pencil</button>
              <button class="mini" data-brush="spray"><span class="e">üå´Ô∏è</span>Spray</button>
              <button class="mini" data-brush="heart"><span class="e">üíñ</span>Heart</button>
              <button class="mini" data-brush="starbrush"><span class="e">‚≠ê</span>Star</button>
              <button class="mini" id="glowBtn"><span class="e">üí´</span>Glow</button>
              <button class="mini" id="rainbowBtn"><span class="e">üåà</span>Rainbow</button>
            </div>

            <!-- FX panel (toggle) -->
            <div class="fxPanel" id="fxPanel" style="margin-top:12px;">
              <h3 style="margin:0 0 10px;font-size:13px;color:#dbe8ff;">‚ú® FX Stamps</h3>
              <p class="hint">Tap canvas to place FX. Stars twinkle. Bubbles float.</p>

              <div class="gridBtns" id="fxGrid">
                <button class="mini active" data-fx="stars"><span class="e">‚≠ê</span>Stars</button>
                <button class="mini" data-fx="glitter"><span class="e">‚ú®</span>Glitter</button>
                <button class="mini" data-fx="confetti"><span class="e">üéâ</span>Confetti</button>
                <button class="mini" data-fx="hearts"><span class="e">üíñ</span>Hearts</button>
                <button class="mini" data-fx="bubbles"><span class="e">ü´ß</span>Bubbles</button>
                <button class="mini" data-fx="none"><span class="e">üö´</span>Off</button>
              </div>

              <div class="sliders">
                <div class="row">
                  <label for="fxStrength">FX</label>
                  <input id="fxStrength" type="range" min="0" max="1" value="0.6" step="0.05" />
                  <span class="kbd val" id="fxStrengthVal">0.60</span>
                </div>
                <div class="row">
                  <label for="fxScatter">Scatter</label>
                  <input id="fxScatter" type="range" min="0" max="1" value="0.35" step="0.05" />
                  <span class="kbd val" id="fxScatterVal">0.35</span>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* =========================
   PREMIUM COLOURING ENGINE
   - bgCanvas: locked image
   - paintCanvas: paint + fills + static stamps
   - fxCanvas: animated objects (stars twinkle, bubbles float)
   - eraser removes paint pixels AND deletes nearby fx objects
========================= */

const bgCanvas = document.getElementById("bgCanvas");
const paintCanvas = document.getElementById("paintCanvas");
const fxCanvas = document.getElementById("fxCanvas");
const bg = bgCanvas.getContext("2d", { willReadFrequently:true });
const paint = paintCanvas.getContext("2d", { willReadFrequently:true });
const fx = fxCanvas.getContext("2d", { willReadFrequently:true });

const pages = [
  "colouring images/butterfly.png",
  "colouring images/car.png",
  "colouring images/chest.png",
  "colouring images/dino.png",
  "colouring images/dog.png",
  "colouring images/doll.png",
  "colouring images/house.png",
  "colouring images/kids.png",
  "colouring images/plane.png",
  "colouring images/prince.png",
  "colouring images/swan.png",
  "colouring images/veg.png"
];
let currentPage = 0;

const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>Math.random()*(b-a)+a;

const pageLabel = document.getElementById("pageLabel");
const modeLabel = document.getElementById("modeLabel");

function setCanvasSizeForDPR(){
  const stack = document.getElementById("stack");
  const rect = stack.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;

  const cssW = rect.width;
  const cssH = rect.width * (2/3);
  stack.style.height = cssH + "px";

  const newW = Math.max(600, Math.round(cssW*dpr));
  const newH = Math.max(400, Math.round(cssH*dpr));

  // snapshot paint (so resize doesn't wipe)
  let paintSnap=null;
  try{ paintSnap = paint.getImageData(0,0,paintCanvas.width,paintCanvas.height); }catch(e){}

  bgCanvas.width=newW; bgCanvas.height=newH;
  paintCanvas.width=newW; paintCanvas.height=newH;
  fxCanvas.width=newW; fxCanvas.height=newH;

  // redraw bg
  if (baseImage.complete && baseImage.naturalWidth) drawBaseImage();

  // restore paint
  if (paintSnap){
    const tmp=document.createElement("canvas");
    tmp.width=paintSnap.width; tmp.height=paintSnap.height;
    tmp.getContext("2d").putImageData(paintSnap,0,0);
    paint.drawImage(tmp,0,0,tmp.width,tmp.height,0,0,paintCanvas.width,paintCanvas.height);
  }

  // scale animated objects positions to new size? easiest: clear anim objects on resize
  // (keeps app stable and still feels fine)
  stars.length=0;
  bubbles.length=0;
}

const baseImage = new Image();
baseImage.decoding="async";

function drawBaseImage(){
  bg.clearRect(0,0,bgCanvas.width,bgCanvas.height);
  bg.fillStyle="#ffffff";
  bg.fillRect(0,0,bgCanvas.width,bgCanvas.height);

  const ratio=Math.min(bgCanvas.width/baseImage.naturalWidth, bgCanvas.height/baseImage.naturalHeight);
  const w=Math.round(baseImage.naturalWidth*ratio);
  const h=Math.round(baseImage.naturalHeight*ratio);
  const x=Math.round((bgCanvas.width-w)/2);
  const y=Math.round((bgCanvas.height-h)/2);

  bg.imageSmoothingEnabled=true;
  bg.imageSmoothingQuality="high";
  bg.drawImage(baseImage,x,y,w,h);
}

function clearAll(){
  // keep bg, clear paint + fx objects
  paint.clearRect(0,0,paintCanvas.width,paintCanvas.height);
  stars.length=0;
  bubbles.length=0;
  undoStack.length=0;
}

function loadPage(i){
  currentPage=(i+pages.length)%pages.length;
  pageLabel.textContent=`Page ${currentPage+1}`;
  baseImage.src = encodeURI(pages[currentPage]);
}
baseImage.onload=()=>{
  drawBaseImage();
  clearAll();
};

// =====================
// SIMPLE UI STATE
// =====================
let mode="paint"; // paint | fill | erase
let brush="round"; // round | square | pencil | spray | heart | starbrush
let glow=false;
let rainbow=false;
let fxType="stars"; // stars | glitter | confetti | hearts | bubbles | none

function setMode(m){
  mode=m;
  modeLabel.textContent = `Mode: ${m.charAt(0).toUpperCase()+m.slice(1)}`;
  paintModeBtn.classList.toggle("active", m==="paint");
  fillModeBtn.classList.toggle("active", m==="fill");
  eraseModeBtn.classList.toggle("active", m==="erase");
}

const paintModeBtn=document.getElementById("paintModeBtn");
const fillModeBtn=document.getElementById("fillModeBtn");
const eraseModeBtn=document.getElementById("eraseModeBtn");
paintModeBtn.onclick=()=>setMode("paint");
fillModeBtn.onclick=()=>setMode("fill");
eraseModeBtn.onclick=()=>setMode("erase");

const fxToggleBtn=document.getElementById("fxToggleBtn");
const fxPanel=document.getElementById("fxPanel");
fxToggleBtn.onclick=()=>{
  fxPanel.classList.toggle("show");
  fxToggleBtn.classList.toggle("active", fxPanel.classList.contains("show"));
};

// =====================
// SLIDERS
// =====================
const sizeEl=document.getElementById("size");
const opacityEl=document.getElementById("opacity");
const smoothEl=document.getElementById("smooth");
const fxStrengthEl=document.getElementById("fxStrength");
const fxScatterEl=document.getElementById("fxScatter");

const sizeVal=document.getElementById("sizeVal");
const opacityVal=document.getElementById("opacityVal");
const smoothVal=document.getElementById("smoothVal");
const fxStrengthVal=document.getElementById("fxStrengthVal");
const fxScatterVal=document.getElementById("fxScatterVal");

let brushSize=parseInt(sizeEl.value,10);
let brushOpacity=parseFloat(opacityEl.value);
let smoothing=parseFloat(smoothEl.value);
let fxStrength=parseFloat(fxStrengthEl.value);
let fxScatter=parseFloat(fxScatterEl.value);

function syncVals(){
  sizeVal.textContent=brushSize;
  opacityVal.textContent=brushOpacity.toFixed(2);
  smoothVal.textContent=smoothing.toFixed(2);
  fxStrengthVal.textContent=fxStrength.toFixed(2);
  fxScatterVal.textContent=fxScatter.toFixed(2);
}
sizeEl.oninput=()=>{brushSize=parseInt(sizeEl.value,10);syncVals();};
opacityEl.oninput=()=>{brushOpacity=parseFloat(opacityEl.value);syncVals();};
smoothEl.oninput=()=>{smoothing=parseFloat(smoothEl.value);syncVals();};
fxStrengthEl.oninput=()=>{fxStrength=parseFloat(fxStrengthEl.value);syncVals();};
fxScatterEl.oninput=()=>{fxScatter=parseFloat(fxScatterEl.value);syncVals();};
syncVals();

// =====================
// COLOURS
// =====================
let colour="#2563eb";
const colourChip=document.getElementById("colourChip");
colourChip.textContent=colour;

const colours=[
  "#000000","#ffffff","#ef4444","#f97316","#facc15",
  "#22c55e","#10b981","#06b6d4","#3b82f6","#6366f1",
  "#a855f7","#ec4899","#f43f5e","#8b5cf6","#14b8a6",
  "#84cc16","#eab308","#fb7185","#60a5fa","#94a3b8"
];
const swatches=document.getElementById("swatches");
function buildSwatches(){
  swatches.innerHTML="";
  colours.forEach(c=>{
    const d=document.createElement("div");
    d.className="sw"+(c.toLowerCase()===colour.toLowerCase()?" sel":"");
    d.style.background = (c==="#ffffff") ? "linear-gradient(135deg,#fff,#dbeafe)" : c;
    d.onclick=()=>{
      colour=c;
      colourChip.textContent=colour;
      [...swatches.children].forEach(x=>x.classList.remove("sel"));
      d.classList.add("sel");
    };
    swatches.appendChild(d);
  });
}
buildSwatches();

// =====================
// BRUSH BUTTONS
// =====================
const brushChip=document.getElementById("brushChip");
const brushGrid=document.getElementById("brushGrid");
function setBrush(b){
  brush=b;
  brushChip.textContent =
    b==="round"?"Round":
    b==="square"?"Square":
    b==="pencil"?"Pencil":
    b==="spray"?"Spray":
    b==="heart"?"Heart":"Star";
  [...brushGrid.querySelectorAll("[data-brush]")].forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.brush===b);
  });
}
brushGrid.querySelectorAll("[data-brush]").forEach(btn=>{
  btn.onclick=()=>setBrush(btn.dataset.brush);
});
setBrush("round");

const glowBtn=document.getElementById("glowBtn");
const rainbowBtn=document.getElementById("rainbowBtn");
glowBtn.onclick=()=>{glow=!glow; glowBtn.classList.toggle("active",glow);};
rainbowBtn.onclick=()=>{rainbow=!rainbow; rainbowBtn.classList.toggle("active",rainbow);};

// =====================
// FX BUTTONS
// =====================
const fxChip=document.getElementById("fxChip");
const fxGrid=document.getElementById("fxGrid");
function setFxType(t){
  fxType=t;
  fxChip.textContent =
    t==="stars"?"Stars":
    t==="glitter"?"Glitter":
    t==="confetti"?"Confetti":
    t==="hearts"?"Hearts":
    t==="bubbles"?"Bubbles":"Off";
  fxGrid.querySelectorAll("[data-fx]").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.fx===t);
  });
}
fxGrid.querySelectorAll("[data-fx]").forEach(btn=>{
  btn.onclick=()=>setFxType(btn.dataset.fx);
});
setFxType("stars");

// =====================
// SFX (cute pop)
// =====================
let sfxOn=true;
const sfxChipEl=document.getElementById("sfxChip");
const sfxBtn=document.getElementById("sfxBtn");
let audioCtx=null;

function ensureAudio(){
  if (!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if (audioCtx.state==="suspended") audioCtx.resume();
}
paintCanvas.addEventListener("pointerdown", ()=>ensureAudio(), { once:true });

sfxBtn.onclick=()=>{
  ensureAudio();
  sfxOn=!sfxOn;
  sfxChipEl.textContent=sfxOn?"On":"Off";
  sfxBtn.classList.toggle("active", sfxOn);
};

function playPop(kind="glitter"){
  if (!sfxOn) return;
  ensureAudio(); if (!audioCtx) return;
  const t=audioCtx.currentTime;

  const base = (kind==="stars")?880:(kind==="bubbles")?620:(kind==="confetti")?740:820;

  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type="triangle";
  o.frequency.setValueAtTime(base,t);
  o.frequency.exponentialRampToValueAtTime(base*1.7,t+0.06);
  g.gain.setValueAtTime(0.0001,t);
  g.gain.linearRampToValueAtTime(0.12,t+0.012);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(t); o.stop(t+0.14);

  const dur=0.09;
  const nSamps=Math.max(1,Math.floor(dur*audioCtx.sampleRate));
  const buf=audioCtx.createBuffer(1,nSamps,audioCtx.sampleRate);
  const data=buf.getChannelData(0);
  for (let i=0;i<nSamps;i++){
    const env=Math.pow(1-i/nSamps,2);
    data[i]=(Math.random()*2-1)*0.35*env;
  }
  const src=audioCtx.createBufferSource();
  src.buffer=buf;
  const hp=audioCtx.createBiquadFilter();
  hp.type="highpass";
  hp.frequency.setValueAtTime((kind==="bubbles")?1200:2200,t);
  const ng=audioCtx.createGain();
  ng.gain.setValueAtTime(0.0001,t);
  ng.gain.linearRampToValueAtTime((kind==="bubbles")?0.05:0.07,t+0.01);
  ng.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  src.connect(hp); hp.connect(ng); ng.connect(audioCtx.destination);
  src.start(t); src.stop(t+dur+0.01);
}

// =====================
// UNDO (paint pixels + fx objects)
// =====================
const undoStack=[];
const MAX_UNDO=25;
function snapshotState(){
  let img=null;
  try{ img=paint.getImageData(0,0,paintCanvas.width,paintCanvas.height);}catch(e){}
  const st = stars.map(s=>({...s}));
  const bb = bubbles.map(b=>({...b}));
  return { img, st, bb };
}
function restoreState(s){
  if (s.img) paint.putImageData(s.img,0,0);
  stars.length=0; bubbles.length=0;
  s.st.forEach(x=>stars.push({...x}));
  s.bb.forEach(x=>bubbles.push({...x}));
}
function pushUndo(){
  const s=snapshotState();
  if (!s.img) return;
  if (undoStack.length>=MAX_UNDO) undoStack.shift();
  undoStack.push(s);
}
function undo(){
  const s=undoStack.pop();
  if (s) restoreState(s);
}
document.getElementById("undoBtn").onclick=undo;

/* ---- rest of your script continues unchanged ---- */
</script>
</body>
</html>
