<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salam Adventures ‚Äì Premium Colouring</title>
  <style>
    :root{
      --bg:#0b1220;
      --card2:rgba(0,0,0,.28);
      --line:rgba(255,255,255,.12);
      --text:#e9f2ff;
      --muted:#b9c7e6;
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --good:#62ffcf;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, #203a7a 0%, var(--bg) 55%, #070b14 100%);
    }
    .wrap{max-width:1100px;margin:12px auto 22px;padding:12px}

    .btnbar{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;
      margin-top:10px;margin-bottom:10px;
    }
    .btn{
      border:none;border-radius:14px;padding:9px 12px;cursor:pointer;
      font-weight:900;letter-spacing:.2px;color:#09101e;
      box-shadow:var(--shadow);
      display:flex;align-items:center;gap:8px;user-select:none;
      transition:transform .08s ease, filter .2s ease;
      background: linear-gradient(135deg,#60a5fa,#34d399);
      font-size:13px;line-height:1;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .btn:active{transform:translateY(0) scale(.99)}
    .btn .e{font-size:16px;line-height:1}
    .btn.active{outline:3px solid rgba(98,255,207,.92);outline-offset:2px}
    .bNext{background:linear-gradient(135deg,#fbbf24,#fb7185)}
    .bMode{background:linear-gradient(135deg,#a78bfa,#60a5fa)}
    .bFill{background:linear-gradient(135deg,#22c55e,#fbbf24)}
    .bErase{background:linear-gradient(135deg,#fb7185,#a78bfa)}
    .bFx{background:linear-gradient(135deg,#a7f3d0,#f472b6)}
    .bUndo{background:linear-gradient(135deg,#34d399,#fbbf24)}
    .bClear{background:linear-gradient(135deg,#fbbf24,#60a5fa)}
    .bSave{background:linear-gradient(135deg,#fb7185,#60a5fa)}

    .stage{
      border-radius:20px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:10px;
      overflow:hidden;
    }
    .frame{
      border-radius:16px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      padding:9px;
    }

    .stack{
      position:relative;
      width:100%;
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      touch-action:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
    }
    canvas{
      display:block;
      width:100%;
      height:auto;
      border-radius:14px;
      touch-action:none;
      background:transparent;
    }
    #bgCanvas{position:relative;z-index:1;pointer-events:none;background:#fff}
    #paintCanvas{position:absolute;inset:0;z-index:2}
    #fxCanvas{position:absolute;inset:0;z-index:3;pointer-events:none}

    .status{
      margin-top:8px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      color:var(--muted);font-size:12px;
    }
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:11px;padding:3px 7px;border-radius:8px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);color:#cfe0ff;
    }

    .panel{
      margin-top:10px;
      border-radius:20px;
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .panelHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(90deg, rgba(34,197,94,.16), rgba(59,130,246,.14), rgba(168,85,247,.12));
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;
    }
    .chip{
      font-size:12px;padding:6px 10px;border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      display:inline-flex;align-items:center;gap:8px;
    }
    .panelBody{padding:10px;display:grid;grid-template-columns:1.1fr 1fr;gap:10px}
    @media (max-width:860px){.panelBody{grid-template-columns:1fr}}
    .card{
      border-radius:16px;
      background: var(--card2);
      border:1px solid rgba(255,255,255,.10);
      padding:10px;
    }
    .card h3{margin:0 0 8px;font-size:13px;color:#dbe8ff}
    .hint{margin:0 0 8px;font-size:12px;color:var(--muted)}

    .swatches{display:grid;grid-template-columns:repeat(10,1fr);gap:7px}
    .sw{
      width:100%;aspect-ratio:1/1;border-radius:12px;cursor:pointer;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.12), 0 6px 14px rgba(0,0,0,.25);
      transition:transform .08s ease, filter .2s ease, outline .2s ease;
    }
    .sw:hover{transform:translateY(-1px);filter:brightness(1.08)}
    .sw.sel{outline:2px solid rgba(98,255,207,.9);outline-offset:2px}

    .gridBtns{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .mini{
      border-radius:14px;padding:9px 10px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--text);cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
      font-weight:900;
      display:flex;align-items:center;justify-content:center;gap:7px;
      transition:transform .08s ease, filter .2s ease, border-color .2s ease;
      user-select:none;
      font-size:13px;line-height:1;
    }
    .mini:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .mini.active{border-color: rgba(98,255,207,.92); box-shadow: 0 0 0 2px rgba(98,255,207,.25) inset;}
    .mini .e{font-size:16px}

    .sliders{display:grid;gap:8px;margin-top:8px}
    .row{display:flex;align-items:center;gap:10px}
    .row label{font-size:12px;color:var(--muted);min-width:78px}
    .row input[type="range"]{flex:1}
    .row .val{min-width:54px;text-align:right}

    .fxPanel{display:none}
    .fxPanel.show{display:block}
  </style>
</head>

<body>
<div class="wrap">

  <div class="stage">
    <div class="frame">
      <div class="stack" id="stack">
        <canvas id="bgCanvas" width="1200" height="800"></canvas>
        <canvas id="paintCanvas" width="1200" height="800"></canvas>
        <canvas id="fxCanvas" width="1200" height="800"></canvas>
      </div>

      <div class="status">
        <div>Paint = drag ¬∑ Fill = tap ¬∑ FX = tap/drag when FX is ON ¬∑ Erase removes paint + FX</div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <span class="kbd" id="pageLabel">Page 1</span>
          <span class="kbd" id="modeLabel">Mode: Paint</span>
        </div>
      </div>

      <div class="btnbar">
        <button class="btn" id="prevBtn"><span class="e">‚¨ÖÔ∏è</span>Back</button>
        <button class="btn bNext" id="nextBtn">Next<span class="e">‚û°Ô∏è</span></button>

        <button class="btn bMode active" id="paintModeBtn"><span class="e">üñåÔ∏è</span>Paint</button>
        <button class="btn bFill" id="fillModeBtn"><span class="e">ü™£</span>Fill</button>
        <button class="btn bErase" id="eraseModeBtn"><span class="e">üßΩ</span>Erase</button>

        <button class="btn bFx" id="fxToggleBtn"><span class="e">‚ú®</span>FX</button>

        <button class="btn bUndo" id="undoBtn"><span class="e">‚Ü©Ô∏è</span>Undo</button>
        <button class="btn bClear" id="clearBtn"><span class="e">üßº</span>Clear</button>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <span class="chip">Colour: <span class="kbd" id="colourChip">#2563eb</span></span>
          <span class="chip">Brush: <span class="kbd" id="brushChip">Round</span></span>
          <span class="chip">FX: <span class="kbd" id="fxChip">Stars</span></span>
          <span class="chip">SFX: <b id="sfxChip">On</b></span>
          <span class="chip">FX Mode: <b id="fxModeChip">Off</b></span>
        </div>

        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <button class="btn bFx" id="sfxBtn" style="padding:9px 12px;font-size:13px;"><span class="e">üîä</span>SFX</button>
          <button class="btn bSave" id="saveBtn" style="padding:9px 12px;font-size:13px;"><span class="e">üíæ</span>Save</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="card">
          <h3>üé® Colours</h3>
          <p class="hint">Pick a colour (paint + tint for some FX).</p>
          <div class="swatches" id="swatches"></div>

          <div class="sliders">
            <div class="row">
              <label for="size">Size</label>
              <input id="size" type="range" min="3" max="90" value="28" />
              <span class="kbd val" id="sizeVal">28</span>
            </div>
            <div class="row">
              <label for="opacity">Opacity</label>
              <input id="opacity" type="range" min="0.05" max="1" value="1" step="0.05" />
              <span class="kbd val" id="opacityVal">1.00</span>
            </div>
            <div class="row">
              <label for="smooth">Smooth</label>
              <input id="smooth" type="range" min="0" max="0.9" value="0.35" step="0.05" />
              <span class="kbd val" id="smoothVal">0.35</span>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>üñåÔ∏è Brushes</h3>
          <p class="hint">Brush buttons work in Paint mode. FX button turns FX mode ON.</p>

          <div class="gridBtns" id="brushGrid">
            <button class="mini active" data-brush="round"><span class="e">‚óè</span>Round</button>
            <button class="mini" data-brush="square"><span class="e">‚ñ†</span>Square</button>
            <button class="mini" data-brush="pencil"><span class="e">‚úèÔ∏è</span>Pencil</button>
            <button class="mini" data-brush="spray"><span class="e">üå´Ô∏è</span>Spray</button>
            <button class="mini" data-brush="heart"><span class="e">üíñ</span>Heart</button>
            <button class="mini" data-brush="starbrush"><span class="e">‚≠ê</span>Star</button>
            <button class="mini" id="glowBtn"><span class="e">üí´</span>Glow</button>
            <button class="mini" id="rainbowBtn"><span class="e">üåà</span>Rainbow</button>
          </div>

          <div class="fxPanel" id="fxPanel" style="margin-top:10px;">
            <h3 style="margin:0 0 8px;font-size:13px;color:#dbe8ff;">‚ú® FX Stamps</h3>
            <p class="hint">Choose an FX then tap/drag on the picture (while FX mode is ON).</p>

            <div class="gridBtns" id="fxGrid">
              <button class="mini active" data-fx="stars"><span class="e">‚≠ê</span>Stars</button>
              <button class="mini" data-fx="glitter"><span class="e">‚ú®</span>Glitter</button>
              <button class="mini" data-fx="confetti"><span class="e">üéâ</span>Confetti</button>
              <button class="mini" data-fx="hearts"><span class="e">üíñ</span>Hearts</button>
              <button class="mini" data-fx="bubbles"><span class="e">ü´ß</span>Bubbles</button>
              <button class="mini" data-fx="none"><span class="e">üö´</span>Off</button>
            </div>

            <div class="sliders">
              <div class="row">
                <label for="fxStrength">FX</label>
                <input id="fxStrength" type="range" min="0" max="1" value="0.6" step="0.05" />
                <span class="kbd val" id="fxStrengthVal">0.60</span>
              </div>
              <div class="row">
                <label for="fxScatter">Scatter</label>
                <input id="fxScatter" type="range" min="0" max="1" value="0.35" step="0.05" />
                <span class="kbd val" id="fxScatterVal">0.35</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* FIX: FX button + special FX buttons now ALWAYS work
   - FX button toggles "FX MODE" on/off
   - When FX MODE is ON:
       Tap canvas => places selected FX
       Drag canvas => stamps FX along the drag path
   - Paint mode stays normal (drag paints)
*/

const bgCanvas = document.getElementById("bgCanvas");
const paintCanvas = document.getElementById("paintCanvas");
const fxCanvas = document.getElementById("fxCanvas");
const bg = bgCanvas.getContext("2d", { willReadFrequently:true });
const paint = paintCanvas.getContext("2d", { willReadFrequently:true });
const fx = fxCanvas.getContext("2d", { willReadFrequently:true });

const pages = [
  "colouring images/butterfly.png",
  "colouring images/car.png",
  "colouring images/chest.png",
  "colouring images/dino.png",
  "colouring images/dog.png",
  "colouring images/doll.png",
  "colouring images/house.png",
  "colouring images/kids.png",
  "colouring images/plane.png",
  "colouring images/prince.png",
  "colouring images/swan.png",
  "colouring images/veg.png"
];
let currentPage = 0;

const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>Math.random()*(b-a)+a;

const pageLabel = document.getElementById("pageLabel");
const modeLabel = document.getElementById("modeLabel");

function setCanvasSizeForDPR(){
  const stack = document.getElementById("stack");
  const rect = stack.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;

  const cssW = rect.width;
  const cssH = rect.width * 0.55;
  stack.style.height = cssH + "px";

  const newW = Math.max(600, Math.round(cssW*dpr));
  const newH = Math.max(380, Math.round(cssH*dpr));

  let paintSnap=null;
  try{ paintSnap = paint.getImageData(0,0,paintCanvas.width,paintCanvas.height); }catch(e){}

  bgCanvas.width=newW; bgCanvas.height=newH;
  paintCanvas.width=newW; paintCanvas.height=newH;
  fxCanvas.width=newW; fxCanvas.height=newH;

  if (baseImage.complete && baseImage.naturalWidth) drawBaseImage();

  if (paintSnap){
    const tmp=document.createElement("canvas");
    tmp.width=paintSnap.width; tmp.height=paintSnap.height;
    tmp.getContext("2d").putImageData(paintSnap,0,0);
    paint.drawImage(tmp,0,0,tmp.width,tmp.height,0,0,paintCanvas.width,paintCanvas.height);
  }

  stars.length=0;
  bubbles.length=0;
}

const baseImage = new Image();
baseImage.decoding="async";

function drawBaseImage(){
  bg.clearRect(0,0,bgCanvas.width,bgCanvas.height);
  bg.fillStyle="#ffffff";
  bg.fillRect(0,0,bgCanvas.width,bgCanvas.height);

  const ratio=Math.min(bgCanvas.width/baseImage.naturalWidth, bgCanvas.height/baseImage.naturalHeight);
  const w=Math.round(baseImage.naturalWidth*ratio);
  const h=Math.round(baseImage.naturalHeight*ratio);
  const x=Math.round((bgCanvas.width-w)/2);
  const y=Math.round((bgCanvas.height-h)/2);

  bg.imageSmoothingEnabled=true;
  bg.imageSmoothingQuality="high";
  bg.drawImage(baseImage,x,y,w,h);
}

function clearAll(){
  paint.clearRect(0,0,paintCanvas.width,paintCanvas.height);
  stars.length=0;
  bubbles.length=0;
  undoStack.length=0;
}

function loadPage(i){
  currentPage=(i+pages.length)%pages.length;
  pageLabel.textContent=`Page ${currentPage+1}`;
  baseImage.src = encodeURI(pages[currentPage]);
}
baseImage.onload=()=>{
  drawBaseImage();
  clearAll();
};

/* Modes */
let mode="paint"; // paint | fill | erase
let brush="round";
let glow=false;
let rainbow=false;
let fxType="stars";
let fxMode=false;

const fxModeChip=document.getElementById("fxModeChip");

function setMode(m){
  mode=m;
  modeLabel.textContent = `Mode: ${m.charAt(0).toUpperCase()+m.slice(1)}`;
  paintModeBtn.classList.toggle("active", m==="paint");
  fillModeBtn.classList.toggle("active", m==="fill");
  eraseModeBtn.classList.toggle("active", m==="erase");
  if (m!=="paint") setFxMode(false);
}

function setFxMode(on){
  fxMode=!!on;
  fxModeChip.textContent = fxMode ? "On" : "Off";
  fxToggleBtn.classList.toggle("active", fxMode);
  fxPanel.classList.toggle("show", fxMode);
}

const paintModeBtn=document.getElementById("paintModeBtn");
const fillModeBtn=document.getElementById("fillModeBtn");
const eraseModeBtn=document.getElementById("eraseModeBtn");
paintModeBtn.onclick=()=>setMode("paint");
fillModeBtn.onclick=()=>setMode("fill");
eraseModeBtn.onclick=()=>setMode("erase");

const fxToggleBtn=document.getElementById("fxToggleBtn");
const fxPanel=document.getElementById("fxPanel");
fxToggleBtn.onclick=()=>{
  if (mode!=="paint") setMode("paint");
  setFxMode(!fxMode);
};

/* Sliders */
const sizeEl=document.getElementById("size");
const opacityEl=document.getElementById("opacity");
const smoothEl=document.getElementById("smooth");
const fxStrengthEl=document.getElementById("fxStrength");
const fxScatterEl=document.getElementById("fxScatter");

const sizeVal=document.getElementById("sizeVal");
const opacityVal=document.getElementById("opacityVal");
const smoothVal=document.getElementById("smoothVal");
const fxStrengthVal=document.getElementById("fxStrengthVal");
const fxScatterVal=document.getElementById("fxScatterVal");

let brushSize=parseInt(sizeEl.value,10);
let brushOpacity=parseFloat(opacityEl.value);
let smoothing=parseFloat(smoothEl.value);
let fxStrength=parseFloat(fxStrengthEl.value);
let fxScatter=parseFloat(fxScatterEl.value);

function syncVals(){
  sizeVal.textContent=brushSize;
  opacityVal.textContent=brushOpacity.toFixed(2);
  smoothVal.textContent=smoothing.toFixed(2);
  fxStrengthVal.textContent=fxStrength.toFixed(2);
  fxScatterVal.textContent=fxScatter.toFixed(2);
}
sizeEl.oninput=()=>{brushSize=parseInt(sizeEl.value,10);syncVals();};
opacityEl.oninput=()=>{brushOpacity=parseFloat(opacityEl.value);syncVals();};
smoothEl.oninput=()=>{smoothing=parseFloat(smoothEl.value);syncVals();};
fxStrengthEl.oninput=()=>{fxStrength=parseFloat(fxStrengthEl.value);syncVals();};
fxScatterEl.oninput=()=>{fxScatter=parseFloat(fxScatterEl.value);syncVals();};
syncVals();

/* Colours */
let colour="#2563eb";
const colourChip=document.getElementById("colourChip");
colourChip.textContent=colour;

const colours=[
  "#000000","#ffffff","#ef4444","#f97316","#facc15",
  "#22c55e","#10b981","#06b6d4","#3b82f6","#6366f1",
  "#a855f7","#ec4899","#f43f5e","#8b5cf6","#14b8a6",
  "#84cc16","#eab308","#fb7185","#60a5fa","#94a3b8"
];
const swatches=document.getElementById("swatches");
function buildSwatches(){
  swatches.innerHTML="";
  colours.forEach(c=>{
    const d=document.createElement("div");
    d.className="sw"+(c.toLowerCase()===colour.toLowerCase()?" sel":"");
    d.style.background = (c==="#ffffff") ? "linear-gradient(135deg,#fff,#dbeafe)" : c;
    d.onclick=()=>{
      colour=c;
      colourChip.textContent=colour;
      [...swatches.children].forEach(x=>x.classList.remove("sel"));
      d.classList.add("sel");
    };
    swatches.appendChild(d);
  });
}
buildSwatches();

/* Brush buttons */
const brushChip=document.getElementById("brushChip");
const brushGrid=document.getElementById("brushGrid");
function setBrush(b){
  brush=b;
  brushChip.textContent =
    b==="round"?"Round":
    b==="square"?"Square":
    b==="pencil"?"Pencil":
    b==="spray"?"Spray":
    b==="heart"?"Heart":"Star";
  [...brushGrid.querySelectorAll("[data-brush]")].forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.brush===b);
  });
}
brushGrid.querySelectorAll("[data-brush]").forEach(btn=>{
  btn.onclick=()=>{ setBrush(btn.dataset.brush); setFxMode(false); };
});
setBrush("round");

const glowBtn=document.getElementById("glowBtn");
const rainbowBtn=document.getElementById("rainbowBtn");
glowBtn.onclick=()=>{glow=!glow; glowBtn.classList.toggle("active",glow); setFxMode(false);};
rainbowBtn.onclick=()=>{rainbow=!rainbow; rainbowBtn.classList.toggle("active",rainbow); setFxMode(false);};

/* FX buttons */
const fxChip=document.getElementById("fxChip");
const fxGrid=document.getElementById("fxGrid");
function setFxType(t){
  fxType=t;
  fxChip.textContent =
    t==="stars"?"Stars":
    t==="glitter"?"Glitter":
    t==="confetti"?"Confetti":
    t==="hearts"?"Hearts":
    t==="bubbles"?"Bubbles":"Off";
  fxGrid.querySelectorAll("[data-fx]").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.fx===t);
  });
}
fxGrid.querySelectorAll("[data-fx]").forEach(btn=>{
  btn.onclick=()=>{ setFxType(btn.dataset.fx); if (btn.dataset.fx==="none") setFxMode(false); else setFxMode(true); };
});
setFxType("stars");

/* SFX */
let sfxOn=true;
const sfxChipEl=document.getElementById("sfxChip");
const sfxBtn=document.getElementById("sfxBtn");
let audioCtx=null;

function ensureAudio(){
  if (!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if (audioCtx.state==="suspended") audioCtx.resume();
}
paintCanvas.addEventListener("pointerdown", ()=>ensureAudio(), { once:true });

sfxBtn.onclick=()=>{
  ensureAudio();
  sfxOn=!sfxOn;
  sfxChipEl.textContent=sfxOn?"On":"Off";
  sfxBtn.classList.toggle("active", sfxOn);
};

function playPop(kind="glitter"){
  if (!sfxOn) return;
  ensureAudio(); if (!audioCtx) return;
  const t=audioCtx.currentTime;
  const base = (kind==="stars")?880:(kind==="bubbles")?620:(kind==="confetti")?740:820;

  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type="triangle";
  o.frequency.setValueAtTime(base,t);
  o.frequency.exponentialRampToValueAtTime(base*1.7,t+0.06);
  g.gain.setValueAtTime(0.0001,t);
  g.gain.linearRampToValueAtTime(0.12,t+0.012);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(t); o.stop(t+0.14);
}

/* Undo */
const undoStack=[];
const MAX_UNDO=25;
function snapshotState(){
  let img=null;
  try{ img=paint.getImageData(0,0,paintCanvas.width,paintCanvas.height);}catch(e){}
  const st = stars.map(s=>({...s}));
  const bb = bubbles.map(b=>({...b}));
  return { img, st, bb };
}
function restoreState(s){
  if (s.img) paint.putImageData(s.img,0,0);
  stars.length=0; bubbles.length=0;
  s.st.forEach(x=>stars.push({...x}));
  s.bb.forEach(x=>bubbles.push({...x}));
}
function pushUndo(){
  const s=snapshotState();
  if (!s.img) return;
  if (undoStack.length>=MAX_UNDO) undoStack.shift();
  undoStack.push(s);
}
function undo(){
  const s=undoStack.pop();
  if (s) restoreState(s);
}

/* Fill (unchanged) */
function hexToRgb(hex){
  const v=parseInt(hex.replace("#",""),16);
  return [(v>>16)&255,(v>>8)&255,v&255];
}
function luminance(r,g,b){ return 0.2126*r + 0.7152*g + 0.0722*b; }
function closeCol(r,g,b, tr,tg,tb, tol){
  return Math.abs(r-tr)<=tol && Math.abs(g-tg)<=tol && Math.abs(b-tb)<=tol;
}
function fillFromBG(x,y, fillHex){
  const w=bgCanvas.width,h=bgCanvas.height;
  if (x<0||y<0||x>=w||y>=h) return;

  const bgImg=bg.getImageData(0,0,w,h);
  const bd=bgImg.data;

  const i0=(y*w+x)*4;
  const tr=bd[i0], tg=bd[i0+1], tb=bd[i0+2], ta=bd[i0+3];
  if (ta===0) return;
  if (luminance(tr,tg,tb)<55) return;

  const [fr,fgc,fbc]=hexToRgb(fillHex);

  const paintImg=paint.getImageData(0,0,w,h);
  const pd=paintImg.data;

  const tol=30;
  const stack=[[x,y]];
  const seen=new Uint8Array(w*h);
  const MAX=w*h*0.6;
  let filled=0;

  while(stack.length){
    const [px,py]=stack.pop();
    if (px<0||py<0||px>=w||py>=h) continue;
    const idx=py*w+px;
    if (seen[idx]) continue;
    seen[idx]=1;

    const bi=idx*4;
    const r=bd[bi], g=bd[bi+1], b=bd[bi+2], a=bd[bi+3];
    if (a===0) continue;
    if (luminance(r,g,b)<55) continue;
    if (!closeCol(r,g,b,tr,tg,tb,tol)) continue;

    pd[bi]=fr; pd[bi+1]=fgc; pd[bi+2]=fbc; pd[bi+3]=255;
    filled++; if (filled>MAX) break;

    stack.push([px-1,py],[px+1,py],[px,py-1],[px,py+1]);
  }
  paint.putImageData(paintImg,0,0);
}

/* Draw helpers */
function hsvToRgb(h,s,v){
  const c=v*s, x=c*(1-Math.abs((h/60)%2-1)), m=v-c;
  let r=0,g=0,b=0;
  if (h<60){r=c;g=x;}
  else if (h<120){r=x;g=c;}
  else if (h<180){g=c;b=x;}
  else if (h<240){g=x;b=c;}
  else if (h<300){r=x;b=c;}
  else {r=c;b=x;}
  return [Math.round((r+m)*255),Math.round((g+m)*255),Math.round((b+m)*255)];
}
function rgbToHex(r,g,b){
  return "#"+[r,g,b].map(n=>n.toString(16).padStart(2,"0")).join("");
}
function rainbowColor(){
  const hue=(Date.now()/14)%360;
  const [r,g,b]=hsvToRgb(hue,0.8,1);
  return rgbToHex(r,g,b);
}
function drawHeart(ctx,x,y,size,fill){
  ctx.save();
  ctx.translate(x,y);
  ctx.scale(size/20,size/20);
  ctx.beginPath();
  ctx.moveTo(0,6);
  ctx.bezierCurveTo(0,-2,-10,-2,-10,6);
  ctx.bezierCurveTo(-10,12,-4,16,0,20);
  ctx.bezierCurveTo(4,16,10,12,10,6);
  ctx.bezierCurveTo(10,-2,0,-2,0,6);
  ctx.closePath();
  ctx.fillStyle=fill;
  ctx.fill();
  ctx.restore();
}
function drawStar(ctx,x,y,r,fill){
  ctx.save();
  ctx.translate(x,y);
  ctx.beginPath();
  const spikes=5, outer=r, inner=r*0.45;
  let rot=Math.PI/2*3, step=Math.PI/spikes;
  ctx.moveTo(0,-outer);
  for(let i=0;i<spikes;i++){
    ctx.lineTo(Math.cos(rot)*outer,Math.sin(rot)*outer); rot+=step;
    ctx.lineTo(Math.cos(rot)*inner,Math.sin(rot)*inner); rot+=step;
  }
  ctx.closePath();
  ctx.fillStyle=fill;
  ctx.fill();
  ctx.restore();
}
function sprayDot(x,y,r,fill){
  paint.save();
  paint.globalAlpha = brushOpacity * 0.7;
  paint.fillStyle = fill;
  for (let i=0;i<Math.floor(12 + brushSize*0.25);i++){
    const a=Math.random()*Math.PI*2;
    const d=Math.random()*r*2.0;
    const px=x+Math.cos(a)*d;
    const py=y+Math.sin(a)*d;
    const rr=Math.random()*(r*0.22)+0.7;
    paint.beginPath();
    paint.arc(px,py,rr,0,Math.PI*2);
    paint.fill();
  }
  paint.restore();
}
function stampBrush(x,y,baseSize){
  const fill = rainbow ? rainbowColor() : colour;
  const r = baseSize;

  paint.save();
  paint.globalAlpha = brushOpacity;
  paint.globalCompositeOperation = "source-over";
  paint.shadowBlur = glow ? Math.max(6, r*0.9) : 0;
  paint.shadowColor = glow ? fill : "transparent";

  if (brush==="round"){
    paint.fillStyle=fill;
    paint.beginPath(); paint.arc(x,y,r,0,Math.PI*2); paint.fill();
  } else if (brush==="square"){
    paint.fillStyle=fill;
    paint.fillRect(x-r, y-r, r*2, r*2);
  } else if (brush==="pencil"){
    paint.shadowBlur = glow ? Math.max(4,r*0.45):0;
    paint.globalAlpha = clamp(brushOpacity*0.9,0,1);
    paint.fillStyle=fill;
    paint.beginPath(); paint.arc(x,y,Math.max(1.5,r*0.35),0,Math.PI*2); paint.fill();
  } else if (brush==="spray"){
    paint.shadowBlur = 0;
    sprayDot(x,y,r,fill);
  } else if (brush==="heart"){
    paint.shadowBlur = glow ? Math.max(6,r*0.7):0;
    drawHeart(paint,x,y,Math.max(10,r*2.2),fill);
  } else if (brush==="starbrush"){
    paint.shadowBlur = glow ? Math.max(6,r*0.7):0;
    drawStar(paint,x,y,Math.max(8,r*1.5),fill);
  }
  paint.restore();
}
function eraseAt(x,y,r){
  paint.save();
  paint.globalCompositeOperation="destination-out";
  paint.globalAlpha=1;
  paint.beginPath();
  paint.arc(x,y,r,0,Math.PI*2);
  paint.fill();
  paint.restore();

  const rr = r*1.2;
  for (let i=stars.length-1;i>=0;i--){
    const s=stars[i];
    if (Math.hypot(s.x-x,s.y-y) < rr + s.size*0.9) stars.splice(i,1);
  }
  for (let i=bubbles.length-1;i>=0;i--){
    const b=bubbles[i];
    if (Math.hypot(b.x-x,b.y-y) < rr + b.r*1.1) bubbles.splice(i,1);
  }
}

/* Pointer pos */
function getPos(e){
  const rect=paintCanvas.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  return { x:(e.clientX-rect.left)*dpr, y:(e.clientY-rect.top)*dpr };
}

/* FX objects */
const stars=[];
const bubbles=[];

/* FX placement */
function placeFX(x,y){
  if (fxType==="none") return;

  const base = brushSize * 0.55;
  const strength = fxStrength;
  const scat = fxScatter;
  const tint = (colour==="#ffffff") ? "#fde68a" : colour;

  if (fxType==="stars"){
    const sSize = base*(0.9+strength*1.3);
    stars.push({ x,y, size:sSize, color:tint, phase:Math.random()*Math.PI*2, tw: 0.6 + strength*0.9 });
    const extras = Math.floor(2 + strength*5);
    for (let i=0;i<extras;i++){
      stars.push({
        x: x + rand(-sSize*1.2, sSize*1.2)*(0.35+scat),
        y: y + rand(-sSize*1.2, sSize*1.2)*(0.35+scat),
        size: rand(3,7)*(0.9+strength),
        color: ["#ffffff","#fde68a","#93c5fd","#f9a8d4"][i%4],
        phase:Math.random()*Math.PI*2,
        tw: 0.9 + strength*1.2
      });
    }
    playPop("stars");
    return;
  }

  if (fxType==="bubbles"){
    const count = Math.floor(2 + strength*5);
    for (let i=0;i<count;i++){
      const r = rand(base*0.35, base*0.9)*(0.8+strength);
      bubbles.push({
        x: x + rand(-base*1.3, base*1.3)*(0.35+scat),
        y: y + rand(-base*0.6, base*0.6)*(0.35+scat),
        r, vy: rand(0.35, 0.9) + strength*0.75,
        life: 0, max: rand(1200, 2000),
        drift: rand(-0.18,0.18)
      });
    }
    playPop("bubbles");
    return;
  }

  // stamp-only FX to paint layer
  if (fxType==="glitter"){
    const count = Math.floor(18 + strength*65);
    paint.save();
    for (let i=0;i<count;i++){
      const gx = x + rand(-base*2.2, base*2.2)*(0.35+scat);
      const gy = y + rand(-base*2.2, base*2.2)*(0.35+scat);
      const gr = rand(0.9, 3.8)*(0.7+strength);
      const c = (i%3===0) ? "#ffffff" : (i%3===1 ? "#fde68a" : "#a7f3d0");
      paint.globalAlpha = 0.20 + strength*0.60;
      paint.fillStyle=c;
      paint.beginPath(); paint.arc(gx,gy,gr,0,Math.PI*2); paint.fill();
    }
    paint.restore();
    playPop("glitter");
    return;
  }

  if (fxType==="confetti"){
    const pieces = Math.floor(16 + strength*55);
    paint.save();
    for (let i=0;i<pieces;i++){
      const cx = x + rand(-base*2.4, base*2.4)*(0.35+scat);
      const cy = y + rand(-base*2.4, base*2.4)*(0.35+scat);
      const w = rand(2, 9)*(0.8+strength);
      const h = rand(2, 9)*(0.8+strength);
      const hue = (Date.now()/10 + i*37) % 360;
      const [r,g,b]=hsvToRgb(hue,0.85,1);
      paint.globalAlpha = 0.14 + strength*0.50;
      paint.fillStyle = rgbToHex(r,g,b);
      paint.fillRect(cx,cy,w,h);
    }
    paint.restore();
    playPop("confetti");
    return;
  }

  if (fxType==="hearts"){
    const n = Math.floor(3 + strength*8);
    paint.save();
    for (let i=0;i<n;i++){
      const hx = x + rand(-base*1.8, base*1.8)*(0.35+scat);
      const hy = y + rand(-base*1.8, base*1.8)*(0.35+scat);
      const sz = rand(base*0.8, base*1.8)*(0.55+strength);
      paint.globalAlpha = 0.18 + strength*0.55;
      const c = (i%3===0) ? tint : (i%3===1 ? "#fb7185" : "#f9a8d4");
      drawHeart(paint,hx,hy,sz,c);
    }
    paint.restore();
    playPop("glitter");
  }
}

/* INPUT: paint / fill / erase / fxMode */
let drawing=false;
let last=null;
let downPos=null;
let started=false;
let lastFXStamp=null;

const DRAG_START_PX = 6;

paintCanvas.addEventListener("pointerdown",(e)=>{
  const p=getPos(e);
  ensureAudio();

  // Fill (tap)
  if (mode==="fill"){
    pushUndo();
    fillFromBG(Math.floor(p.x),Math.floor(p.y), colour);
    return;
  }

  pushUndo();
  drawing=true;
  started=false;
  downPos=p;
  last=p;
  lastFXStamp=p;
  paintCanvas.setPointerCapture(e.pointerId);

  // erase starts immediately
  if (mode==="erase"){
    eraseAt(p.x,p.y,brushSize*0.55);
    started=true;
    return;
  }

  // FX mode: tap places FX immediately too (feels responsive)
  if (fxMode){
    placeFX(p.x,p.y);
  } else {
    // paint dot
    stampBrush(p.x,p.y,brushSize*0.5);
    started=true;
  }
});

paintCanvas.addEventListener("pointermove",(e)=>{
  if (!drawing || !last) return;
  const p=getPos(e);

  if (!started && downPos){
    if (Math.hypot(p.x-downPos.x,p.y-downPos.y) > DRAG_START_PX) started=true;
  }

  // Erase drag
  if (mode==="erase"){
    const dx=p.x-last.x, dy=p.y-last.y;
    const dist=Math.hypot(dx,dy);
    const steps=Math.max(1,Math.floor(dist/2));
    for (let i=0;i<=steps;i++){
      const t=i/steps;
      eraseAt(last.x+dx*t, last.y+dy*t, brushSize*0.55);
    }
    last=p;
    return;
  }

  // FX drag: stamp along path
  if (fxMode){
    const dx=p.x-lastFXStamp.x, dy=p.y-lastFXStamp.y;
    const dist=Math.hypot(dx,dy);
    const gap = Math.max(6, brushSize*0.6);
    if (dist >= gap){
      const steps=Math.floor(dist/gap);
      for (let i=1;i<=steps;i++){
        const t=i/steps;
        placeFX(lastFXStamp.x+dx*t, lastFXStamp.y+dy*t);
      }
      lastFXStamp=p;
    }
    last=p;
    return;
  }

  // Paint drag
  const sx = last.x + (p.x-last.x)*(1 - smoothing);
  const sy = last.y + (p.y-last.y)*(1 - smoothing);
  const sp = {x:sx,y:sy};

  const dx=sp.x-last.x, dy=sp.y-last.y;
  const dist=Math.hypot(dx,dy);
  const steps=Math.max(1,Math.floor(dist/2));

  for (let i=0;i<=steps;i++){
    const t=i/steps;
    stampBrush(last.x+dx*t, last.y+dy*t, brushSize*0.5);
  }
  last=sp;
});

paintCanvas.addEventListener("pointerup",(e)=>{
  drawing=false; last=null; downPos=null; started=false; lastFXStamp=null;
  try{ paintCanvas.releasePointerCapture(e.pointerId); }catch(_){}
});
paintCanvas.addEventListener("pointercancel",()=>{drawing=false; last=null; downPos=null; started=false; lastFXStamp=null;});
paintCanvas.addEventListener("pointerleave",()=>{drawing=false; last=null; downPos=null; started=false; lastFXStamp=null;});

/* Animation */
function drawAnimated(){
  fx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
  const t = Date.now()/1000;

  for (const s of stars){
    const tw = (Math.sin(t*2.6 + s.phase) * 0.5 + 0.5);
    const alpha = 0.22 + tw * (0.22 + s.tw*0.18);
    const glowA = 0.10 + tw*0.25;

    fx.save();
    fx.globalAlpha = alpha;
    fx.shadowColor = s.color;
    fx.shadowBlur = Math.max(6, s.size*0.9) * (0.6 + tw);
    drawStar(fx, s.x, s.y, s.size*(0.92 + tw*0.12), s.color);

    fx.globalAlpha = glowA;
    fx.shadowBlur = 0;
    fx.strokeStyle = "#ffffff";
    fx.lineWidth = 1;
    const rr = s.size*(0.5 + tw*0.35);
    fx.beginPath();
    fx.moveTo(s.x-rr, s.y); fx.lineTo(s.x+rr, s.y);
    fx.moveTo(s.x, s.y-rr); fx.lineTo(s.x, s.y+rr);
    fx.stroke();
    fx.restore();
  }

  for (let i=bubbles.length-1;i>=0;i--){
    const b=bubbles[i];
    b.life += 16.7;
    b.y -= b.vy;
    b.x += b.drift;
    const a = 1 - (b.life / b.max);

    if (a <= 0 || b.y < -b.r*3){
      bubbles.splice(i,1);
      continue;
    }

    fx.save();
    fx.globalAlpha = 0.12 + a*0.22;
    fx.strokeStyle = "rgba(255,255,255,.9)";
    fx.lineWidth = Math.max(1, b.r*0.08);
    fx.shadowColor = "rgba(255,255,255,.6)";
    fx.shadowBlur = b.r*0.6;
    fx.beginPath();
    fx.arc(b.x,b.y,b.r,0,Math.PI*2);
    fx.stroke();

    fx.globalAlpha = 0.10 + a*0.18;
    fx.shadowBlur = 0;
    fx.beginPath();
    fx.arc(b.x-b.r*0.3, b.y-b.r*0.3, b.r*0.25, 0, Math.PI*2);
    fx.stroke();
    fx.restore();
  }

  requestAnimationFrame(drawAnimated);
}
requestAnimationFrame(drawAnimated);

/* Buttons */
document.getElementById("nextBtn").onclick=()=>loadPage(currentPage+1);
document.getElementById("prevBtn").onclick=()=>loadPage(currentPage-1);

document.getElementById("clearBtn").onclick=()=>{
  pushUndo();
  paint.clearRect(0,0,paintCanvas.width,paintCanvas.height);
  stars.length=0;
  bubbles.length=0;
};

document.getElementById("saveBtn").onclick=()=>{
  const out=document.createElement("canvas");
  out.width=bgCanvas.width; out.height=bgCanvas.height;
  const o=out.getContext("2d");
  o.drawImage(bgCanvas,0,0);
  o.drawImage(paintCanvas,0,0);
  o.drawImage(fxCanvas,0,0);
  const link=document.createElement("a");
  link.download="my_colouring.png";
  link.href=out.toDataURL("image/png");
  link.click();
};

document.getElementById("undoBtn").onclick=undo;

window.addEventListener("keydown",(e)=>{
  if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="z"){
    e.preventDefault(); undo();
  }
});

/* Start */
setCanvasSizeForDPR();
loadPage(0);
setMode("paint");
setFxMode(false);
window.addEventListener("resize", ()=>{
  setCanvasSizeForDPR();
  if (baseImage.complete && baseImage.naturalWidth) drawBaseImage();
});
</script>
</body>
</html>
