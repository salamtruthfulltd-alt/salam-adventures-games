<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>Magic Tap: Rainbow Sparkle Edition</title>
  <style>
    :root {
      --rb: linear-gradient(45deg, #ff0000, #ffea00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    
    body { 
      margin: 0; padding: 15px; background: #1e293b; 
      font-family: 'system-ui', sans-serif;
      display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden;
    }

    /* THE FLASHING RAINBOW CASE */
    .toy-shell {
      width: 100%; max-width: 950px; height: 95vh;
      background: var(--rb); background-size: 400% 400%;
      animation: rbMove 8s linear infinite;
      padding: 15px; border-radius: 60px;
      box-shadow: 0 20px 0 #0f172a, 0 40px 60px rgba(0,0,0,0.5);
      display: flex; flex-direction: column; position: relative;
    }
    @keyframes rbMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; transform: scale(1.02); } }

    .screen {
      background: white; border-radius: 45px; flex: 1;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: inset 0 10px 30px rgba(0,0,0,0.3);
      border: 8px solid rgba(255,255,255,0.2);
    }

    .toolbar { 
      padding: 15px 25px; background: #fff; border-bottom: 2px solid #f1f5f9; 
      display: flex; justify-content: space-between; align-items: center; 
    }

    /* ART VIEWPORT */
    .canvas { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; position: relative; }
    svg { width: 100%; height: 100%; max-height: 50vh; }
    .p { fill: #fff; stroke: #1e293b; stroke-width: 3; stroke-linejoin: round; cursor: pointer; transition: 0.2s; }
    
    /* SPARKLE EFFECT */
    .sparkle {
      position: absolute; pointer-events: none;
      width: 15px; height: 15px; background: gold; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      animation: fly 0.6s ease-out forwards;
    }
    @keyframes fly { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(2) translateY(-50px); opacity: 0; } }

    /* RECESSED CONTROL TRAY */
    .tray { background: #f1f5f9; padding: 15px; border-radius: 0 0 45px 45px; display: flex; flex-direction: column; gap: 12px; }
    .swatches { display: flex; gap: 10px; justify-content: center; overflow-x: auto; padding: 5px; }
    .swatch { 
      min-width: 55px; height: 55px; border-radius: 18px; border: 4px solid white; 
      cursor: pointer; box-shadow: 0 6px 0 #cbd5e1; transition: 0.1s;
    }
    .swatch.active { transform: translateY(4px); box-shadow: 0 2px 0 #cbd5e1; border-color: #000; }

    .btn { 
      padding: 12px 20px; border: none; border-radius: 20px; font-weight: 900; 
      cursor: pointer; box-shadow: 0 5px 0 #cbd5e1; font-size: 14px;
    }
    .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #cbd5e1; }
    .btn-blue { background: #3b82f6; color: white; box-shadow: 0 5px 0 #1d4ed8; }

    #gal { position: absolute; inset: 0; background: white; z-index: 100; padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; overflow-y: auto; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="toy-shell" id="body">
  <div class="screen">
    <div class="toolbar">
      <b style="font-size: 22px; color: #1e293b;">STUDIO <span style="color:#3b82f6">ULTRA</span></b>
      <div style="display:flex; gap:10px">
        <button class="btn btn-blue" onclick="openGal()">GALLERY</button>
      </div>
    </div>

    <div id="gal" class="hidden"></div>
    <div class="canvas" id="canvas"></div>

    <div class="tray">
      <div class="swatches" id="pal"></div>
      <div style="display:flex; gap:10px; justify-content: center;">
        <button class="btn" onclick="toggleSparkle()" id="s-btn">âœ¨ SPARKLE: ON</button>
        <button class="btn" onclick="toggleMusic()" id="m-btn">ðŸŽµ MUSIC: OFF</button>
        <button class="btn" onclick="clearArt()">ðŸ§¼ CLEAR</button>
      </div>
    </div>
  </div>
</div>

<script>
  const COLS = ['#FF4B4B', '#FF9F43', '#FECA57', '#1DD1A1', '#48DBFB', '#007AFF', '#5F27CD', '#FF9FF3', '#222f3e', '#FFFFFF'];
  let pen = COLS[0], aCtx = null, mus = false, sparkle = true;

  const SCENES = [
    { name: "Garden Day", svg: `
      <path class="p" d="M0 520 h800 v80 h-800 z"/>
      <path class="p" d="M380 350 v170 h40 v-170 z"/>
      <circle class="p" cx="400" cy="220" r="60"/>
      <path class="p" d="M400 160 q60-80 120 0 t-120 60 q-60-60-120 0 t120-60"/>
      <path class="p" d="M460 220 q80-60 80 60 t-80 60 q-80-60-80-60 t80-60"/>
      <path class="p" d="M400 280 q60 80 120 0 t-120-60 q-60 60-120 0 t120 60"/>
      <circle class="p" cx="120" cy="100" r="45"/>
      <path class="p" d="M600 120 q40-40 80 0 t80 0 v40 h-160 z"/>
    `},
    { name: "Deep Sea", svg: `
      <path class="p" d="M150 350 q150-250 450 0 t-450 200 t450-200 v180 l-180-180 z"/>
      <circle class="p" cx="280" cy="320" r="22"/> <circle class="p" cx="290" cy="315" r="8" fill="#000"/>
      <circle class="p" cx="120" cy="180" r="20"/> <circle class="p" cx="80" cy="100" r="30"/>
      <path class="p" d="M600 450 q30-120 80-120 t30 120 t-80 120 t-30-120"/>
      <path class="p" d="M50 500 q100-50 200 0 v100 h-200 z"/>
    `},
    { name: "Mega Castle", svg: `
      <path class="p" d="M150 550 h500 v-250 h-500 z"/>
      <path class="p" d="M180 300 v-180 h120 v180 z"/> <path class="p" d="M500 300 v-180 h120 v180 z"/>
      <path class="p" d="M170 120 l75-100 l75 100 z"/> <path class="p" d="M490 120 l75-100 l75 100 z"/>
      <path class="p" d="M340 550 v-140 q60-80 120 0 v140 z"/>
      <circle class="p" cx="720" cy="100" r="50"/>
      <rect class="p" x="210" y="350" width="60" height="60" rx="10"/>
    `},
    { name: "Star Rocket", svg: `
      <path class="p" d="M400 30 q150 150 150 500 h-300 q0-350 150-500"/>
      <circle class="p" cx="400" cy="220" r="60"/> <circle class="p" cx="400" cy="220" r="35"/>
      <path class="p" d="M280 480 l-130 130 h130 z"/> <path class="p" d="M520 480 l130 130 h-130 z"/>
      <path class="p" d="M100 80 l25-25 l25 25 l-25 25 z"/>
      <path class="p" d="M700 200 l15-15 l15 15 l-15 15 z"/>
      <path class="p" d="M650 400 l40-40 l40 40 l-40 40 z"/>
      <path class="p" d="M100 450 q50-60 100 0 t100 0 t100 0 h-300 z"/>
    `},
    { name: "Bouncy Bunny", svg: `
      <circle class="p" cx="400" cy="400" r="150"/>
      <path class="p" d="M320 280 q-50-200 40-200 t40 200 z"/> <path class="p" d="M400 280 q50-200 40-200 t-40 200 z"/>
      <circle class="p" cx="350" cy="380" r="15"/> <circle class="p" cx="450" cy="380" r="15"/>
      <path class="p" d="M380 430 q20 30 40 0"/>
      <path class="p" d="M300 550 q-50 50 50 50"/> <path class="p" d="M500 550 q50 50-50 50"/>
    `},
    { name: "Fun Robot", svg: `
      <rect class="p" x="300" y="250" width="200" height="240" rx="30"/>
      <rect class="p" x="330" y="300" width="140" height="100" rx="15"/>
      <rect class="p" x="350" y="100" width="100" height="100" rx="20"/>
      <circle class="p" cx="375" cy="150" r="15"/> <circle class="p" cx="425" cy="150" r="15"/>
      <path class="p" d="M220 300 l-50 100 h50"/> <path class="p" d="M580 300 l50 100 h-50"/>
      <rect class="p" x="330" y="490" width="50" height="80" rx="15"/> <rect class="p" x="420" y="490" width="50" height="80" rx="15"/>
    `}
  ];

  function start() {
    const pal = document.getElementById('pal');
    COLS.forEach(c => {
      const s = document.createElement('div');
      s.className = 'swatch' + (c === pen ? ' active' : '');
      s.style.backgroundColor = c;
      s.onclick = () => {
        document.querySelectorAll('.swatch').forEach(x => x.classList.remove('active'));
        s.classList.add('active');
        pen = c;
        beep(600, 0.05);
      };
      pal.appendChild(s);
    });

    const menu = document.getElementById('gal');
    SCENES.forEach((s, i) => {
      const c = document.createElement('div');
      c.className = "btn"; c.style.height = "160px";
      c.innerHTML = `<svg viewBox="0 0 800 600">${s.svg}</svg><p><b>${s.name}</b></p>`;
      c.onclick = () => load(i);
      menu.appendChild(c);
    });
    load(0);
  }

  function load(idx) {
    const v = document.getElementById('canvas');
    v.innerHTML = `<svg viewBox="0 0 800 600" id="art">${SCENES[idx].svg}</svg>`;
    document.getElementById('gal').classList.add('hidden');
    v.querySelectorAll('.p').forEach(p => {
      p.onclick = (e) => {
        e.stopPropagation();
        p.style.fill = pen;
        if(sparkle) makeSparkle(e.clientX, e.clientY);
        hiss();
        flashCase();
      };
    });
  }

  function flashCase() {
    const b = document.getElementById('body');
    b.style.animation = "flash 0.3s ease-in-out";
    setTimeout(() => b.style.animation = "rbMove 8s linear infinite", 300);
  }

  function makeSparkle(x, y) {
    for(let i=0; i<5; i++) {
      const s = document.createElement('div');
      s.className = 'sparkle';
      s.style.left = (x + (Math.random()-0.5)*100) + 'px';
      s.style.top = (y + (Math.random()-0.5)*100) + 'px';
      document.body.appendChild(s);
      setTimeout(() => s.remove(), 600);
    }
  }

  function openGal() { document.getElementById('gal').classList.remove('hidden'); }
  function clearArt() { document.querySelectorAll('#art .p').forEach(p => p.style.fill = "#fff"); }
  function toggleSparkle() { sparkle = !sparkle; document.getElementById('s-btn').innerText = sparkle ? "âœ¨ SPARKLE: ON" : "âœ¨ SPARKLE: OFF"; }

  function getCtx() {
    if (!aCtx) aCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (aCtx.state === 'suspended') aCtx.resume();
    return aCtx;
  }

  function beep(f, d) {
    const c = getCtx();
    const o = c.createOscillator(); const g = c.createGain();
    o.frequency.value = f; g.gain.setValueAtTime(0.1, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, c.currentTime + d);
    o.connect(g); g.connect(c.destination);
    o.start(); o.stop(c.currentTime + d);
  }

  function hiss() {
    const c = getCtx();
    const b = c.createBuffer(1, c.sampleRate * 0.1, c.sampleRate);
    const d = b.getChannelData(0);
    for (let i = 0; i < b.length; i++) d[i] = Math.random() * 2 - 1;
    const s = c.createBufferSource(); s.buffer = b;
    const f = c.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 1000;
    const g = c.createGain(); g.gain.setValueAtTime(0.05, c.currentTime);
    g.gain.linearRampToValueAtTime(0, c.currentTime + 0.1);
    s.connect(f); f.connect(g); g.connect(c.destination);
    s.start();
  }

  function toggleMusic() {
    getCtx(); mus = !mus;
    document.getElementById('m-btn').innerText = mus ? "ðŸŽµ MUSIC: ON" : "ðŸŽµ MUSIC: OFF";
    if (mus) loop();
  }

  function loop() {
    if (!mus) return;
    beep([329, 392, 440, 523][Math.floor(Math.random()*4)], 1);
    setTimeout(loop, 900);
  }

  start();
</script>
</body>
</html>
