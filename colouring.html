<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Magic Colour Tap Ultra</title>
  <style>
    :root {
      --rainbow: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
      --glass: rgba(255, 255, 255, 0.9);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; padding: 10px; background: #cffafe; 
      font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
      display: flex; justify-content: center; align-items: center; min-height: 100vh;
    }

    /* THE PHYSICAL CONSOLE */
    .toy-frame {
      width: 100%; max-width: 1000px; padding: 20px; border-radius: 60px;
      background: var(--rainbow); background-size: 300% 300%;
      animation: rainbowShift 6s ease infinite;
      box-shadow: 0 30px 60px rgba(0,0,0,0.4), inset 0 4px 10px rgba(255,255,255,0.5);
    }
    @keyframes rainbowShift { 0% {background-position:0% 50%} 50% {background-position:100% 50%} 100% {background-position:0% 50%} }

    .inner-screen {
      background: #f8fafc; border-radius: 45px; overflow: hidden;
      display: flex; flex-direction: column; height: 85vh; border: 15px solid #222;
      box-shadow: inset 0 10px 20px rgba(0,0,0,0.2);
    }

    header {
      padding: 15px 30px; background: #fff; border-bottom: 4px solid #eee;
      display: flex; justify-content: space-between; align-items: center;
    }

    .btn {
      padding: 12px 25px; border-radius: 20px; border: none; font-weight: bold;
      cursor: pointer; transition: 0.2s; font-size: 16px;
      box-shadow: 0 6px 0 #bbb; background: #fff;
    }
    .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #bbb; }
    .btn-blue { background: #00d2ff; color: white; box-shadow: 0 6px 0 #0099cc; }

    /* DRAWING SPACE */
    .viewport { flex: 1; display: flex; align-items: center; justify-content: center; padding: 30px; position: relative; }
    svg { width: 100%; height: 100%; max-width: 800px; }

    /* ART PATHS */
    .p { fill: #fff; stroke: #000; stroke-width: 2.8; stroke-linecap: round; stroke-linejoin: round; transition: fill 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: crosshair; }
    .p:hover { filter: drop-shadow(0 0 8px rgba(0,0,0,0.1)); }
    .det { fill: none; stroke: #000; stroke-width: 1.2; pointer-events: none; opacity: 0.7; }

    /* COLOR TRAY */
    .tray {
      padding: 20px; background: #fff; display: flex; justify-content: center; gap: 12px;
      border-top: 4px solid #eee; flex-wrap: wrap;
    }
    .swatch {
      width: 55px; height: 55px; border-radius: 50%; border: 5px solid white;
      cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.15); transition: 0.3s;
    }
    .swatch.active { transform: scale(1.3) translateY(-10px); border-color: #000; }

    /* GALLERY GRID */
    #gallery {
      position: absolute; inset: 0; background: var(--glass); backdrop-filter: blur(15px);
      z-index: 100; padding: 40px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px; overflow-y: auto;
    }
    .card {
      background: white; border-radius: 30px; padding: 20px; border: 5px solid transparent;
      transition: 0.3s; cursor: pointer; text-align: center;
    }
    .card:hover { border-color: #ff00c8; transform: translateY(-10px); }
    .card svg { height: 150px; margin-bottom: 10px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="toy-frame">
  <div class="inner-screen">
    <header>
      <h2 style="margin:0; color:#333">üé® Magic Colour Tap</h2>
      <div style="display:flex; gap:15px">
        <button class="btn btn-blue" onclick="toggleMusic()" id="m-btn">üéµ Music: Off</button>
        <button class="btn" style="background:#111; color:white; box-shadow:0 6px 0 #000" onclick="openGallery()">üñºÔ∏è Gallery</button>
      </div>
    </header>

    <div id="gallery" class="hidden"></div>
    <div class="viewport" id="canvas"></div>
    <div class="tray" id="palette"></div>
  </div>
</div>

<script>
  const COLORS = ['#FF0000', '#FF9900', '#FFEA00', '#00E676', '#00B0FF', '#7A00FF', '#FF00C8', '#424242', '#FFFFFF'];
  let activeColor = COLORS[0];
  let aCtx = null;
  let isPlaying = false;

  const PAGES = [
    { name: "Magical Castle", svg: `
      <path class="p" d="M100 500 h600 v-150 q0-40-40-40 h-520 q-40 0-40 40 z"/> <path class="p" d="M150 310 v-200 h100 v200 z"/> <path class="p" d="M130 110 l70-90 l70 90 z"/> <path class="p" d="M550 310 v-200 h100 v200 z"/> <path class="p" d="M530 110 l70-90 l70 90 z"/> <path class="p" d="M340 500 v-120 c0-40 120-40 120 0 v120 z"/> <path class="p" d="M370 420 a5 5 0 1 1-1 0"/> <rect class="p" x="180" y="200" width="40" height="50" rx="5"/> <rect class="p" x="580" y="200" width="40" height="50" rx="5"/> <path class="det" d="M100 380 h600 M100 440 h600 M180 225 h40 M580 225 h40"/>
    `},
    { name: "Deep Forest", svg: `
      <path class="p" d="M350 500 c20-300 80-300 100 0 h-100 z"/> <path class="p" d="M220 380 c0-150 360-150 360 0 c0 60-360 60-360 0"/> <path class="p" d="M260 280 c0-120 280-120 280 0 c0 50-280 50-280 0"/> <path class="p" d="M300 190 c0-100 200-100 200 0 c0 40-200 40-200 0"/> <circle class="p" cx="150" cy="480" r="40"/> <circle class="p" cx="350" cy="330" r="15"/> <circle class="p" cx="450" cy="310" r="12"/> <path class="det" d="M385 400 v100 M415 400 v100 M250 370 l20 20 M530 370 l-20 20"/>
    `},
    { name: "Sea Adventure", svg: `
      <path class="p" d="M150 300 c100-250 400-50 400 0 l120-100 v200 l-120-100 c0 50-300 250-400 0 z"/> <circle class="p" cx="450" cy="270" r="18"/> <circle class="p" cx="455" cy="265" r="7" fill="#000"/> <path class="p" d="M250 250 q50-60 100 0"/> <path class="p" d="M250 350 q50 60 100 0"/> <circle class="p" cx="650" cy="100" r="25"/> <circle class="p" cx="700" cy="50" r="15"/> <path class="det" d="M200 300 h150 M210 320 h130 M220 340 h100"/>
    `},
    { name: "Space Explorer", svg: `
      <path class="p" d="M400 50 c120 0 150 250 150 420 h-300 c0-170 30-420 150-420 z"/> <path class="p" d="M280 350 l-80 150 h80 z"/> <path class="p" d="M520 350 l80 150 h-80 z"/> <circle class="p" cx="400" cy="220" r="45"/> <circle class="p" cx="400" cy="220" r="30"/> <path class="p" d="M100 150 a80 80 0 1 1-1 0 z"/> <path class="p" d="M50 150 q100 80 200 0"/> <path class="det" d="M400 50 v50 M320 420 h160 M320 450 h160"/>
    `},
    { name: "Dragon Den", svg: `
      <path class="p" d="M200 450 q150-280 450-50 v120 h-450 z"/> <path class="p" d="M200 450 q-160 0-160-120 t140-100 h30"/> <circle class="p" cx="160" cy="280" r="12"/> <path class="p" d="M350 280 q120-200 220-50 t-50 220"/> <path class="p" d="M400 420 l-30 60 h60 z"/> <path class="det" d="M250 420 q60 20 120 0 t120 0 t120 0"/>
    `},
    { name: "Seaw Forest", svg: `
      <circle class="p" cx="400" cy="180" r="120"/> <path class="p" d="M300 250 l-100 180 h400 l-100-180 z"/> <path class="p" d="M250 430 v120 h300 v-120 z"/> <rect class="p" x="370" y="470" width="60" height="80" rx="5"/> <path class="p" d="M100 100 l30 30 m-30 0 l30-30"/> <path class="det" d="M350 120 l20 20 M450 120 l-20 20 M250 460 h300 M250 500 h300"/>
    `}
  ];

  function init() {
    const pal = document.getElementById('palette');
    COLORS.forEach(c => {
      const s = document.createElement('div');
      s.className = 'swatch' + (c === activeColor ? ' active' : '');
      s.style.background = c;
      s.onclick = () => {
        document.querySelectorAll('.swatch').forEach(el => el.classList.remove('active'));
        s.classList.add('active');
        activeColor = c;
        playNote(440, 'triangle', 0.1);
      };
      pal.appendChild(s);
    });

    const gal = document.getElementById('gallery');
    PAGES.forEach((p, i) => {
      const d = document.createElement('div');
      d.className = 'card';
      d.innerHTML = `<svg viewBox="0 0 800 600">${p.svg}</svg><h3>${p.name}</h3>`;
      d.onclick = () => loadPage(i);
      gal.appendChild(d);
    });
    loadPage(0);
  }

  function loadPage(i) {
    const c = document.getElementById('canvas');
    c.innerHTML = `<svg viewBox="0 0 800 600">${PAGES[i].svg}</svg>`;
    document.getElementById('gallery').classList.add('hidden');
    c.querySelectorAll('.p').forEach(el => {
      el.onclick = (e) => {
        e.stopPropagation();
        el.style.fill = activeColor;
        playBrush();
        playNote(880, 'sine', 0.05); // Tiny chime
      };
    });
  }

  function openGallery() { document.getElementById('gallery').classList.remove('hidden'); }

  // --- AUDIO ENGINE ---
  function getA() {
    if (!aCtx) aCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (aCtx.state === 'suspended') aCtx.resume();
    return aCtx;
  }

  function playNote(f, type, len) {
    const ctx = getA();
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = type; osc.frequency.value = f;
    g.gain.setValueAtTime(0.1, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + len);
    osc.connect(g); g.connect(ctx.destination);
    osc.start(); osc.stop(ctx.currentTime + len);
  }

  function playBrush() {
    const ctx = getA();
    const bSize = ctx.sampleRate * 0.25;
    const buf = ctx.createBuffer(1, bSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bSize; i++) data[i] = Math.random() * 2 - 1;
    const src = ctx.createBufferSource();
    src.buffer = buf;
    const f = ctx.createBiquadFilter();
    f.type = 'lowpass'; f.frequency.value = 600;
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.08, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.2);
    src.connect(f); f.connect(g); g.connect(ctx.destination);
    src.start();
  }

  function toggleMusic() {
    getA();
    isPlaying = !isPlaying;
    document.getElementById('m-btn').innerText = isPlaying ? "üéµ Music: On" : "üéµ Music: Off";
    if (isPlaying) loop();
  }

  function loop() {
    if (!isPlaying) return;
    const ctx = getA();
    const scale = [261.6, 329.6, 392.0, 523.2];
    playNote(scale[Math.floor(Math.random()*scale.length)], 'sine', 0.8);
    setTimeout(loop, 600);
  }

  init();
</script>
</body>
</html>
