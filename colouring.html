<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Magic Colour Tap | Salam Adventures</title>
  <style>
    :root { --rainbow: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000); }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; padding: 15px; background: #80deea; 
      font-family: 'Arial Rounded MT Bold', sans-serif;
      display: flex; justify-content: center; align-items: center; min-height: 100vh;
    }

    .game-box {
      width: 100%; max-width: 950px; padding: 12px; border-radius: 40px;
      background: var(--rainbow); background-size: 400%;
      animation: rainbowMove 8s linear infinite; box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    @keyframes rainbowMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    .inner-screen { background: white; border-radius: 30px; display: flex; flex-direction: column; overflow: hidden; position: relative; height: 85vh; }

    header { padding: 15px 25px; border-bottom: 4px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: #fff; z-index: 5; }
    
    .game-btn {
      padding: 10px 20px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;
      box-shadow: 0 4px 0 #ccc; transition: 0.1s; background: #4CC9FF; color: white;
    }
    .game-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #ccc; }

    .canvas-view { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; background: #fafafa; }
    svg { width: 100%; height: 100%; max-width: 800px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.05)); }
    
    /* Intricate Art Style */
    .p { fill: white; stroke: #111; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; transition: fill 0.3s ease; cursor: pointer; }
    .p:hover { filter: brightness(0.9); }
    .detail { fill: none; stroke: #111; stroke-width: 1.2; pointer-events: none; opacity: 0.8; }

    .palette-tray { padding: 15px; background: #fff; display: flex; justify-content: center; gap: 10px; border-top: 4px solid #f0f0f0; }
    .swatch { width: 45px; height: 45px; border-radius: 50%; border: 3px solid white; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.1); transition: 0.2s; }
    .swatch.active { transform: scale(1.25); border-color: #000; }

    #gallery { position: absolute; inset: 0; background: white; z-index: 100; padding: 25px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; overflow-y: auto; }
    .thumb { border: 3px solid #eee; border-radius: 20px; cursor: pointer; padding: 15px; background: #fff; transition: 0.2s; display: flex; flex-direction: column; align-items: center; }
    .thumb:hover { border-color: #ff00c8; transform: translateY(-5px); }
    .thumb svg { height: 120px; width: 100%; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="game-box">
  <div class="inner-screen">
    <header>
      <h2 style="margin:0; color: #333;">‚ú® Magic Colour Tap</h2>
      <div style="display:flex; gap:10px">
        <button class="game-btn" onclick="toggleMusic()" id="music-btn">üéµ Music: Off</button>
        <button class="game-btn" style="background:#111" onclick="showGallery()">üñºÔ∏è Gallery</button>
      </div>
    </header>

    <div id="gallery" class="hidden"></div>
    <div class="canvas-view" id="canvas"></div>
    <div class="palette-tray" id="palette"></div>
  </div>
</div>

<script>
  const COLORS = ['#FF3D00', '#FFEA00', '#00E676', '#00B0FF', '#D500F9', '#FF4081', '#795548', '#212121', '#FFFFFF'];
  let currentSelection = COLORS[0];
  let audioCtx = null;
  let isMusicPlaying = false;

  const PAGES = [
    { name: "Magical Castle", svg: `
      <path class="p" d="M150 500 h500 v-150 q0-30-30-30 h-440 q-30 0-30 30 z"/>
      <path class="p" d="M200 320 v-120 h80 v120"/> <path class="p" d="M185 200 l55-90 l55 90 z"/>
      <path class="p" d="M520 320 v-120 h80 v120"/> <path class="p" d="M505 200 l55-90 l55 90 z"/>
      <path class="p" d="M350 500 v-100 a50 50 0 0 1 100 0 v 100 z"/>
      <path class="detail" d="M150 380 h500 M150 430 h500 M150 470 h500 M240 220 v80 M560 220 v80"/>
      <rect class="p" x="220" y="350" width="30" height="40" rx="5"/>
      <rect class="p" x="550" y="350" width="30" height="40" rx="5"/>` 
    },
    { name: "Deep Forest", svg: `
      <path class="p" d="M380 500 q20-220 40 0 h-40 z"/>
      <path class="p" d="M280 380 c0-150 240-150 240 0 c0 50-240 50-240 0"/>
      <path class="p" d="M310 280 c0-120 180-120 180 0 c0 40-180 40-180 0"/>
      <path class="p" d="M120 480 q40-60 80 0 v40 h-80 z"/>
      <path class="detail" d="M395 350 v100 M405 320 v120 M140 460 l10 10 M180 460 l10 10"/>
      <circle class="p" cx="350" cy="330" r="10"/><circle class="p" cx="450" cy="350" r="12"/>`
    },
    { name: "Space Explorer", svg: `
      <path class="p" d="M400 80 c80 0 100 200 100 350 h-200 c0-150 20-350 100-350 z"/>
      <path class="p" d="M300 380 l-60 100 h60 z"/> <path class="p" d="M500 380 l60 100 h-60 z"/>
      <circle class="p" cx="400" cy="220" r="35"/>
      <path class="p" d="M650 150 a60 60 0 1 1-1 0 z"/>
      <path class="detail" d="M580 150 h140 M400 80 v40 M400 430 v30"/>
      <circle class="p" cx="630" cy="130" r="10"/><circle class="p" cx="680" cy="170" r="8"/>`
    },
    { name: "Under Sea Adventure", svg: `
      <path class="p" d="M180 300 q150-180 350 0 l100-70 v140 l-100-70 q-200 180-350 0 z"/>
      <circle class="p" cx="480" cy="280" r="12"/>
      <path class="p" d="M100 500 q20-100 50-150 t50 150 z"/>
      <path class="detail" d="M250 280 q50-30 150 0 M250 310 q50-30 150 0 M250 340 q50-30 150 0"/>
      <circle class="p" cx="600" cy="100" r="15"/><circle class="p" cx="650" cy="150" r="10"/>`
    },
    { name: "Dragon's Den", svg: `
      <path class="p" d="M250 450 q150-250 350-50 v100 h-350 z"/>
      <path class="p" d="M250 450 q-130 0-130-110 t110-90 h20"/>
      <path class="p" d="M350 300 q80-150 180-50 t-50 180"/>
      <circle class="p" cx="180" cy="290" r="8"/>
      <path class="detail" d="M300 410 q30 10 60 0 M370 410 q30 10 60 0 M440 410 q30 10 60 0"/>`
    },
    { name: "Robot City", svg: `
      <path class="p" d="M320 220 h160 v200 h-160 z"/>
      <path class="p" d="M350 120 h100 v100 h-100 z"/>
      <path class="p" d="M320 250 l-80 50 v40 l80-50 z"/>
      <path class="p" d="M480 250 l80 50 v40 l-80-50 z"/>
      <circle class="p" cx="375" cy="160" r="10"/><circle class="p" cx="425" cy="160" r="10"/>
      <path class="detail" d="M340 240 h120 M340 280 h120 M340 320 h120"/>`
    }
  ];

  function init() {
    const pal = document.getElementById('palette');
    COLORS.forEach(c => {
      const s = document.createElement('div');
      s.className = 'swatch' + (c === currentSelection ? ' active' : '');
      s.style.background = c;
      s.onclick = () => {
        document.querySelectorAll('.swatch').forEach(sw => sw.classList.remove('active'));
        s.classList.add('active');
        currentSelection = c;
        playPop();
      };
      pal.appendChild(s);
    });

    const gal = document.getElementById('gallery');
    PAGES.forEach((p, i) => {
      const d = document.createElement('div');
      d.className = 'thumb';
      d.innerHTML = `<svg viewBox="0 0 800 600">${p.svg}</svg><p style="margin-top:10px; font-weight:bold;">${p.name}</p>`;
      d.onclick = () => loadPage(i);
      gal.appendChild(d);
    });

    loadPage(0);
  }

  function loadPage(i) {
    const canvas = document.getElementById('canvas');
    canvas.innerHTML = `<svg viewBox="0 0 800 600">${PAGES[i].svg}</svg>`;
    document.getElementById('gallery').classList.add('hidden');
    canvas.querySelectorAll('.p').forEach(el => {
      el.onclick = () => {
        el.style.fill = currentSelection;
        playBrush();
      }
    });
  }

  function showGallery() { document.getElementById('gallery').classList.remove('hidden'); }

  // --- IMPROVED AUDIO ENGINE ---
  function getCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
  }

  function playPop() {
    const ctx = getCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(400, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(); osc.stop(ctx.currentTime + 0.1);
  }

  function playBrush() {
    const ctx = getCtx();
    const bufferSize = ctx.sampleRate * 0.3;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
    
    const noise = ctx.createBufferSource();
    noise.buffer = buffer;
    const filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(1000, ctx.currentTime);
    filter.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.3);
    
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.05);
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
    
    noise.connect(filter); filter.connect(gain); gain.connect(ctx.destination);
    noise.start();
  }

  function toggleMusic() {
    getCtx();
    isMusicPlaying = !isMusicPlaying;
    document.getElementById('music-btn').innerText = isMusicPlaying ? "üéµ Music: On" : "üéµ Music: Off";
    if (isMusicPlaying) playLoop();
  }

  function playLoop() {
    if (!isMusicPlaying) return;
    const ctx = getCtx();
    const now = ctx.currentTime;
    const notes = [261.6, 329.6, 392.0, 523.2];
    const freq = notes[Math.floor(Math.random() * notes.length)];
    
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(freq, now);
    gain.gain.setValueAtTime(0.03, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(now); osc.stop(now + 0.8);
    setTimeout(playLoop, 600);
  }

  init();
</script>
</body>
</html>
