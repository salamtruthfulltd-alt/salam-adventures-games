<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Magic Colour Tap | Salam Adventures</title>
  <style>
    :root{
      --bg1:#fde7ef;
      --bg2:#e6f4ff;
      --ink:#1f2937;
      --muted:#6b7280;
      --panel:#ffffffea;
      --panel2:#ffffffd6;
      --shadow: 0 24px 70px rgba(0,0,0,.14);
      --shadow2: 0 14px 30px rgba(0,0,0,.12);
      --radius: 22px;

      /* Fixed colourful border (NOT spinning) */
      --borderGrad: conic-gradient(
        from 180deg,
        #ff5fa2, #ffcc3a, #58e3ff, #7c5cff, #ff8b3a, #62f5a6, #ff5fa2
      );
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 10% 10%, #ffffffaa 0, transparent 55%),
        radial-gradient(900px 650px at 90% 10%, #ffffffaa 0, transparent 50%),
        linear-gradient(120deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    /* 3D frame with fixed colourful border */
    .frame{
      width:min(1120px, 100%);
      border-radius: calc(var(--radius) + 8px);
      background:
        var(--borderGrad) border-box;
      padding:10px; /* border thickness */
      box-shadow: var(--shadow);
      position:relative;
    }
    /* subtle sparkle dots on the border (static-ish, not rotating) */
    .frame::before{
      content:"";
      position:absolute;
      inset:6px;
      border-radius: calc(var(--radius) + 4px);
      pointer-events:none;
      background:
        radial-gradient(6px 6px at 12% 20%, rgba(255,255,255,.55) 0 55%, transparent 58%),
        radial-gradient(5px 5px at 82% 22%, rgba(255,255,255,.50) 0 55%, transparent 58%),
        radial-gradient(4px 4px at 70% 80%, rgba(255,255,255,.45) 0 55%, transparent 58%),
        radial-gradient(5px 5px at 25% 78%, rgba(255,255,255,.45) 0 55%, transparent 58%);
      mix-blend-mode: screen;
      opacity:.85;
    }

    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
      overflow:hidden;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding:16px 16px 10px;
    }

    .title{
      line-height:1.1;
    }
    .title h1{
      margin:0;
      font-size: clamp(22px, 3.2vw, 34px);
      letter-spacing:-.02em;
    }
    .title p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:14px;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
      user-select:none;
      white-space:nowrap;
    }
    .btn.primary{
      background:#111827;
      color:#fff;
      border-color: transparent;
      box-shadow: 0 14px 26px rgba(17,24,39,.22);
    }
    .btn:active{transform:translateY(1px)}
    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,.18);
    }
    .dot.off{
      background:#9ca3af;
      box-shadow: 0 0 0 4px rgba(156,163,175,.18);
    }

    .main{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:14px;
      padding: 12px 16px 16px;
    }

    /* bigger art board */
    .board{
      border-radius:18px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.08);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
      min-height: 520px;
      display:flex;
      flex-direction:column;
    }

    .boardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90));
    }

    .hint{
      font-weight:800;
      font-size:13px;
      color:#374151;
    }
    .hint small{font-weight:700;color:#6b7280}

    .badge{
      font-weight:900;
      font-size:12px;
      color:#111827;
      background: #f3f4f6;
      border:1px solid rgba(0,0,0,.08);
      padding:8px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .canvasWrap{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
      background:
        radial-gradient(1200px 400px at 10% 10%, rgba(255,92,162,.06), transparent 60%),
        radial-gradient(1000px 400px at 90% 10%, rgba(88,227,255,.07), transparent 55%),
        radial-gradient(900px 460px at 50% 100%, rgba(98,245,166,.06), transparent 58%);
    }

    /* the actual SVG holder */
    .art{
      width: min(760px, 100%);
      aspect-ratio: 4 / 3;
      max-height: 520px;
      border-radius:16px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 18px 32px rgba(0,0,0,.10);
      overflow:hidden;
      position:relative;
    }

    .art svg{
      width:100%;
      height:100%;
      display:block;
      background:#fff;
    }

    /* colouring areas */
    .paint{
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease;
    }
    .paint:hover{
      filter: brightness(1.03);
    }
    .paint:active{
      transform: translateY(0.5px);
    }

    .side{
      border-radius:18px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.08);
      box-shadow: var(--shadow2);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: 520px;
    }

    .panelTitle{
      font-weight:900;
      margin:0;
      font-size:14px;
    }

    .palette{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
      padding:10px;
      background: rgba(17,24,39,.03);
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
    }

    .swatch{
      width:100%;
      aspect-ratio:1/1;
      border-radius:999px;
      border: 3px solid rgba(255,255,255,.9);
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,.12),
        0 10px 18px rgba(0,0,0,.10);
      cursor:pointer;
      position:relative;
    }
    .swatch.selected::after{
      content:"✓";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      color:#111827;
      text-shadow: 0 2px 0 rgba(255,255,255,.65);
    }

    .miniHelp{
      margin:0;
      color:#6b7280;
      font-size:13px;
      line-height:1.35;
    }

    .gallery{
      display:none;
      gap:12px;
      padding:12px;
    }
    .gallery.show{display:grid; grid-template-columns: repeat(3, 1fr);}
    .thumb{
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      box-shadow: 0 14px 26px rgba(0,0,0,.10);
      cursor:pointer;
      transform: translateZ(0);
      transition: transform .12s ease, filter .12s ease;
    }
    .thumb:hover{transform: translateY(-2px)}
    .thumb svg{width:100%; height:100%; display:block}
    .thumbLabel{
      padding:10px 10px 12px;
      font-weight:900;
      font-size:13px;
      color:#111827;
      border-top:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, #fff, #f9fafb);
    }

    .toast{
      position:absolute;
      left:12px; right:12px; bottom:12px;
      background: rgba(17,24,39,.92);
      color:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      font-size:13px;
      opacity:0;
      transform: translateY(8px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
    }
    .toast.show{opacity:1; transform: translateY(0)}

    /* Confetti canvas */
    #fx{
      position:absolute;
      inset:0;
      pointer-events:none;
    }

    @media (max-width: 980px){
      .main{grid-template-columns: 1fr}
      .side{min-height:auto}
      .board{min-height: 480px}
      .art{max-height: 460px}
    }
    @media (max-width: 560px){
      .controls{justify-content:flex-start}
      .gallery.show{grid-template-columns: repeat(2, 1fr);}
      .board{min-height: 420px}
      .art{aspect-ratio: 1 / 1; max-height: 420px}
      .palette{grid-template-columns: repeat(5, 1fr)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame" aria-label="Magic Colour Tap game frame">
      <div class="card">
        <div class="top">
          <div class="title">
            <h1>Magic Colour Tap</h1>
            <p>Choose a picture, pick a colour, then tap to fill. Finish the picture to unlock a sparkle celebration ✨</p>
          </div>

          <div class="controls">
            <button class="btn" id="backBtn" title="Choose another picture">Back to pictures</button>
            <button class="btn" id="resetBtn" title="Clear colours">Reset</button>
            <button class="btn" id="surpriseBtn" title="Random colour fun">Surprise colours</button>

            <div class="toggle" id="musicToggle" role="button" aria-pressed="true" title="Toggle background music">
              <span class="dot" id="musicDot"></span>
              <span id="musicText">Music: On</span>
            </div>
          </div>
        </div>

        <div class="main">
          <div class="board">
            <div class="boardHeader">
              <div class="hint" id="hint">
                Pick a picture, then choose a colour. <small>Tap an area to fill.</small>
              </div>
              <div class="badge" id="progress">0 / 0 filled</div>
            </div>

            <div class="canvasWrap">
              <div class="art" id="art" aria-label="Colouring canvas">
                <!-- Confetti canvas -->
                <canvas id="fx"></canvas>

                <!-- Gallery -->
                <div class="gallery show" id="gallery"></div>

                <!-- SVG will be injected here -->
                <div id="svgHost" style="display:none; width:100%; height:100%;"></div>

                <div class="toast" id="toast">✨ Yay! You finished! ✨</div>
              </div>
            </div>
          </div>

          <div class="side">
            <h3 class="panelTitle">Pick a colour</h3>
            <div class="palette" id="palette"></div>
            <p class="miniHelp">
              Tip: Little fingers work best when you <b>tap the shapes</b>, not the lines.  
              You can change colours anytime. ✨
            </p>
            <p class="miniHelp" style="margin-top:auto;">
              If the game looks “small” inside your website embed, just drag the bottom of the embed box taller.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- Palette ----------
  const COLORS = [
    {name:"Sunshine", hex:"#FFD54A"},
    {name:"Candy Pink", hex:"#FF6FB1"},
    {name:"Sky", hex:"#4CC9FF"},
    {name:"Mint", hex:"#63F5A6"},
    {name:"Lavender", hex:"#8B7CFF"},
    {name:"Orange", hex:"#FF9B3A"},
    {name:"Cherry", hex:"#FF3B4D"},
    {name:"Ocean", hex:"#2D7CFF"},
    {name:"Cocoa", hex:"#8B5E3C"},
    {name:"Cloud", hex:"#E5E7EB"},
    {name:"Night", hex:"#111827"}
  ];

  const paletteEl = document.getElementById("palette");
  let currentColor = COLORS[0].hex;

  function renderPalette(){
    paletteEl.innerHTML = "";
    COLORS.forEach((c, i) => {
      const b = document.createElement("button");
      b.className = "swatch" + (i===0 ? " selected" : "");
      b.style.background = c.hex;
      b.title = c.name;
      b.addEventListener("click", () => {
        currentColor = c.hex;
        [...paletteEl.children].forEach(ch => ch.classList.remove("selected"));
        b.classList.add("selected");
      });
      paletteEl.appendChild(b);
    });
  }

  // ---------- Pictures (Better outlines: thicker stroke + clean shapes) ----------
  // Each picture is a function returning SVG string. Areas to fill: class="paint" and data-fill="id"
  const PICTURES = [
    { id:"garden", label:"Flower Garden", svg: () => svgGarden() },
    { id:"rocket", label:"Rocket Ride", svg: () => svgRocket() },
    { id:"dino", label:"Friendly Dino", svg: () => svgDino() },
    { id:"castle", label:"Fairy Castle", svg: () => svgCastle() },
    { id:"ocean", label:"Ocean Friends", svg: () => svgOcean() },
    { id:"stars", label:"Starry Night", svg: () => svgStars() },
  ];

  function outlineStyle(){
    return `fill="white" stroke="#1f2937" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"`;
  }

  function svgWrap(inner){
    // viewBox 0 0 800 600 (4:3)
    return `
      <svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg" aria-label="Colouring picture">
        <rect x="0" y="0" width="800" height="600" fill="#ffffff"/>
        ${inner}
      </svg>`;
  }

  function svgGarden(){
    return svgWrap(`
      <path d="M0 470 C130 420 210 520 320 470 C430 420 520 520 650 470 C720 445 760 450 800 465 L800 600 L0 600 Z"
        ${outlineStyle()} class="paint" data-fill="hill" />

      ${flower(170,350,80,"f1")}
      ${flower(400,320,105,"f2")}
      ${flower(640,360,86,"f3")}

      <path d="M90 220 C120 180 170 170 200 210 C230 250 210 300 160 308 C110 318 70 270 90 220 Z"
        ${outlineStyle()} class="paint" data-fill="cloud1" />
      <path d="M600 200 C635 170 690 170 720 205 C750 240 730 290 680 298 C625 306 575 255 600 200 Z"
        ${outlineStyle()} class="paint" data-fill="cloud2" />

      <circle cx="690" cy="120" r="62" ${outlineStyle()} class="paint" data-fill="sun" />
      <path d="M690 40 L690 10 M690 230 L690 260 M610 120 L580 120 M800 120 L770 120
               M635 65 L614 44 M745 175 L765 195 M635 175 L614 195 M745 65 L765 44"
            stroke="#1f2937" stroke-width="6" stroke-linecap="round" />
    `);
  }

  function flower(x,y,size,id){
    const r = size/3;
    const pet = `
      <ellipse cx="${x}" cy="${y-size/2}" rx="${r}" ry="${r*1.25}" ${outlineStyle()} class="paint" data-fill="${id}-p1"/>
      <ellipse cx="${x+size/2}" cy="${y}" rx="${r}" ry="${r*1.25}" transform="rotate(90 ${x+size/2} ${y})" ${outlineStyle()} class="paint" data-fill="${id}-p2"/>
      <ellipse cx="${x}" cy="${y+size/2}" rx="${r}" ry="${r*1.25}" ${outlineStyle()} class="paint" data-fill="${id}-p3"/>
      <ellipse cx="${x-size/2}" cy="${y}" rx="${r}" ry="${r*1.25}" transform="rotate(90 ${x-size/2} ${y})" ${outlineStyle()} class="paint" data-fill="${id}-p4"/>
    `;
    const stem = `
      <path d="M${x} ${y+size/2} C${x} ${y+size} ${x} ${y+size+60} ${x} ${y+size+120}"
        ${outlineStyle()} class="paint" data-fill="${id}-stem"/>
      <path d="M${x} ${y+size+60} C${x-50} ${y+size+40} ${x-70} ${y+size+90} ${x-20} ${y+size+100} C${x-5} ${y+size+102} ${x+0} ${y+size+90} ${x} ${y+size+80}"
        ${outlineStyle()} class="paint" data-fill="${id}-leaf1"/>
      <path d="M${x} ${y+size+80} C${x+50} ${y+size+60} ${x+70} ${y+size+110} ${x+15} ${y+size+125} C${x+2} ${y+size+128} ${x} ${y+size+115} ${x} ${y+size+105}"
        ${outlineStyle()} class="paint" data-fill="${id}-leaf2"/>
    `;
    const center = `<circle cx="${x}" cy="${y}" r="${r*0.75}" ${outlineStyle()} class="paint" data-fill="${id}-center"/>`;
    return pet + stem + center;
  }

  function svgRocket(){
    return svgWrap(`
      <path d="M120 520 C210 470 310 560 400 520 C520 470 610 560 700 520 L800 600 L0 600 Z"
        ${outlineStyle()} class="paint" data-fill="ground"/>

      <path d="M400 110 C470 170 520 260 520 350 C520 470 460 530 400 530 C340 530 280 470 280 350 C280 260 330 170 400 110 Z"
        ${outlineStyle()} class="paint" data-fill="rocketBody"/>

      <path d="M400 110 C435 145 465 195 480 240 C445 252 355 252 320 240 C335 195 365 145 400 110 Z"
        ${outlineStyle()} class="paint" data-fill="rocketTop"/>

      <circle cx="400" cy="300" r="55" ${outlineStyle()} class="paint" data-fill="window"/>
      <path d="M280 340 C230 360 200 410 210 465 C255 445 300 420 320 380 Z"
        ${outlineStyle()} class="paint" data-fill="finL"/>
      <path d="M520 340 C570 360 600 410 590 465 C545 445 500 420 480 380 Z"
        ${outlineStyle()} class="paint" data-fill="finR"/>

      <path d="M360 530 C350 560 360 590 400 595 C440 590 450 560 440 530 Z"
        ${outlineStyle()} class="paint" data-fill="flame1"/>
      <path d="M380 540 C375 560 385 578 400 580 C415 578 425 560 420 540 Z"
        ${outlineStyle()} class="paint" data-fill="flame2"/>

      <path d="M120 140 C160 110 210 110 240 140 C270 170 250 220 210 230 C165 240 120 205 120 140 Z"
        ${outlineStyle()} class="paint" data-fill="cloudA"/>
      <path d="M590 150 C630 120 690 120 720 150 C750 180 730 230 690 240 C635 255 575 215 590 150 Z"
        ${outlineStyle()} class="paint" data-fill="cloudB"/>

      ${starsScatter()}
    `);
  }

  function starsScatter(){
    return `
      <path d="M85 70 l14 18 22 2-17 14 6 21-19-11-19 11 6-21-17-14 22-2z"
        ${outlineStyle()} class="paint" data-fill="s1"/>
      <path d="M720 60 l12 16 20 2-15 12 5 19-17-10-17 10 5-19-15-12 20-2z"
        ${outlineStyle()} class="paint" data-fill="s2"/>
      <path d="M680 320 l10 13 16 2-12 10 4 15-14-8-14 8 4-15-12-10 16-2z"
        ${outlineStyle()} class="paint" data-fill="s3"/>
      <path d="M140 300 l10 13 16 2-12 10 4 15-14-8-14 8 4-15-12-10 16-2z"
        ${outlineStyle()} class="paint" data-fill="s4"/>
    `;
  }

  function svgDino(){
    return svgWrap(`
      <path d="M0 470 C160 430 280 520 400 470 C540 415 660 520 800 470 L800 600 L0 600 Z"
        ${outlineStyle()} class="paint" data-fill="grass"/>

      <!-- Dino body -->
      <path d="M250 360 C220 250 290 190 380 200 C430 145 520 165 545 235
               C590 245 630 290 620 345 C610 410 555 450 500 445
               C470 495 395 510 345 475 C285 455 265 410 250 360 Z"
        ${outlineStyle()} class="paint" data-fill="dinoBody"/>

      <!-- Belly -->
      <path d="M320 360 C315 290 360 260 410 265 C455 270 495 305 500 360
               C505 420 455 452 410 450 C360 448 325 420 320 360 Z"
        ${outlineStyle()} class="paint" data-fill="belly"/>

      <!-- Head + face -->
      <path d="M365 210 C380 175 425 160 460 175 C500 190 505 240 480 265
               C455 292 410 290 385 265 C365 245 355 235 365 210 Z"
        ${outlineStyle()} class="paint" data-fill="head"/>

      <circle cx="450" cy="215" r="10" ${outlineStyle()} class="paint" data-fill="eye"/>
      <path d="M430 245 C445 255 462 255 478 245" stroke="#1f2937" stroke-width="6" stroke-linecap="round"/>

      <!-- Spikes -->
      ${spike(340,205,"sp1")}
      ${spike(310,235,"sp2")}
      ${spike(285,275,"sp3")}
      ${spike(275,325,"sp4")}
      ${spike(285,375,"sp5")}

      <!-- Tail -->
      <path d="M250 350 C190 345 150 320 120 290 C155 285 195 270 230 250"
        ${outlineStyle()} class="paint" data-fill="tail"/>

      <!-- Feet -->
      <path d="M330 475 C310 525 310 545 350 545 C390 545 395 525 375 480 Z"
        ${outlineStyle()} class="paint" data-fill="footL"/>
      <path d="M470 470 C450 525 455 545 495 545 C535 545 540 525 520 475 Z"
        ${outlineStyle()} class="paint" data-fill="footR"/>

      <path d="M610 200 C640 175 685 175 710 200 C735 225 720 265 685 275 C645 286 605 255 610 200 Z"
        ${outlineStyle()} class="paint" data-fill="cloud"/>
    `);
  }

  function spike(x,y,id){
    return `<path d="M${x} ${y} L${x-18} ${y+40} L${x+18} ${y+40} Z" ${outlineStyle()} class="paint" data-fill="${id}"/>`;
  }

  function svgCastle(){
    return svgWrap(`
      <path d="M0 480 C140 430 270 520 410 480 C540 440 640 520 800 480 L800 600 L0 600 Z"
        ${outlineStyle()} class="paint" data-fill="ground"/>

      <rect x="240" y="240" width="320" height="260" rx="16"
        ${outlineStyle()} class="paint" data-fill="wall"/>

      <rect x="200" y="210" width="90" height="290" rx="16"
        ${outlineStyle()} class="paint" data-fill="towerL"/>
      <rect x="510" y="210" width="90" height="290" rx="16"
        ${outlineStyle()} class="paint" data-fill="towerR"/>

      <path d="M200 210 L200 160 L220 180 L240 160 L260 180 L280 160 L290 170 L290 210 Z"
        ${outlineStyle()} class="paint" data-fill="roofL"/>
      <path d="M510 210 L510 160 L530 180 L550 160 L570 180 L590 160 L600 170 L600 210 Z"
        ${outlineStyle()} class="paint" data-fill="roofR"/>

      <path d="M240 240 L240 180 L270 200 L300 180 L330 200 L360 180 L390 200 L420 180 L450 200 L480 180 L510 200 L540 180 L560 195 L560 240 Z"
        ${outlineStyle()} class="paint" data-fill="roofMid"/>

      <path d="M365 500 C340 470 340 430 365 405 C390 380 430 380 455 405 C480 430 480 470 455 500 Z"
        ${outlineStyle()} class="paint" data-fill="door"/>

      <rect x="290" y="310" width="70" height="70" rx="10"
        ${outlineStyle()} class="paint" data-fill="win1"/>
      <rect x="440" y="310" width="70" height="70" rx="10"
        ${outlineStyle()} class="paint" data-fill="win2"/>

      ${starsScatter()}
      <path d="M120 150 C160 115 215 115 245 150 C275 185 255 235 210 245 C160 258 110 220 120 150 Z"
        ${outlineStyle()} class="paint" data-fill="cloudA"/>
      <path d="M590 155 C630 120 690 120 720 150 C750 180 735 235 690 245 C635 258 575 220 590 155 Z"
        ${outlineStyle()} class="paint" data-fill="cloudB"/>
    `);
  }

  function svgOcean(){
    return svgWrap(`
      <path d="M0 360 C120 330 220 395 320 360 C420 330 520 395 620 360 C700 332 760 340 800 352 L800 600 L0 600 Z"
        ${outlineStyle()} class="paint" data-fill="sea"/>

      <path d="M0 430 C120 400 220 465 320 430 C420 400 520 465 620 430 C700 402 760 410 800 422"
        stroke="#1f2937" stroke-width="6" stroke-linecap="round" fill="none"/>

      <!-- Big fish -->
      <path d="M260 330 C290 285 360 270 420 300 C470 325 470 365 420 390
               C360 420 290 405 260 360 C230 385 205 400 180 405
               C195 380 200 360 200 345 C200 330 195 310 180 285
               C205 290 230 305 260 330 Z"
        ${outlineStyle()} class="paint" data-fill="fish1"/>
      <circle cx="385" cy="330" r="10" ${outlineStyle()} class="paint" data-fill="fishEye"/>

      <!-- Turtle -->
      <path d="M590 355 C560 315 560 275 600 255 C645 233 705 253 725 300
               C742 340 725 382 685 395 C640 410 605 390 590 355 Z"
        ${outlineStyle()} class="paint" data-fill="shell"/>
      <circle cx="715" cy="315" r="18" ${outlineStyle()} class="paint" data-fill="head"/>
      <path d="M605 395 C590 420 560 435 535 435 C545 415 555 400 565 388 Z"
        ${outlineStyle()} class="paint" data-fill="fin1"/>
      <path d="M670 405 C665 430 645 450 620 455 C620 430 630 412 642 400 Z"
        ${outlineStyle()} class="paint" data-fill="fin2"/>

      <!-- Bubbles -->
      ${bubble(120,160,"b1")}${bubble(165,210,"b2")}${bubble(120,250,"b3")}
      ${bubble(720,160,"b4")}${bubble(680,210,"b5")}${bubble(720,250,"b6")}

      <path d="M120 120 C160 85 210 85 240 120 C270 155 250 205 210 215 C165 227 115 190 120 120 Z"
        ${outlineStyle()} class="paint" data-fill="cloud"/>
    `);
  }

  function bubble(x,y,id){
    return `<circle cx="${x}" cy="${y}" r="20" ${outlineStyle()} class="paint" data-fill="${id}"/>`;
  }

  function svgStars(){
    return svgWrap(`
      <path d="M0 470 C130 420 240 520 360 470 C500 415 620 520 800 470 L800 600 L0 600 Z"
        ${outlineStyle()} class="paint" data-fill="ground"/>

      <path d="M520 170 C520 120 560 90 600 90 C650 90 690 130 690 180
               C690 240 640 280 585 270 C550 265 520 230 520 170 Z"
        ${outlineStyle()} class="paint" data-fill="moon"/>

      <path d="M200 360 C220 310 270 280 320 290 C360 298 395 330 405 375
               C420 445 360 505 285 495 C220 488 180 425 200 360 Z"
        ${outlineStyle()} class="paint" data-fill="cloudBig"/>

      ${starsScatter()}
      ${starsScatter().replaceAll("data-fill=\"s","data-fill=\"t")}

      <path d="M120 220 C150 190 205 190 230 220 C255 250 240 295 205 305 C160 318 112 280 120 220 Z"
        ${outlineStyle()} class="paint" data-fill="cloud1"/>
      <path d="M610 235 C640 205 695 205 720 235 C745 265 730 310 695 320 C650 333 602 295 610 235 Z"
        ${outlineStyle()} class="paint" data-fill="cloud2"/>
    `);
  }

  // ---------- State ----------
  const svgHost = document.getElementById("svgHost");
  const gallery = document.getElementById("gallery");
  const progressEl = document.getElementById("progress");
  const hintEl = document.getElementById("hint");
  const toast = document.getElementById("toast");
  const art = document.getElementById("art");
  const fx = document.getElementById("fx");

  let activePicture = null;
  let fillMap = new Map(); // data-fill -> current color

  // ---------- Gallery ----------
  function renderGallery(){
    gallery.innerHTML = "";
    PICTURES.forEach(p => {
      const wrap = document.createElement("div");
      wrap.className = "thumb";
      wrap.innerHTML = p.svg().replace('aria-label="Colouring picture"', 'aria-label="Thumbnail picture"');
      const lab = document.createElement("div");
      lab.className = "thumbLabel";
      lab.textContent = p.label;
      wrap.appendChild(lab);
      wrap.addEventListener("click", () => loadPicture(p.id));
      gallery.appendChild(wrap);
    });
  }

  // ---------- Load picture ----------
  function loadPicture(id){
    activePicture = PICTURES.find(p => p.id === id);
    fillMap.clear();
    toast.classList.remove("show");

    gallery.classList.remove("show");
    svgHost.style.display = "block";
    svgHost.innerHTML = activePicture.svg();

    hookPaintAreas();
    updateProgress();
    hintEl.innerHTML = `You picked <b>${activePicture.label}</b>. <small>Choose a colour, then tap a shape.</small>`;
  }

  function showGallery(){
    activePicture = null;
    fillMap.clear();
    toast.classList.remove("show");

    svgHost.style.display = "none";
    svgHost.innerHTML = "";
    gallery.classList.add("show");

    progressEl.textContent = "0 / 0 filled";
    hintEl.innerHTML = `Pick a picture, then choose a colour. <small>Tap an area to fill.</small>`;
  }

  // ---------- Paint logic ----------
  function hookPaintAreas(){
    const svg = svgHost.querySelector("svg");
    if(!svg) return;

    // Make paint areas clickable
    const areas = svg.querySelectorAll(".paint");
    areas.forEach(el => {
      el.style.fill = "#ffffff";
      el.addEventListener("click", (e) => {
        const key = el.getAttribute("data-fill");
        fillMap.set(key, currentColor);
        el.style.fill = currentColor;

        // tiny tap feedback without distorting colours
        el.style.filter = "brightness(1.04)";
        setTimeout(() => el.style.filter = "", 110);

        updateProgress();
      }, {passive:true});
    });

    // fit confetti canvas size
    resizeFx();
  }

  function updateProgress(){
    const svg = svgHost.querySelector("svg");
    if(!svg){
      progressEl.textContent = "0 / 0 filled";
      return;
    }
    const areas = [...svg.querySelectorAll(".paint")];
    const total = areas.length;
    let filled = 0;
    areas.forEach(a => {
      const key = a.getAttribute("data-fill");
      if(fillMap.has(key)) filled++;
    });
    progressEl.textContent = `${filled} / ${total} filled`;

    if(total > 0 && filled === total){
      celebrate();
    }
  }

  // ---------- Buttons ----------
  document.getElementById("backBtn").addEventListener("click", showGallery);

  document.getElementById("resetBtn").addEventListener("click", () => {
    fillMap.clear();
    toast.classList.remove("show");
    const svg = svgHost.querySelector("svg");
    if(svg){
      svg.querySelectorAll(".paint").forEach(el => el.style.fill = "#ffffff");
    }
    updateProgress();
  });

  document.getElementById("surpriseBtn").addEventListener("click", () => {
    const svg = svgHost.querySelector("svg");
    if(!svg) return;
    const areas = [...svg.querySelectorAll(".paint")];
    areas.forEach(el => {
      const c = COLORS[Math.floor(Math.random() * COLORS.length)].hex;
      const key = el.getAttribute("data-fill");
      fillMap.set(key, c);
      el.style.fill = c;
    });
    updateProgress();
  });

  // ---------- Confetti / sparkle celebration ----------
  let confettiTimer = null;
  function resizeFx(){
    const r = fx.getBoundingClientRect();
    fx.width = Math.max(1, Math.floor(r.width * devicePixelRatio));
    fx.height = Math.max(1, Math.floor(r.height * devicePixelRatio));
  }
  window.addEventListener("resize", () => { resizeFx(); }, {passive:true});

  function celebrate(){
    toast.textContent = "✨ Yay! You finished! ✨";
    toast.classList.add("show");
    burstConfetti();
    playDing();
  }

  function burstConfetti(){
    resizeFx();
    const ctx = fx.getContext("2d");
    const w = fx.width, h = fx.height;

    const pieces = Array.from({length: 120}, () => ({
      x: Math.random()*w,
      y: Math.random()*h*0.25,
      vx: (Math.random()-0.5)*6*devicePixelRatio,
      vy: (Math.random()*2+2)*devicePixelRatio,
      r: (Math.random()*5+3)*devicePixelRatio,
      a: Math.random()*Math.PI*2,
      va: (Math.random()-0.5)*0.25,
      life: Math.random()*40+60,
      col: ["#FF6FB1","#FFD54A","#4CC9FF","#63F5A6","#8B7CFF","#FF9B3A"][Math.floor(Math.random()*6)]
    }));

    let t = 0;
    if(confettiTimer) cancelAnimationFrame(confettiTimer);

    const tick = () => {
      t++;
      ctx.clearRect(0,0,w,h);
      pieces.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy *= 0.995;
        p.a += p.va;
        p.life--;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.a);
        ctx.fillStyle = p.col;
        ctx.globalAlpha = Math.max(0, p.life/80);
        ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        ctx.restore();
      });

      // remove dead
      for(let i=pieces.length-1;i>=0;i--){
        if(pieces[i].life<=0 || pieces[i].y>h+50) pieces.splice(i,1);
      }
      if(pieces.length){
        confettiTimer = requestAnimationFrame(tick);
      } else {
        ctx.clearRect(0,0,w,h);
      }
    };
    tick();
  }

  // ---------- Audio (soft background) ----------
  const musicToggle = document.getElementById("musicToggle");
  const musicDot = document.getElementById("musicDot");
  const musicText = document.getElementById("musicText");

  let musicOn = true;
  let audioCtx = null;
  let musicNode = null;

  function ensureAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  // gentle ambient pad
  function startMusic(){
    ensureAudio();
    if(musicNode) return;

    const ctx = audioCtx;
    const o1 = ctx.createOscillator();
    const o2 = ctx.createOscillator();
    const g = ctx.createGain();
    const f = ctx.createBiquadFilter();

    o1.type = "sine";
    o2.type = "triangle";
    o1.frequency.value = 220;
    o2.frequency.value = 330;

    f.type = "lowpass";
    f.frequency.value = 900;
    g.gain.value = 0.0;

    o1.connect(f); o2.connect(f);
    f.connect(g);
    g.connect(ctx.destination);

    o1.start(); o2.start();

    // fade in
    g.gain.setValueAtTime(0.0, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0.06, ctx.currentTime + 1.2);

    // slow wobble
    const lfo = ctx.createOscillator();
    const lfoG = ctx.createGain();
    lfo.type="sine";
    lfo.frequency.value = 0.08;
    lfoG.gain.value = 20;
    lfo.connect(lfoG);
    lfoG.connect(o2.frequency);
    lfo.start();

    musicNode = {o1,o2,g,f,lfo,lfoG};
  }

  function stopMusic(){
    if(!audioCtx || !musicNode) return;
    const ctx = audioCtx;
    musicNode.g.gain.cancelScheduledValues(ctx.currentTime);
    musicNode.g.gain.setValueAtTime(musicNode.g.gain.value, ctx.currentTime);
    musicNode.g.gain.linearRampToValueAtTime(0.0, ctx.currentTime + 0.6);

    setTimeout(() => {
      try{
        musicNode.o1.stop(); musicNode.o2.stop(); musicNode.lfo.stop();
      }catch(e){}
      musicNode = null;
    }, 650);
  }

  function setMusicUI(){
    musicDot.classList.toggle("off", !musicOn);
    musicText.textContent = musicOn ? "Music: On" : "Music: Off";
    musicToggle.setAttribute("aria-pressed", String(musicOn));
  }

  musicToggle.addEventListener("click", async () => {
    musicOn = !musicOn;
    setMusicUI();
    try{
      if(musicOn){
        if(audioCtx && audioCtx.state === "suspended") await audioCtx.resume();
        startMusic();
      }else{
        stopMusic();
      }
    }catch(e){}
  });

  // tiny success ding
  function playDing(){
    if(!musicOn) return;
    try{
      ensureAudio();
      const ctx = audioCtx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(880, ctx.currentTime);
      o.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.18);

      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);

      o.connect(g); g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + 0.28);
    }catch(e){}
  }

  // ---------- Init ----------
  renderPalette();
  renderGallery();
  showGallery();
  setMusicUI();

  // autoplay music only after first interaction (browser rules)
  const unlock = async () => {
    try{
      if(!musicOn) return;
      ensureAudio();
      if(audioCtx.state === "suspended") await audioCtx.resume();
      startMusic();
      window.removeEventListener("pointerdown", unlock);
      window.removeEventListener("keydown", unlock);
    }catch(e){}
  };
  window.addEventListener("pointerdown", unlock, {passive:true});
  window.addEventListener("keydown", unlock);

})();
</script>
</body>
</html>
