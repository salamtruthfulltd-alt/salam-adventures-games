<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Magic Colour Tap | Salam Adventures</title>
  <style>
    :root{
      --bg1:#fde7ef;
      --bg2:#e6f4ff;
      --ink:#111827;
      --muted:#6b7280;
      --panel:#ffffffef;
      --shadow: 0 26px 80px rgba(0,0,0,.16);
      --shadow2: 0 16px 34px rgba(0,0,0,.12);
      --radius: 22px;

      /* FIXED colourful border (no rotation) */
      --borderGrad: conic-gradient(
        from 180deg,
        #ff5fa2, #ffcc3a, #58e3ff, #7c5cff, #ff8b3a, #62f5a6, #ff5fa2
      );
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 10% 10%, #ffffffaa 0, transparent 55%),
        radial-gradient(900px 650px at 90% 10%, #ffffffaa 0, transparent 50%),
        linear-gradient(120deg, var(--bg1), var(--bg2));
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .frame{
      width:min(1200px, 100%);
      border-radius: calc(var(--radius) + 10px);
      background: var(--borderGrad) border-box;
      padding: 10px;
      box-shadow: var(--shadow);
      position:relative;
    }
    .frame::before{
      content:"";
      position:absolute;
      inset:7px;
      border-radius: calc(var(--radius) + 6px);
      pointer-events:none;
      background:
        radial-gradient(6px 6px at 10% 18%, rgba(255,255,255,.55) 0 55%, transparent 58%),
        radial-gradient(5px 5px at 85% 22%, rgba(255,255,255,.50) 0 55%, transparent 58%),
        radial-gradient(4px 4px at 70% 85%, rgba(255,255,255,.45) 0 55%, transparent 58%),
        radial-gradient(5px 5px at 25% 78%, rgba(255,255,255,.45) 0 55%, transparent 58%);
      mix-blend-mode: screen;
      opacity:.85;
    }

    .card{
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
      overflow:hidden;
      position:relative;
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.86));
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width: 220px;
    }
    .title h1{
      margin:0;
      font-size: clamp(20px, 2.6vw, 30px);
      letter-spacing:-.02em;
      line-height:1.05;
    }
    .title p{
      margin:0;
      color:var(--muted);
      font-weight:650;
      font-size:13px;
      line-height:1.25;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      user-select:none;
      white-space:nowrap;
    }
    .btn.primary{
      background:#111827;
      color:#fff;
      border-color: transparent;
      box-shadow: 0 16px 28px rgba(17,24,39,.22);
    }
    .btn:active{transform:translateY(1px)}

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.18)}
    .dot.off{background:#9ca3af;box-shadow:0 0 0 4px rgba(156,163,175,.18)}

    /* SINGLE PANEL GAME AREA */
    .game{
      position:relative;
      padding: 12px;
    }

    .board{
      border-radius:18px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
      min-height: 560px;
    }

    .boardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90));
    }
    .hint{
      font-weight:900;
      font-size:13px;
      color:#374151;
    }
    .badge{
      font-weight:900;
      font-size:12px;
      color:#111827;
      background: #f3f4f6;
      border:1px solid rgba(0,0,0,.08);
      padding:8px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .canvasWrap{
      position:relative;
      height: calc(100% - 44px);
      min-height: 516px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
      background:
        radial-gradient(1200px 420px at 10% 10%, rgba(255,92,162,.06), transparent 60%),
        radial-gradient(1000px 420px at 90% 10%, rgba(88,227,255,.07), transparent 55%),
        radial-gradient(900px 520px at 50% 100%, rgba(98,245,166,.06), transparent 58%);
    }

    .art{
      width:min(900px, 100%);
      aspect-ratio: 4 / 3;
      max-height: 620px;
      border-radius:16px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 20px 38px rgba(0,0,0,.12);
      overflow:hidden;
      position:relative;
    }
    .art svg{width:100%;height:100%;display:block;background:#fff}

    /* IMPORTANT: palette is OVERLAY inside the board (never underneath) */
    .paletteBar{
      position:absolute;
      left:12px;
      right:12px;
      bottom:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 10px;
      border-radius:16px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 14px 26px rgba(0,0,0,.12);
      backdrop-filter: blur(6px);
    }

    .palette{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      width:100%;
    }

    .swatch{
      width:44px;
      height:44px;
      border-radius:999px;
      border: 3px solid rgba(255,255,255,.9);
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,.12),
        0 10px 18px rgba(0,0,0,.10);
      cursor:pointer;
      position:relative;
      flex: 0 0 auto;
    }
    .swatch.selected::after{
      content:"✓";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      color:#111827;
      text-shadow: 0 2px 0 rgba(255,255,255,.65);
      font-size:18px;
    }

    .miniTip{
      display:none;
      font-weight:800;
      color:#6b7280;
      font-size:12px;
      white-space:nowrap;
      margin-left:8px;
    }

    .gallery{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      padding:12px;
      width:100%;
      height:100%;
      background:#fff;
    }
    .thumb{
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      box-shadow: 0 14px 26px rgba(0,0,0,.10);
      cursor:pointer;
      transition: transform .12s ease;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .thumb:hover{transform: translateY(-2px)}
    .thumb svg{width:100%; height:100%; display:block}
    .thumbLabel{
      padding:10px 10px 12px;
      font-weight:900;
      font-size:13px;
      border-top:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, #fff, #f9fafb);
    }

    .toast{
      position:absolute;
      left:12px; right:12px; top:12px;
      background: rgba(17,24,39,.92);
      color:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      opacity:0;
      transform: translateY(-8px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      text-align:center;
    }
    .toast.show{opacity:1; transform: translateY(0)}

    #fx{
      position:absolute;
      inset:0;
      pointer-events:none;
    }

    /* keep things readable inside embeds */
    @media (max-width: 760px){
      .miniTip{display:block}
      .swatch{width:40px;height:40px}
      .gallery{grid-template-columns: repeat(2, 1fr);}
    }
    @media (max-width: 480px){
      .swatch{width:38px;height:38px}
      .gallery{grid-template-columns: 1fr;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <div class="card">
        <div class="top">
          <div class="title">
            <h1>Magic Colour Tap</h1>
            <p>Pick a picture → pick a colour → tap to fill ✨</p>
          </div>

          <div class="controls">
            <button class="btn" id="backBtn">Pick a picture</button>
            <button class="btn" id="resetBtn">Reset</button>
            <button class="btn" id="surpriseBtn">Surprise</button>

            <div class="toggle" id="musicToggle" role="button" aria-pressed="true" title="Toggle background music">
              <span class="dot" id="musicDot"></span>
              <span id="musicText">Music: On</span>
            </div>
          </div>
        </div>

        <div class="game">
          <div class="board">
            <div class="boardHeader">
              <div class="hint" id="hint">Pick a picture to start.</div>
              <div class="badge" id="progress">0 / 0 filled</div>
            </div>

            <div class="canvasWrap">
              <div class="art" id="art">
                <canvas id="fx"></canvas>

                <!-- toast -->
                <div class="toast" id="toast">✨ You did it! ✨</div>

                <!-- gallery -->
                <div class="gallery" id="gallery"></div>

                <!-- svg host -->
                <div id="svgHost" style="display:none;width:100%;height:100%;"></div>

                <!-- palette overlay INSIDE game (never under) -->
                <div class="paletteBar" aria-label="Colour palette">
                  <div class="palette" id="palette"></div>
                  <div class="miniTip">Tap shapes (not lines)</div>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(() => {
  // ---- Palette ----
  const COLORS = [
    {name:"Sunshine", hex:"#FFD54A"},
    {name:"Candy Pink", hex:"#FF6FB1"},
    {name:"Sky", hex:"#4CC9FF"},
    {name:"Mint", hex:"#63F5A6"},
    {name:"Lavender", hex:"#8B7CFF"},
    {name:"Orange", hex:"#FF9B3A"},
    {name:"Cherry", hex:"#FF3B4D"},
    {name:"Ocean", hex:"#2D7CFF"},
    {name:"Cocoa", hex:"#8B5E3C"},
    {name:"Cloud", hex:"#E5E7EB"},
    {name:"Night", hex:"#111827"}
  ];

  const paletteEl = document.getElementById("palette");
  let currentColor = COLORS[0].hex;

  function renderPalette(){
    paletteEl.innerHTML = "";
    COLORS.forEach((c, i) => {
      const b = document.createElement("button");
      b.className = "swatch" + (i===0 ? " selected" : "");
      b.style.background = c.hex;
      b.title = c.name;
      b.addEventListener("click", () => {
        currentColor = c.hex;
        [...paletteEl.children].forEach(ch => ch.classList.remove("selected"));
        b.classList.add("selected");
      });
      paletteEl.appendChild(b);
    });
  }

  // ---- Nicer colouring pages (clean + cute + more detail) ----
  // Big bold outlines + multiple fill areas for better “real” colouring pages
  function outline() {
    return `fill="white" stroke="#111827" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"`;
  }
  function wrapSVG(inner){
    return `
      <svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg" aria-label="Colouring page">
        <rect width="800" height="600" fill="#ffffff"/>
        ${inner}
      </svg>`;
  }

  // 1) Cute Unicorn
  function svgUnicorn(){
    return wrapSVG(`
      <!-- clouds -->
      <path d="M90 170 C130 130 190 125 225 160 C265 195 240 245 195 255 C140 268 85 230 90 170 Z" ${outline()} class="paint" data-fill="cloud1"/>
      <path d="M560 160 C600 120 675 120 715 160 C750 198 720 250 670 258 C610 268 545 220 560 160 Z" ${outline()} class="paint" data-fill="cloud2"/>

      <!-- rainbow (separate bands to colour) -->
      <path d="M260 160 C330 95 470 95 540 160 C575 192 590 235 590 275 L560 275 C560 245 548 215 525 192 C465 135 335 135 275 192 C252 215 240 245 240 275 L210 275 C210 235 225 192 260 160 Z" ${outline()} class="paint" data-fill="rain1"/>
      <path d="M285 180 C345 130 455 130 515 180 C540 202 552 232 552 270 L524 270 C524 246 515 226 498 210 C450 170 350 170 302 210 C285 226 276 246 276 270 L248 270 C248 232 260 202 285 180 Z" ${outline()} class="paint" data-fill="rain2"/>
      <path d="M310 202 C360 165 440 165 490 202 C508 215 517 235 517 265 L490 265 C490 250 484 238 472 228 C435 198 365 198 328 228 C316 238 310 250 310 265 L283 265 C283 235 292 215 310 202 Z" ${outline()} class="paint" data-fill="rain3"/>

      <!-- unicorn body -->
      <path d="M260 370 C245 300 290 245 360 250 C395 210 470 215 500 270
               C560 275 600 330 575 385 C545 460 460 475 410 440
               C370 500 270 485 260 410 C255 395 255 382 260 370 Z"
            ${outline()} class="paint" data-fill="body"/>

      <!-- belly -->
      <path d="M345 370 C340 320 380 295 420 300 C470 308 500 350 490 395
               C478 450 410 455 375 430 C355 415 348 395 345 370 Z"
            ${outline()} class="paint" data-fill="belly"/>

      <!-- head -->
      <path d="M350 260 C365 215 420 195 460 210 C505 228 510 285 478 315
               C448 343 395 340 368 312 C350 294 343 282 350 260 Z"
            ${outline()} class="paint" data-fill="head"/>

      <!-- horn -->
      <path d="M430 195 L465 120 L498 205 Z" ${outline()} class="paint" data-fill="horn"/>
      <path d="M455 150 L475 170" stroke="#111827" stroke-width="6" stroke-linecap="round"/>

      <!-- mane (sections) -->
      <path d="M365 240 C335 230 315 255 330 285 C300 285 295 315 320 335 C300 350 315 385 350 380
               C360 395 388 400 410 390 C430 405 470 395 470 370 C510 370 520 335 495 318
               C520 295 500 262 470 268 C455 245 400 230 365 240 Z"
            ${outline()} class="paint" data-fill="mane"/>

      <!-- tail -->
      <path d="M250 360 C205 350 175 330 150 300 C182 295 210 280 235 260"
            ${outline()} class="paint" data-fill="tail"/>

      <!-- legs -->
      <path d="M320 440 C300 500 305 540 350 540 C390 540 395 505 375 445 Z" ${outline()} class="paint" data-fill="leg1"/>
      <path d="M470 430 C450 495 455 540 500 540 C540 540 545 498 525 435 Z" ${outline()} class="paint" data-fill="leg2"/>

      <!-- stars -->
      <path d="M690 70 l12 16 20 2-15 12 5 19-17-10-17 10 5-19-15-12 20-2z" ${outline()} class="paint" data-fill="star1"/>
      <path d="M120 70 l12 16 20 2-15 12 5 19-17-10-17 10 5-19-15-12 20-2z" ${outline()} class="paint" data-fill="star2"/>

      <!-- face -->
      <circle cx="450" cy="265" r="10" ${outline()} class="paint" data-fill="eye"/>
      <path d="M430 295 C445 305 462 305 478 295" stroke="#111827" stroke-width="6" stroke-linecap="round"/>
      <circle cx="420" cy="292" r="6" ${outline()} class="paint" data-fill="cheek"/>
    `);
  }

  // 2) Cute Puppy
  function svgPuppy(){
    return wrapSVG(`
      <!-- ground -->
      <path d="M0 470 C150 430 280 520 410 470 C560 420 650 520 800 470 L800 600 L0 600 Z"
        ${outline()} class="paint" data-fill="ground"/>

      <!-- body -->
      <path d="M260 360 C240 280 285 230 360 240 C395 205 470 210 510 260
               C575 260 610 320 585 380 C560 460 470 480 410 450
               C360 510 260 485 255 410 C252 395 252 380 260 360 Z"
        ${outline()} class="paint" data-fill="body"/>

      <!-- tummy -->
      <path d="M350 365 C350 320 385 295 420 300 C470 308 498 350 488 392
               C476 445 410 450 375 428 C360 418 352 395 350 365 Z"
        ${outline()} class="paint" data-fill="tummy"/>

      <!-- head -->
      <path d="M350 250 C370 205 435 190 480 215 C530 245 530 310 490 340
               C448 372 390 365 360 335 C340 315 338 276 350 250 Z"
        ${outline()} class="paint" data-fill="head"/>

      <!-- ears -->
      <path d="M360 250 C330 240 310 265 320 300 C300 300 290 330 310 348 C330 365 360 350 365 325"
        ${outline()} class="paint" data-fill="ear1"/>
      <path d="M490 240 C530 230 555 265 545 300 C565 300 575 330 555 348 C535 365 505 350 500 325"
        ${outline()} class="paint" data-fill="ear2"/>

      <!-- legs -->
      <path d="M320 440 C300 505 305 540 350 540 C390 540 395 505 375 445 Z"
        ${outline()} class="paint" data-fill="leg1"/>
      <path d="M470 435 C450 500 455 540 500 540 C540 540 545 500 525 438 Z"
        ${outline()} class="paint" data-fill="leg2"/>

      <!-- tail -->
      <path d="M255 355 C210 340 180 315 160 285 C190 282 220 270 245 255"
        ${outline()} class="paint" data-fill="tail"/>

      <!-- face -->
      <circle cx="420" cy="280" r="10" ${outline()} class="paint" data-fill="eye1"/>
      <circle cx="470" cy="280" r="10" ${outline()} class="paint" data-fill="eye2"/>
      <path d="M430 312 C445 332 460 332 475 312" stroke="#111827" stroke-width="6" stroke-linecap="round" fill="none"/>
      <path d="M445 305 C450 300 455 300 460 305 C460 318 445 318 445 305 Z"
        ${outline()} class="paint" data-fill="nose"/>
      <circle cx="400" cy="310" r="6" ${outline()} class="paint" data-fill="cheek1"/>
      <circle cx="490" cy="310" r="6" ${outline()} class="paint" data-fill="cheek2"/>

      <!-- ball -->
      <circle cx="650" cy="420" r="45" ${outline()} class="paint" data-fill="ball"/>
      <path d="M620 420 C650 395 680 395 705 420" stroke="#111827" stroke-width="6" stroke-linecap="round"/>
      <path d="M620 420 C650 445 680 445 705 420" stroke="#111827" stroke-width="6" stroke-linecap="round"/>
    `);
  }

  // 3) Ice Cream (lots of sections)
  function svgIceCream(){
    return wrapSVG(`
      <!-- sprinkles background dots (paintable) -->
      <circle cx="120" cy="120" r="14" ${outline()} class="paint" data-fill="d1"/>
      <circle cx="200" cy="90" r="12" ${outline()} class="paint" data-fill="d2"/>
      <circle cx="680" cy="110" r="14" ${outline()} class="paint" data-fill="d3"/>
      <circle cx="720" cy="180" r="12" ${outline()} class="paint" data-fill="d4"/>
      <circle cx="90" cy="240" r="12" ${outline()} class="paint" data-fill="d5"/>
      <circle cx="730" cy="320" r="14" ${outline()} class="paint" data-fill="d6"/>

      <!-- cone -->
      <path d="M360 560 L440 560 L520 260 L280 260 Z" ${outline()} class="paint" data-fill="cone"/>
      <path d="M305 310 L495 310" stroke="#111827" stroke-width="6" stroke-linecap="round"/>
      <path d="M320 360 L480 360" stroke="#111827" stroke-width="6" stroke-linecap="round"/>
      <path d="M340 410 L460 410" stroke="#111827" stroke-width="6" stroke-linecap="round"/>

      <!-- scoops -->
      <path d="M280 270 C290 185 350 140 400 145 C455 140 515 185 520 270
               C525 345 470 395 400 395 C330 395 275 345 280 270 Z"
        ${outline()} class="paint" data-fill="scoop1"/>

      <path d="M320 210 C330 155 365 120 400 120 C440 120 475 155 485 210
               C495 265 455 300 400 300 C345 300 305 265 320 210 Z"
        ${outline()} class="paint" data-fill="scoop2"/>

      <!-- drizzle -->
      <path d="M315 270 C345 250 360 290 390 270 C420 250 435 290 465 270 C485 260 500 275 505 290 C510 320 485 350 455 355 C420 360 410 330 390 345 C365 370 330 355 320 335 C310 315 300 290 315 270 Z"
        ${outline()} class="paint" data-fill="drizzle"/>

      <!-- cherry -->
      <circle cx="400" cy="95" r="30" ${outline()} class="paint" data-fill="cherry"/>
      <path d="M400 65 C420 40 450 35 470 45" stroke="#111827" stroke-width="6" stroke-linecap="round" fill="none"/>
      <path d="M470 45 C490 55 495 75 485 90" stroke="#111827" stroke-width="6" stroke-linecap="round" fill="none"/>
      <path d="M470 45 C465 60 455 70 440 75" stroke="#111827" stroke-width="6" stroke-linecap="round" fill="none"/>
    `);
  }

  // 4) Rocket (cleaner sections)
  function svgRocket(){
    return wrapSVG(`
      <!-- stars -->
      <path d="M100 90 l12 16 20 2-15 12 5 19-17-10-17 10 5-19-15-12 20-2z" ${outline()} class="paint" data-fill="s1"/>
      <path d="M700 80 l12 16 20 2-15 12 5 19-17-10-17 10 5-19-15-12 20-2z" ${outline()} class="paint" data-fill="s2"/>

      <!-- clouds -->
      <path d="M120 170 C160 135 215 135 245 170 C275 205 255 250 210 260 C160 273 110 235 120 170 Z"
        ${outline()} class="paint" data-fill="c1"/>
      <path d="M580 175 C620 140 690 140 720 175 C750 210 730 255 685 265 C625 278 565 235 580 175 Z"
        ${outline()} class="paint" data-fill="c2"/>

      <!-- body -->
      <path d="M400 120 C470 180 520 270 520 360 C520 485 450 545 400 545 C350 545 280 485 280 360 C280 270 330 180 400 120 Z"
        ${outline()} class="paint" data-fill="body"/>
      <path d="M400 120 C438 155 465 200 480 245 C445 258 355 258 320 245 C335 200 362 155 400 120 Z"
        ${outline()} class="paint" data-fill="nose"/>

      <!-- window -->
      <circle cx="400" cy="305" r="58" ${outline()} class="paint" data-fill="window"/>
      <circle cx="400" cy="305" r="28" ${outline()} class="paint" data-fill="window2"/>

      <!-- fins -->
      <path d="M280 350 C230 372 200 425 212 485 C258 465 300 438 322 392 Z"
        ${outline()} class="paint" data-fill="finL"/>
      <path d="M520 350 C570 372 600 425 588 485 C542 465 500 438 478 392 Z"
        ${outline()} class="paint" data-fill="finR"/>

      <!-- flames -->
      <path d="M360 545 C345 585 370 600 400 600 C430 600 455 585 440 545 Z"
        ${outline()} class="paint" data-fill="flame1"/>
      <path d="M385 555 C378 575 390 590 400 590 C410 590 422 575 415 555 Z"
        ${outline()} class="paint" data-fill="flame2"/>
    `);
  }

  const PICTURES = [
    { id:"unicorn", label:"Unicorn Rainbow", svg: svgUnicorn },
    { id:"puppy",   label:"Happy Puppy",    svg: svgPuppy },
    { id:"ice",     label:"Ice Cream",      svg: svgIceCream },
    { id:"rocket",  label:"Rocket",         svg: svgRocket }
  ];

  // ---- State ----
  const svgHost = document.getElementById("svgHost");
  const gallery = document.getElementById("gallery");
  const progressEl = document.getElementById("progress");
  const hintEl = document.getElementById("hint");
  const toast = document.getElementById("toast");
  const fx = document.getElementById("fx");

  let activePicture = null;
  let fillMap = new Map();

  // ---- Gallery ----
  function renderGallery(){
    gallery.innerHTML = "";
    PICTURES.forEach(p => {
      const wrap = document.createElement("div");
      wrap.className = "thumb";
      wrap.innerHTML = p.svg();
      const lab = document.createElement("div");
      lab.className = "thumbLabel";
      lab.textContent = p.label;
      wrap.appendChild(lab);
      wrap.addEventListener("click", () => loadPicture(p.id));
      gallery.appendChild(wrap);
    });
  }

  function showGallery(){
    activePicture = null;
    fillMap.clear();
    toast.classList.remove("show");

    svgHost.style.display = "none";
    svgHost.innerHTML = "";
    gallery.style.display = "grid";

    progressEl.textContent = "0 / 0 filled";
    hintEl.textContent = "Choose a picture, then colour it in!";
  }

  function loadPicture(id){
    activePicture = PICTURES.find(p => p.id === id);
    fillMap.clear();
    toast.classList.remove("show");

    gallery.style.display = "none";
    svgHost.style.display = "block";
    svgHost.innerHTML = activePicture.svg();

    hookPaintAreas();
    updateProgress();
    hintEl.textContent = `Colour: ${activePicture.label} — tap an area to fill.`;
    resizeFx();
  }

  // ---- Paint ----
  function hookPaintAreas(){
    const svg = svgHost.querySelector("svg");
    if(!svg) return;
    const areas = svg.querySelectorAll(".paint");
    areas.forEach(el => {
      el.style.fill = "#ffffff";
      el.addEventListener("click", () => {
        const key = el.getAttribute("data-fill");
        fillMap.set(key, currentColor);
        el.style.fill = currentColor;

        // tiny feedback, no colour distortion
        el.style.filter = "brightness(1.03)";
        setTimeout(() => el.style.filter = "", 100);

        updateProgress();
      }, {passive:true});
    });
  }

  function updateProgress(){
    const svg = svgHost.querySelector("svg");
    if(!svg){
      progressEl.textContent = "0 / 0 filled";
      return;
    }
    const areas = [...svg.querySelectorAll(".paint")];
    const total = areas.length;
    let filled = 0;
    areas.forEach(a => {
      const key = a.getAttribute("data-fill");
      if(fillMap.has(key)) filled++;
    });
    progressEl.textContent = `${filled} / ${total} filled`;
    if(total>0 && filled===total) celebrate();
  }

  // ---- Celebration ----
  function resizeFx(){
    const r = fx.getBoundingClientRect();
    fx.width = Math.max(1, Math.floor(r.width * devicePixelRatio));
    fx.height = Math.max(1, Math.floor(r.height * devicePixelRatio));
  }
  window.addEventListener("resize", resizeFx, {passive:true});

  let confettiRAF = null;
  function celebrate(){
    toast.textContent = "✨ You finished! ✨";
    toast.classList.add("show");
    burstConfetti();
    playDing();
  }

  function burstConfetti(){
    resizeFx();
    const ctx = fx.getContext("2d");
    const w = fx.width, h = fx.height;

    const cols = ["#FF6FB1","#FFD54A","#4CC9FF","#63F5A6","#8B7CFF","#FF9B3A"];
    const pieces = Array.from({length: 120}, () => ({
      x: Math.random()*w,
      y: Math.random()*h*0.25,
      vx: (Math.random()-0.5)*6*devicePixelRatio,
      vy: (Math.random()*2+2)*devicePixelRatio,
      r: (Math.random()*5+3)*devicePixelRatio,
      a: Math.random()*Math.PI*2,
      va: (Math.random()-0.5)*0.25,
      life: Math.random()*40+60,
      col: cols[Math.floor(Math.random()*cols.length)]
    }));

    if(confettiRAF) cancelAnimationFrame(confettiRAF);

    const tick = () => {
      ctx.clearRect(0,0,w,h);
      for(const p of pieces){
        p.x += p.vx; p.y += p.vy; p.a += p.va; p.life--;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.a);
        ctx.fillStyle = p.col;
        ctx.globalAlpha = Math.max(0, p.life/80);
        ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        ctx.restore();
      }
      for(let i=pieces.length-1;i>=0;i--){
        if(pieces[i].life<=0 || pieces[i].y>h+60) pieces.splice(i,1);
      }
      if(pieces.length) confettiRAF = requestAnimationFrame(tick);
      else ctx.clearRect(0,0,w,h);
    };
    tick();
  }

  // ---- Controls ----
  document.getElementById("backBtn").addEventListener("click", showGallery);

  document.getElementById("resetBtn").addEventListener("click", () => {
    fillMap.clear();
    toast.classList.remove("show");
    const svg = svgHost.querySelector("svg");
    if(svg) svg.querySelectorAll(".paint").forEach(el => el.style.fill="#ffffff");
    updateProgress();
  });

  document.getElementById("surpriseBtn").addEventListener("click", () => {
    const svg = svgHost.querySelector("svg");
    if(!svg) return;
    svg.querySelectorAll(".paint").forEach(el => {
      const c = COLORS[Math.floor(Math.random()*COLORS.length)].hex;
      fillMap.set(el.getAttribute("data-fill"), c);
      el.style.fill = c;
    });
    updateProgress();
  });

  // ---- Music + Ding ----
  const musicToggle = document.getElementById("musicToggle");
  const musicDot = document.getElementById("musicDot");
  const musicText = document.getElementById("musicText");

  let musicOn = true;
  let audioCtx = null;
  let musicNode = null;

  function ensureAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  function startMusic(){
    ensureAudio();
    if(musicNode) return;
    const ctx = audioCtx;

    const o1 = ctx.createOscillator();
    const o2 = ctx.createOscillator();
    const g = ctx.createGain();
    const f = ctx.createBiquadFilter();

    o1.type = "sine"; o2.type="triangle";
    o1.frequency.value = 220;
    o2.frequency.value = 330;

    f.type="lowpass"; f.frequency.value = 900;
    g.gain.value = 0.0;

    o1.connect(f); o2.connect(f);
    f.connect(g); g.connect(ctx.destination);

    o1.start(); o2.start();
    g.gain.setValueAtTime(0.0, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0.06, ctx.currentTime + 1.2);

    const lfo = ctx.createOscillator();
    const lfoG = ctx.createGain();
    lfo.type="sine"; lfo.frequency.value = 0.08;
    lfoG.gain.value = 20;
    lfo.connect(lfoG); lfoG.connect(o2.frequency);
    lfo.start();

    musicNode = {o1,o2,g,lfo};
  }

  function stopMusic(){
    if(!audioCtx || !musicNode) return;
    const ctx = audioCtx;
    musicNode.g.gain.cancelScheduledValues(ctx.currentTime);
    musicNode.g.gain.setValueAtTime(musicNode.g.gain.value, ctx.currentTime);
    musicNode.g.gain.linearRampToValueAtTime(0.0, ctx.currentTime + 0.6);
    setTimeout(() => {
      try{ musicNode.o1.stop(); musicNode.o2.stop(); musicNode.lfo.stop(); }catch(e){}
      musicNode = null;
    }, 650);
  }

  function setMusicUI(){
    musicDot.classList.toggle("off", !musicOn);
    musicText.textContent = musicOn ? "Music: On" : "Music: Off";
    musicToggle.setAttribute("aria-pressed", String(musicOn));
  }

  musicToggle.addEventListener("click", async () => {
    musicOn = !musicOn;
    setMusicUI();
    try{
      if(musicOn){
        if(audioCtx && audioCtx.state==="suspended") await audioCtx.resume();
        startMusic();
      }else{
        stopMusic();
      }
    }catch(e){}
  });

  function playDing(){
    if(!musicOn) return;
    try{
      ensureAudio();
      const ctx = audioCtx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type="sine";
      o.frequency.setValueAtTime(880, ctx.currentTime);
      o.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.18);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
      o.connect(g); g.connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime + 0.28);
    }catch(e){}
  }

  // Autoplay only after first tap (browser rule)
  const unlock = async () => {
    try{
      if(!musicOn) return;
      ensureAudio();
      if(audioCtx.state==="suspended") await audioCtx.resume();
      startMusic();
      window.removeEventListener("pointerdown", unlock);
      window.removeEventListener("keydown", unlock);
    }catch(e){}
  };
  window.addEventListener("pointerdown", unlock, {passive:true});
  window.addEventListener("keydown", unlock);

  // ---- Init ----
  renderPalette();
  renderGallery();
  showGallery();
  setMusicUI();
})();
</script>
</body>
</html>
