<script>
/* =========================================================
   SALAM COLOURING GAME â€“ FULL UPGRADE
   Paint Mode + Tap Fill Mode + Blank Mode
   Keeps original framework
========================================================= */

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

/* ---------------- PAGES ---------------- */

const pages = [
  "colouring images/butterfly.png",
  "colouring images/car.png",
  "colouring images/chest.png",
  "colouring images/dino.png",
  "colouring images/dog.png",
  "colouring images/doll.png",
  "colouring images/house.png",
  "colouring images/kids.png",
  "colouring images/plane.png",
  "colouring images/prince.png",
  "colouring images/swan.png",
  "colouring images/veg.png"
];

let currentPage = 0;
let gameMode = "paint"; // paint | fill | blank
const baseImage = new Image();

function setCanvasSize() {
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.width * 0.66 * dpr;
}
setCanvasSize();
window.addEventListener("resize", () => {
  setCanvasSize();
  if (gameMode !== "blank") loadPage(currentPage);
});

function loadPage(index) {
  currentPage = (index + pages.length) % pages.length;
  baseImage.src = encodeURI(pages[currentPage]);
}

baseImage.onload = () => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const ratio = Math.min(
    canvas.width / baseImage.width,
    canvas.height / baseImage.height
  );

  const w = baseImage.width * ratio;
  const h = baseImage.height * ratio;
  const x = (canvas.width - w) / 2;
  const y = (canvas.height - h) / 2;

  ctx.drawImage(baseImage, x, y, w, h);
};

/* ---------------- MODE BUTTONS ---------------- */

const modeBar = document.createElement("div");
modeBar.style.display = "flex";
modeBar.style.gap = "10px";
modeBar.style.justifyContent = "center";
modeBar.style.marginBottom = "10px";

modeBar.innerHTML = `
<button class="kidbtn b1" id="paintMode">ðŸ–Œ Paint Mode</button>
<button class="kidbtn b2" id="fillMode">ðŸª£ Tap Fill</button>
<button class="kidbtn b3" id="blankMode">ðŸ“„ Blank Page</button>
`;

document.querySelector(".wrap").prepend(modeBar);

document.getElementById("paintMode").onclick = () => gameMode = "paint";
document.getElementById("fillMode").onclick = () => gameMode = "fill";
document.getElementById("blankMode").onclick = () => {
  gameMode = "blank";
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,canvas.width,canvas.height);
};

/* ---------------- UNDO ---------------- */

const undoStack = [];
function pushUndo(){
  undoStack.push(ctx.getImageData(0,0,canvas.width,canvas.height));
  if (undoStack.length > 20) undoStack.shift();
}
function undo(){
  const last = undoStack.pop();
  if(last) ctx.putImageData(last,0,0);
}
document.getElementById("undoBtn").onclick = undo;

/* ---------------- FILL TOOL ---------------- */

function floodFill(startX, startY, fillColor) {
  const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = imgData.data;
  const width = canvas.width;

  const stack = [[startX,startY]];
  const index = (startY * width + startX) * 4;

  const target = [
    data[index],
    data[index+1],
    data[index+2],
    data[index+3]
  ];

  const fill = hexToRgba(fillColor);

  if (matchColor(target, fill)) return;

  while(stack.length){
    const [x,y] = stack.pop();
    const i = (y * width + x) * 4;

    const current = [
      data[i],
      data[i+1],
      data[i+2],
      data[i+3]
    ];

    if (!matchColor(current, target)) continue;

    data[i] = fill[0];
    data[i+1] = fill[1];
    data[i+2] = fill[2];
    data[i+3] = 255;

    if (x>0) stack.push([x-1,y]);
    if (x<width-1) stack.push([x+1,y]);
    if (y>0) stack.push([x,y-1]);
    if (y<canvas.height-1) stack.push([x,y+1]);
  }

  ctx.putImageData(imgData,0,0);
}

function hexToRgba(hex){
  const bigint = parseInt(hex.replace("#",""),16);
  return [(bigint>>16)&255,(bigint>>8)&255,bigint&255,255];
}

function matchColor(a,b){
  return a[0]===b[0] && a[1]===b[1] && a[2]===b[2];
}

/* ---------------- DRAW ENGINE ---------------- */

let drawing = false;
let brushColor = "#2563eb";
let brushSize = 18;

canvas.addEventListener("pointerdown", e => {
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const x = Math.floor((e.clientX - rect.left) * dpr);
  const y = Math.floor((e.clientY - rect.top) * dpr);

  pushUndo();

  if (gameMode === "fill") {
    floodFill(x,y,brushColor);
    return;
  }

  drawing = true;
  ctx.beginPath();
  ctx.moveTo(x,y);
});

canvas.addEventListener("pointermove", e => {
  if (!drawing || gameMode !== "paint") return;

  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const x = (e.clientX - rect.left) * dpr;
  const y = (e.clientY - rect.top) * dpr;

  ctx.strokeStyle = brushColor;
  ctx.lineWidth = brushSize;
  ctx.lineCap = "round";
  ctx.lineTo(x,y);
  ctx.stroke();
});

canvas.addEventListener("pointerup", ()=> drawing=false);
canvas.addEventListener("pointerleave", ()=> drawing=false);

/* ---------------- NAV BUTTONS ---------------- */

document.getElementById("nextBtn").onclick = ()=> {
  if (gameMode !== "blank") loadPage(currentPage+1);
};
document.getElementById("prevBtn").onclick = ()=> {
  if (gameMode !== "blank") loadPage(currentPage-1);
};
document.getElementById("cleanBtn").onclick = ()=> {
  if (gameMode === "blank") {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  } else {
    loadPage(currentPage);
  }
};

loadPage(0);
</script>
