<div id="salam-colouring-game"></div>

<script>
(() => {
  // =========================
  // CONFIG (EDIT THIS)
  // =========================
  // If your images are on your site, set BASE_PATH like:
  // const BASE_PATH = "/wp-content/uploads/colouring-images/";
  //
  // If they're served from the same folder as the page, use:
  // const BASE_PATH = "colouring images/";
  //
  // If they're on GitHub raw (not ideal for production), it would be something like:
  // const BASE_PATH = "https://raw.githubusercontent.com/USER/REPO/main/colouring%20images/";
  const BASE_PATH = "colouring images/";  // <-- CHANGE THIS IF NEEDED

  const FILES = [
    "butterfly.png","car.png","chest.png","dino.png","dog.png","doll.png",
    "house.png","kids.png","plane.png","prince.png","swan.png","veg.png"
  ];

  // =========================
  // BUILD UI (SELF-CONTAINED)
  // =========================
  const mount = document.getElementById("salam-colouring-game") || (() => {
    const d = document.createElement("div");
    document.body.appendChild(d);
    return d;
  })();

  mount.innerHTML = `
    <style>
      .sg-wrap{max-width:1100px;margin:14px auto;padding:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
      .sg-stage{border-radius:24px;padding:12px;position:relative;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)}
      .sg-stage::before{content:"";position:absolute;inset:-2px;border-radius:26px;
        background:conic-gradient(from 0deg,#ff3d3d,#ffd93d,#3dff6a,#3ddcff,#7c3dff,#ff3d3d);
        animation:sg-spin 2.8s linear infinite, sg-pulse 1.1s ease-in-out infinite;z-index:0}
      .sg-stage::after{content:"";position:absolute;inset:6px;border-radius:20px;background:#0b1220;opacity:.85;z-index:0}
      .sg-stage.noflash::before{animation:none;opacity:.35}
      @keyframes sg-spin{to{transform:rotate(360deg)}}
      @keyframes sg-pulse{0%,100%{filter:brightness(1)saturate(1.2)}50%{filter:brightness(1.25)saturate(1.8)}}

      .sg-card{position:relative;z-index:1;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);
        border-radius:18px;padding:10px}
      .sg-canvas{width:100%;display:block;border-radius:16px;background:#fff;touch-action:none}
      .sg-row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;margin:0 0 12px 0}
      .sg-pill{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:999px;
        background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.18);color:#d8e6ff;font-size:12px}
      .sg-pill input{accent-color:#22c55e}
      .sg-pill input[type=range]{width:160px}
      .sg-btn{
        border:none;border-radius:18px;padding:12px 14px;cursor:pointer;font-weight:900;
        box-shadow:0 12px 30px rgba(0,0,0,.25);display:flex;align-items:center;gap:10px;
        user-select:none;transition:transform .08s ease,filter .2s ease;font-size:14px;color:#0b1220
      }
      .sg-btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
      .sg-btn:active{transform:translateY(0) scale(.99)}
      .b1{background:linear-gradient(135deg,#60a5fa,#34d399)}
      .b2{background:linear-gradient(135deg,#fbbf24,#fb7185)}
      .b3{background:linear-gradient(135deg,#a78bfa,#60a5fa)}
      .b4{background:linear-gradient(135deg,#34d399,#fbbf24)}
      .b5{background:linear-gradient(135deg,#fb7185,#a78bfa)}
      .b6{background:linear-gradient(135deg,#fbbf24,#60a5fa)}
      .sg-modebar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:0 0 10px 0}
      .sg-small{color:#cfe0ff;font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:10px}
      .sg-kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:11px;padding:3px 7px;border-radius:8px;
        border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:#cfe0ff}
      .sg-err{margin:10px 0 0 0;padding:10px 12px;border-radius:14px;background:rgba(239,68,68,.15);
        border:1px solid rgba(239,68,68,.35);color:#ffd1d1;font-size:13px;display:none}
      .sg-swatches{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;margin-top:10px}
      .sg-swatch{aspect-ratio:1/1;border-radius:12px;border:1px solid rgba(255,255,255,.16);cursor:pointer;
        box-shadow:inset 0 0 0 2px rgba(0,0,0,.12),0 6px 14px rgba(0,0,0,.25)}
      .sg-swatch.sel{outline:2px solid rgba(98,255,207,.9);outline-offset:2px}
    </style>

    <div class="sg-wrap">
      <div class="sg-row">
        <button class="sg-btn b1" id="sgPrev">‚¨ÖÔ∏è Back</button>
        <button class="sg-btn b2" id="sgNext">Next ‚û°Ô∏è</button>
        <button class="sg-btn b3" id="sgMusic">üéµ Music: Off</button>
        <button class="sg-btn b4" id="sgUndo">‚Ü©Ô∏è Oops!</button>
        <button class="sg-btn b5" id="sgClean">üßº Clean Page</button>
        <button class="sg-btn b6" id="sgSave">‚≠ê Save My Art</button>

        <div class="sg-pill">
          <input type="checkbox" id="sgFlash" checked />
          <label for="sgFlash">Flashing Border</label>
        </div>
        <div class="sg-pill">
          <label for="sgSize">Brush Size</label>
          <input id="sgSize" type="range" min="3" max="60" value="18" />
          <span class="sg-kbd" id="sgSizeVal">18</span>
        </div>
      </div>

      <div class="sg-modebar">
        <button class="sg-btn b1" id="sgPaint">üñå Paint</button>
        <button class="sg-btn b2" id="sgFill">ü™£ Tap Fill</button>
        <button class="sg-btn b3" id="sgBlank">üìÑ Blank</button>
      </div>

      <div class="sg-stage" id="sgStage">
        <div class="sg-card">
          <canvas class="sg-canvas" id="sgCanvas"></canvas>
          <div class="sg-small">
            <div>Tip: Tap Fill for little ones ¬∑ Paint for free drawing ¬∑ Blank for SEN</div>
            <div><span class="sg-kbd" id="sgPage">Page 1</span></div>
          </div>
          <div class="sg-err" id="sgErr"></div>

          <div class="sg-swatches" id="sgSwatches"></div>
        </div>
      </div>
    </div>
  `;

  const $ = (id) => mount.querySelector(id);
  const stage = $("#sgStage");
  const errBox = $("#sgErr");
  const pageLabel = $("#sgPage");

  // =========================
  // CANVAS + STATE
  // =========================
  const canvas = $("#sgCanvas");
  const ctx = canvas.getContext("2d", { willReadFrequently:true });

  let mode = "paint"; // paint | fill | blank
  let current = 0;
  let brushColor = "#2563eb";
  let brushSize = 18;
  const undoStack = [];
  const MAX_UNDO = 20;

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function setCanvasSize(){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const cssW = Math.max(320, rect.width || 900);
    const cssH = cssW * (2/3);
    canvas.style.height = cssH + "px";
    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
  }

  function pushUndo(){
    try{
      undoStack.push(ctx.getImageData(0,0,canvas.width,canvas.height));
      if (undoStack.length > MAX_UNDO) undoStack.shift();
    }catch(e){}
  }
  function undo(){
    const last = undoStack.pop();
    if (last) ctx.putImageData(last,0,0);
  }

  function blank(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  // =========================
  // LOAD IMAGE
  // =========================
  const img = new Image();
  img.decoding = "async";

  function drawImage(){
    blank();
    const ratio = Math.min(canvas.width / img.naturalWidth, canvas.height / img.naturalHeight);
    const w = img.naturalWidth * ratio;
    const h = img.naturalHeight * ratio;
    const x = (canvas.width - w) / 2;
    const y = (canvas.height - h) / 2;
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    ctx.drawImage(img, x, y, w, h);
  }

  function load(index){
    clearErr();
    current = (index + FILES.length) % FILES.length;
    pageLabel.textContent = `Page ${current + 1}`;
    if (mode === "blank") return; // don't load image in blank mode
    img.src = BASE_PATH + FILES[current];
  }

  img.onload = () => {
    drawImage();
    undoStack.length = 0;
  };
  img.onerror = () => {
    blank();
    showErr(
      "Images not loading. Fix BASE_PATH in the script. " +
      "Tried: " + (BASE_PATH + FILES[current])
    );
  };

  // =========================
  // FLOOD FILL (simple + stable)
  // =========================
  function hexToRgb(hex){
    const v = parseInt(hex.replace("#",""),16);
    return [(v>>16)&255,(v>>8)&255,v&255];
  }
  function match(a,b){ return a[0]===b[0] && a[1]===b[1] && a[2]===b[2]; }

  function floodFill(x,y,hex){
    const w = canvas.width, h = canvas.height;
    if (x<0||y<0||x>=w||y>=h) return;

    const imgData = ctx.getImageData(0,0,w,h);
    const data = imgData.data;
    const i0 = (y*w + x)*4;

    const target = [data[i0], data[i0+1], data[i0+2]];
    const fill = hexToRgb(hex);
    if (match(target, fill)) return;

    const stack = [[x,y]];
    while(stack.length){
      const [px,py] = stack.pop();
      if (px<0||py<0||px>=w||py>=h) continue;
      const i = (py*w + px)*4;
      const cur = [data[i], data[i+1], data[i+2]];
      if (!match(cur, target)) continue;

      data[i]=fill[0]; data[i+1]=fill[1]; data[i+2]=fill[2]; data[i+3]=255;
      stack.push([px-1,py],[px+1,py],[px,py-1],[px,py+1]);
    }
    ctx.putImageData(imgData,0,0);
  }

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    return {
      x: Math.floor((e.clientX - rect.left) * dpr),
      y: Math.floor((e.clientY - rect.top) * dpr)
    };
  }

  // =========================
  // DRAW
  // =========================
  let drawing = false;

  canvas.addEventListener("pointerdown", (e) => {
    const p = getPos(e);
    pushUndo();

    if (mode === "fill"){
      floodFill(p.x, p.y, brushColor);
      return;
    }
    if (mode === "paint"){
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    }
  });

  canvas.addEventListener("pointermove", (e) => {
    if (!drawing || mode !== "paint") return;
    const p = getPos(e);
    ctx.strokeStyle = brushColor;
    ctx.lineWidth = brushSize;
    ctx.lineCap = "round";
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  });

  canvas.addEventListener("pointerup", () => drawing=false);
  canvas.addEventListener("pointerleave", () => drawing=false);

  // =========================
  // UI HOOKS
  // =========================
  $("#sgFlash").addEventListener("change", (e) => {
    stage.classList.toggle("noflash", !e.target.checked);
  });

  $("#sgSize").addEventListener("input", (e) => {
    brushSize = parseInt(e.target.value,10);
    $("#sgSizeVal").textContent = String(brushSize);
  });

  $("#sgPrev").addEventListener("click", () => { if (mode !== "blank") load(current-1); });
  $("#sgNext").addEventListener("click", () => { if (mode !== "blank") load(current+1); });
  $("#sgUndo").addEventListener("click", undo);
  $("#sgClean").addEventListener("click", () => {
    undoStack.length = 0;
    if (mode === "blank") blank();
    else load(current);
  });

  $("#sgSave").addEventListener("click", () => {
    const a = document.createElement("a");
    a.download = "my_colouring.png";
    a.href = canvas.toDataURL("image/png");
    a.click();
  });

  $("#sgPaint").addEventListener("click", () => { mode="paint"; });
  $("#sgFill").addEventListener("click", () => { mode="fill"; });
  $("#sgBlank").addEventListener("click", () => {
    mode="blank";
    undoStack.length = 0;
    blank();
  });

  // Basic swatches
  const colours = [
    "#000000","#ffffff","#ef4444","#f97316","#facc15",
    "#22c55e","#10b981","#06b6d4","#3b82f6","#6366f1",
    "#a855f7","#ec4899","#f43f5e","#8b5cf6","#14b8a6",
    "#84cc16","#eab308","#fb7185","#60a5fa","#94a3b8"
  ];
  const sw = $("#sgSwatches");
  function renderSwatches(){
    sw.innerHTML = "";
    colours.forEach(c=>{
      const d = document.createElement("div");
      d.className = "sg-swatch" + (c===brushColor ? " sel" : "");
      d.style.background = c === "#ffffff" ? "linear-gradient(135deg,#fff,#dbeafe)" : c;
      d.addEventListener("click", ()=>{
        brushColor = c;
        [...sw.children].forEach(x=>x.classList.remove("sel"));
        d.classList.add("sel");
      });
      sw.appendChild(d);
    });
  }
  renderSwatches();

  // Music button (safe no-crash stub: toggles text; you can plug your synth later)
  let musicOn = false;
  $("#sgMusic").addEventListener("click", () => {
    musicOn = !musicOn;
    $("#sgMusic").textContent = musicOn ? "üéµ Music: On" : "üéµ Music: Off";
  });

  // Start
  setCanvasSize();
  window.addEventListener("resize", () => {
    setCanvasSize();
    if (mode === "blank") blank();
    else load(current);
  });

  blank();
  load(0);
})();
</script>
