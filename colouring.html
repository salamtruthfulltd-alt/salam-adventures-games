<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salam Adventures ‚Ä¢ Colouring</title>
  <style>
    :root{
      --bg1:#0b1024;
      --stroke:rgba(255,255,255,.14);
      --stroke2:rgba(255,255,255,.09);
      --txt:#eaf0ff;
      --muted:rgba(234,240,255,.7);
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --round:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(92,189,255,.20), transparent 60%),
        radial-gradient(700px 450px at 80% 20%, rgba(255,152,238,.20), transparent 60%),
        radial-gradient(700px 450px at 40% 85%, rgba(138,255,189,.14), transparent 60%),
        linear-gradient(180deg, var(--bg1), #050816 70%);
      display:flex;
      justify-content:center;
      padding:28px;
    }

    .app{
      width:min(980px,96vw);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius: 28px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .main{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      padding:14px;
    }

    .left,.right{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--stroke2);
      border-radius: var(--round);
      padding:14px;
      min-height: 660px;
    }
    .left{ display:flex; flex-direction:column; gap:12px; }

    /* image area */
    .canvas-wrap{
      background: linear-gradient(180deg, rgba(5,8,22,.8), rgba(7,10,28,.65));
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--round);
      padding:12px;
      box-shadow: inset 0 0 22px rgba(0,0,0,.55);
    }

    .canvas-stage{
      width: 420px;
      height: 420px;
      margin: 0 auto;
      background:#ffffff;
      border-radius: 16px;
      border: 10px solid rgba(255,255,255,.88);
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .canvas-stage img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      pointer-events:none;
      user-select:none;
      position:absolute;
      inset:0;
      background:#fff;
    }

    .img-error{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      text-align:center;
      color:#111;
      font-weight:900;
      background: repeating-linear-gradient(
        45deg,
        #f7f7f7,
        #f7f7f7 12px,
        #ffffff 12px,
        #ffffff 24px
      );
    }

    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      touch-action:none;
    }

    .tip{
      font-size:13px;
      color:var(--muted);
      margin-top:10px;
      padding:10px 12px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
    }
    .statusbar{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      margin-top:6px;
      font-size:12.5px;
      color:rgba(234,240,255,.75);
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
    }

    /* buttons */
    .pill{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(12,18,42,.55);
      color:var(--txt);
      border-radius: 999px;
      padding:10px 14px;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      transition:.15s transform, .15s filter, .15s opacity;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: inset 0 0 14px rgba(255,255,255,.06);
    }
    .pill:hover{ transform: translateY(-1px); filter:brightness(1.08) }
    .pill:active{ transform: translateY(0px) scale(.99) }
    .pill[disabled]{opacity:.55; cursor:not-allowed}

    .b-back{ background:linear-gradient(90deg,#63c7ff,#6a8bff); }
    .b-next{ background:linear-gradient(90deg,#ffd86b,#ff8c6b); color:#1b1020;}
    .b-save{ background:linear-gradient(90deg,#baff6b,#6bffda); color:#06131b;}
    .b-undo{ background:linear-gradient(90deg,#7bffef,#7ba2ff); color:#06131b;}
    .b-clear{ background:linear-gradient(90deg,#ff7bf0,#ff7b7b); color:#1b0b12;}
    .b-paint{ background:linear-gradient(90deg,#ff6bd6,#8a7bff);}
    .b-fill{ background:linear-gradient(90deg,#5effa1,#5cc2ff); color:#06131b;}
    .b-erase{ background:linear-gradient(90deg,#ff7b7b,#ffb86b); color:#221105;}
    .b-fx{ background:linear-gradient(90deg,#ffef5c,#ff7bf0); color:#1b1020;}

    /* mode buttons under paint */
    .modebar{
      margin-top:12px;
      padding:12px;
      background: linear-gradient(145deg, #1e2a4a, #0c122a);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 20px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      box-shadow: inset 0 0 12px rgba(255,255,255,0.05);
    }

    /* brushes under image */
    .brushes-container{
      padding: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .brushes-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
      font-size:13px;
      color:rgba(234,240,255,.9);
    }
    .mini{ font-size:12px; color:var(--muted); }

    .brush-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
    }
    .brush-btn{
      padding: 10px 14px;
      font-size: 13.5px;
      font-weight:900;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:.12s transform, .12s filter;
      box-shadow: inset 0 0 14px rgba(255,255,255,.06);
    }
    .brush-btn:hover{ transform: translateY(-1px); filter:brightness(1.08) }
    .brush-btn.active{
      outline: 2px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.12);
    }

    /* right panel */
    .panel-title{
      font-weight:900;
      letter-spacing:.2px;
      margin:4px 0 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .row{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding:12px;
      margin-bottom:12px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
    }
    .chip{
      font-size:12px;
      font-weight:900;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(234,240,255,.9);
    }
    .chip strong{ color:#fff }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }

    /* ‚úÖ FIX: colours must go INTO the boxes below (not a top line) */
    .palette-wrap{
      margin-top:10px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding:12px;
    }
    .palette-title{
      font-weight:900;
      font-size:13px;
      margin:0 0 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:rgba(234,240,255,.92);
    }

    /* Grid boxes */
    .palette{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){
      .palette{ grid-template-columns: repeat(6, 1fr); }
    }
    @media (max-width: 520px){
      .palette{ grid-template-columns: repeat(5, 1fr); }
    }

    /* Each swatch sits INSIDE a box */
    .swatch-box{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.05);
      box-shadow: inset 0 0 14px rgba(255,255,255,.06);
      padding:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:.12s transform, .12s filter;
      user-select:none;
    }
    .swatch-box:hover{ transform: translateY(-1px); filter:brightness(1.08); }
    .swatch-box.active{
      outline: 2px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.10);
    }

    /* The actual colour circle */
    .swatch{
      width:100%;
      height:100%;
      border-radius: 10px;
      border:2px solid rgba(255,255,255,.65);
      box-shadow: 0 10px 25px rgba(0,0,0,.25), inset 0 0 10px rgba(255,255,255,.12);
      background:#000;
      position:relative;
    }

    /* make WHITE visible */
    .swatch.is-white{
      background:
        linear-gradient(45deg,#e9e9e9 25%,transparent 25%),
        linear-gradient(-45deg,#e9e9e9 25%,transparent 25%),
        linear-gradient(45deg,transparent 75%,#e9e9e9 75%),
        linear-gradient(-45deg,transparent 75%,#e9e9e9 75%);
      background-size:14px 14px;
      background-position:0 0, 0 7px, 7px -7px, -7px 0px;
    }

    .slider{
      margin-top:10px;
      display:grid;
      gap:10px;
    }
    .slider label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12.5px;
      color:rgba(234,240,255,.85);
      gap:10px;
    }
    input[type="range"]{ width:100% }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
    }
    .toggle button{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(90deg,#6bffda,#ff7bf0);
      color:#09121f;
      font-weight:900;
      padding:10px 14px;
      cursor:pointer;
      box-shadow: inset 0 0 12px rgba(255,255,255,.22);
    }

    .small-note{
      font-size:12px;
      color:rgba(234,240,255,.68);
      margin-top:8px;
      line-height:1.35;
    }

    @media (max-width: 880px){
      body{ padding:14px; }
      .main{ grid-template-columns: 1fr; }
      .left,.right{ min-height:auto; }
      .canvas-stage{ width:min(420px, 84vw); height:min(420px, 84vw); }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Colouring App">
    <div class="main">
      <!-- LEFT -->
      <div class="left">
        <div class="canvas-wrap">
          <div class="canvas-stage" id="stage">
            <img id="lineart" alt="Colouring Page" src="butterfly.png" />
            <div class="img-error" id="imgError">
              IMAGE NOT FOUND üò¨<br><br>
              Put your PNGs in the same folder as this HTML:<br>
              butterfly.png / star.png / balloon.png / salam.png
            </div>
            <canvas id="paintLayer"></canvas>
            <canvas id="fxLayer"></canvas>
          </div>

          <div class="tip">
            Tip: <b>Paint</b> = draw ‚Ä¢ <b>Fill</b> = tap an area ‚Ä¢ <b>Erase</b> removes paint only ‚Ä¢ <b>FX</b> adds sparkles.
          </div>

          <div class="statusbar">
            <span class="badge" id="pageBadge">Page 1</span>
            <span class="badge" id="modeBadge">Mode: Paint</span>
          </div>

          <!-- mode buttons under image -->
          <div class="modebar">
            <button class="pill b-paint" id="btnModePaint">üñåÔ∏è Paint</button>
            <button class="pill b-fill" id="btnModeFill">ü™£ Fill</button>
            <button class="pill b-erase" id="btnModeErase">üßº Erase</button>
            <button class="pill b-fx" id="btnModeFX">‚ú® FX</button>
          </div>
        </div>

        <!-- brushes under image -->
        <div class="brushes-container">
          <div class="brushes-title">
            <span>üß∞ Brushes</span>
            <span class="mini" id="brushBadge">Round</span>
          </div>

          <div class="brush-row" id="brushRow">
            <button class="brush-btn active" data-brush="round">‚óè Round</button>
            <button class="brush-btn" data-brush="square">‚ñ† Square</button>
            <button class="brush-btn" data-brush="triangle">‚ñ≤ Triangle</button>
            <button class="brush-btn" data-brush="spray">üå´Ô∏è Spray</button>
            <button class="brush-btn" data-brush="star">‚≠ê Star</button>
            <button class="brush-btn" data-brush="glitter">‚ú® Glitter</button>
            <button class="brush-btn" data-brush="multi">üåà Multi</button>
          </div>

          <div class="small-note">
            Brush affects Paint mode. FX mode uses FX selector on the right.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right">
        <div class="panel-title">
          <span>Controls</span>
          <span class="mini">Pages ‚Ä¢ Undo ‚Ä¢ Clear ‚Ä¢ Save ‚Ä¢ Colours</span>
        </div>

        <div class="row">
          <div class="actions">
            <button class="pill b-back" id="btnBack">‚¨ÖÔ∏è Back</button>
            <button class="pill b-next" id="btnNext">Next ‚û°Ô∏è</button>
            <button class="pill b-undo" id="btnUndo">‚Ü©Ô∏è Undo</button>
            <button class="pill b-clear" id="btnClear">üßΩ Clear</button>
            <button class="pill b-save" id="btnSave">üíæ Save</button>
          </div>
          <div class="small-note">Undo affects paint + FX. Clear wipes paint + FX (image stays).</div>
        </div>

        <div class="row">
          <div class="chips">
            <span class="chip">Colour: <strong id="chipColour">#ff4d6d</strong></span>
            <span class="chip">Brush: <strong id="chipBrush">Round</strong></span>
            <span class="chip">FX: <strong id="chipFX">Stars</strong></span>
            <span class="chip">SFX: <strong id="chipSFX">On</strong></span>
          </div>

          <div class="toggle">
            <span class="chip">Sound Effects</span>
            <button id="btnSFX">üîä SFX</button>
          </div>

          <!-- ‚úÖ colours now sit IN a boxed grid below -->
          <div class="palette-wrap">
            <div class="palette-title">
              <span>üé® Colours</span>
              <span class="mini">tap a box</span>
            </div>
            <div class="palette" id="palette"></div>
          </div>

          <div class="slider">
            <label><span>Size</span><span id="valSize">16</span></label>
            <input id="size" type="range" min="4" max="60" value="16"/>

            <label><span>Opacity</span><span id="valOpacity">0.90</span></label>
            <input id="opacity" type="range" min="0.1" max="1" step="0.05" value="0.9"/>

            <label><span>Smooth</span><span id="valSmooth">0.55</span></label>
            <input id="smooth" type="range" min="0" max="0.9" step="0.05" value="0.55"/>
          </div>
        </div>

        <div class="row">
          <div class="panel-title" style="margin:0 0 8px">
            <span>‚ú® FX Selector</span>
            <span class="mini">use in FX mode</span>
          </div>

          <div class="chips" id="fxChips">
            <button class="brush-btn active" data-fx="stars">‚ú® Stars</button>
            <button class="brush-btn" data-fx="glitter">üíé Glitter</button>
            <button class="brush-btn" data-fx="confetti">üéâ Confetti</button>
          </div>

          <div class="small-note">In FX mode: tap canvas to drop effects (they twinkle).</div>
        </div>

        <div class="row">
          <div class="panel-title" style="margin:0 0 8px">
            <span>Pages</span>
            <span class="mini">make sure files exist</span>
          </div>
          <div class="small-note">
            Put these PNGs next to this HTML: <b>butterfly.png</b>, <b>star.png</b>, <b>balloon.png</b>, <b>salam.png</b>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Simple SFX ----------
    let sfxOn = true;
    const beep = (freq=660, dur=0.06, type="sine", vol=0.045) => {
      if(!sfxOn) return;
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.value = vol;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + dur);
        o.onended = () => ctx.close();
      }catch(e){}
    };

    // ---------- Elements ----------
    const stage = document.getElementById('stage');
    const img = document.getElementById('lineart');
    const imgError = document.getElementById('imgError');

    const paint = document.getElementById('paintLayer');
    const fx = document.getElementById('fxLayer');
    const pctx = paint.getContext('2d');
    const fctx = fx.getContext('2d');

    const modeBadge = document.getElementById('modeBadge');
    const pageBadge = document.getElementById('pageBadge');

    const chipColour = document.getElementById('chipColour');
    const chipBrush = document.getElementById('chipBrush');
    const chipFX = document.getElementById('chipFX');
    const chipSFX = document.getElementById('chipSFX');

    const btnBack = document.getElementById('btnBack');
    const btnNext = document.getElementById('btnNext');
    const btnUndo = document.getElementById('btnUndo');
    const btnClear = document.getElementById('btnClear');
    const btnSave = document.getElementById('btnSave');

    const btnModePaint = document.getElementById('btnModePaint');
    const btnModeFill = document.getElementById('btnModeFill');
    const btnModeErase = document.getElementById('btnModeErase');
    const btnModeFX = document.getElementById('btnModeFX');

    const paletteEl = document.getElementById('palette');
    const sizeEl = document.getElementById('size');
    const opacityEl = document.getElementById('opacity');
    const smoothEl = document.getElementById('smooth');
    const valSize = document.getElementById('valSize');
    const valOpacity = document.getElementById('valOpacity');
    const valSmooth = document.getElementById('valSmooth');
    const btnSFX = document.getElementById('btnSFX');

    const brushRow = document.getElementById('brushRow');
    const brushBadge = document.getElementById('brushBadge');
    const fxChips = document.getElementById('fxChips');

    // ---------- State ----------
    // ‚úÖ include your actual pages here
    const pages = ["butterfly.png","star.png","balloon.png","salam.png"];
    let pageIndex = 0;

    let mode = "paint";     // paint | fill | erase | fx
    let brush = "round";    // round | square | triangle | spray | star | glitter | multi
    let fxMode = "stars";   // stars | glitter | confetti

    let colour = "#ff4d6d";
    let brushSize = parseInt(sizeEl.value, 10);
    let opacity = parseFloat(opacityEl.value);
    let smooth = parseFloat(smoothEl.value);

    const undoStack = [];
    const maxUndo = 30;
    const fxParticles = [];

    // ---------- Helpers ----------
    function setMode(m){
      mode = m;
      modeBadge.textContent = "Mode: " + (m[0].toUpperCase() + m.slice(1));
      beep(m === "erase" ? 240 : 660, 0.06, "triangle");
    }
    function brushLabel(b){
      const map = {round:"Round", square:"Square", triangle:"Triangle", spray:"Spray", star:"Star", glitter:"Glitter", multi:"Multi"};
      return map[b] || "Round";
    }
    function setBrush(b){
      brush = b;
      brushBadge.textContent = brushLabel(b);
      chipBrush.textContent = brushLabel(b);
      beep(520, 0.05, "sine");
    }
    function setFX(f){
      fxMode = f;
      chipFX.textContent = f[0].toUpperCase() + f.slice(1);
      beep(780, 0.05, "sine");
    }
    function setColour(c){
      colour = c;
      chipColour.textContent = c.toLowerCase();
    }

    function resizeCanvases(){
      const rect = stage.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      [paint, fx].forEach(cv=>{
        cv.width = Math.round(rect.width * dpr);
        cv.height = Math.round(rect.height * dpr);
        cv.style.width = rect.width + "px";
        cv.style.height = rect.height + "px";
        cv.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
      });

      pctx.lineCap = "round";
      pctx.lineJoin = "round";
    }

    function snapshot(){
      try{
        const p = paint.toDataURL("image/png");
        const f = fx.toDataURL("image/png");
        undoStack.push({p, f, fxParticles: JSON.parse(JSON.stringify(fxParticles))});
        if(undoStack.length > maxUndo) undoStack.shift();
      }catch(e){}
    }

    function restoreSnap(snap){
      if(!snap) return;
      const dpr = window.devicePixelRatio || 1;
      const w = paint.width / dpr;
      const h = paint.height / dpr;

      const ip = new Image();
      ip.onload = ()=>{ pctx.clearRect(0,0,w,h); pctx.drawImage(ip,0,0,w,h); };
      ip.src = snap.p;

      const iff = new Image();
      iff.onload = ()=>{ fctx.clearRect(0,0,w,h); fctx.drawImage(iff,0,0,w,h); };
      iff.src = snap.f;

      fxParticles.length = 0;
      snap.fxParticles.forEach(x=>fxParticles.push(x));
    }

    function clearAll(){
      snapshot();
      const dpr = window.devicePixelRatio || 1;
      const w = paint.width / dpr;
      const h = paint.height / dpr;
      pctx.clearRect(0,0,w,h);
      fctx.clearRect(0,0,w,h);
      fxParticles.length = 0;
      beep(180,0.08,"square");
    }

    function undo(){
      if(undoStack.length === 0) return;
      restoreSnap(undoStack.pop());
      beep(320,0.06,"triangle");
    }

    function loadPage(i){
      pageIndex = Math.max(0, Math.min(pages.length-1, i));
      imgError.style.display = "none";
      img.style.display = "block";
      img.src = pages[pageIndex];
      pageBadge.textContent = `Page ${pageIndex+1}`;

      const dpr = window.devicePixelRatio || 1;
      const w = paint.width / dpr;
      const h = paint.height / dpr;
      pctx.clearRect(0,0,w,h);
      fctx.clearRect(0,0,w,h);
      fxParticles.length = 0;
      undoStack.length = 0;

      btnBack.disabled = pageIndex === 0;
      btnNext.disabled = pageIndex === pages.length-1;
      beep(720,0.06,"sine");
    }

    // ---------- ‚úÖ FIXED Palette (boxes below) ----------
    const colours = [
      "#000000","#ffffff","#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff",
      "#5856d6","#af52de","#ff2d55","#ff6b6b","#8a7bff","#00d4ff","#ffd86b","#baff6b",
      "#ff7bf0","#6bffda","#6a8bff","#ff8c6b","#9ea7b8","#3a3f55"
    ];

    function buildPalette(){
      paletteEl.innerHTML = "";
      colours.forEach(c=>{
        const box = document.createElement("div");
        box.className = "swatch-box" + (c.toLowerCase()===colour.toLowerCase() ? " active" : "");

        const sw = document.createElement("div");
        sw.className = "swatch" + (c.toLowerCase()==="#ffffff" ? " is-white" : "");
        sw.style.background = c;
        sw.title = c;

        box.appendChild(sw);

        box.addEventListener("click", ()=>{
          document.querySelectorAll(".swatch-box").forEach(x=>x.classList.remove("active"));
          box.classList.add("active");
          setColour(c);
          beep(900,0.04,"sine");
        });

        paletteEl.appendChild(box);
      });
    }

    // ---------- Drawing ----------
    let drawing = false;
    let last = null;

    function getPos(e){
      const rect = stage.getBoundingClientRect();
      const t = (e.touches && e.touches[0]) ? e.touches[0] : e;
      return { x: t.clientX - rect.left, y: t.clientY - rect.top };
    }
    function lerp(a,b,t){ return a + (b-a)*t; }

    function drawStar(ctx, x, y, outerR, innerR, points){
      ctx.beginPath();
      const step = Math.PI / points;
      for(let i=0;i<2*points;i++){
        const r = (i%2===0)? outerR : innerR;
        const a = i*step - Math.PI/2;
        ctx.lineTo(x + Math.cos(a)*r, y + Math.sin(a)*r);
      }
      ctx.closePath();
      ctx.fill();
    }

    function stampPaint(x,y){
      const ctx = pctx;
      ctx.save();
      ctx.globalAlpha = opacity;

      ctx.globalCompositeOperation = (mode === "erase") ? "destination-out" : "source-over";
      const r = brushSize/2;

      if(brush === "round" || mode === "erase"){
        ctx.fillStyle = colour;
        ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
      } else if(brush === "square"){
        ctx.fillStyle = colour;
        ctx.fillRect(x-r, y-r, brushSize, brushSize);
      } else if(brush === "triangle"){
        ctx.fillStyle = colour;
        ctx.beginPath();
        ctx.moveTo(x, y-r); ctx.lineTo(x+r, y+r); ctx.lineTo(x-r, y+r);
        ctx.closePath(); ctx.fill();
      } else if(brush === "spray"){
        ctx.fillStyle = colour;
        for(let i=0;i<18;i++){
          const a = Math.random()*Math.PI*2;
          const rr = Math.random()*r;
          ctx.fillRect(x + Math.cos(a)*rr, y + Math.sin(a)*rr, 1.6, 1.6);
        }
      } else if(brush === "star"){
        ctx.fillStyle = colour;
        drawStar(ctx, x, y, r, Math.max(4, r*0.55), 5);
      } else if(brush === "glitter"){
        for(let i=0;i<8;i++){
          const a = Math.random()*Math.PI*2;
          const rr = Math.random()*r;
          ctx.fillStyle = colour;
          drawStar(ctx, x + Math.cos(a)*rr, y + Math.sin(a)*rr, Math.max(2, r*0.35), Math.max(1, r*0.18), 5);
        }
      } else if(brush === "multi"){
        const rainbow = ["#ff3b30","#ff9500","#ffcc00","#34c759","#00c7be","#007aff","#5856d6","#af52de"];
        ctx.fillStyle = rainbow[Math.floor(Math.random()*rainbow.length)];
        ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
      }

      ctx.restore();
    }

    function drawStroke(from, to){
      const steps = Math.max(1, Math.floor(Math.hypot(to.x-from.x, to.y-from.y) / 2));
      for(let i=0;i<=steps;i++){
        const tt = i/steps;
        stampPaint(lerp(from.x,to.x,tt), lerp(from.y,to.y,tt));
      }
    }

    // Fill (paint layer only)
    function hexToRgba(hex, a=1){
      const h = hex.replace("#","");
      const v = parseInt(h.length===3 ? h.split("").map(c=>c+c).join("") : h, 16);
      return { r:(v>>16)&255, g:(v>>8)&255, b:v&255, a: Math.round(a*255) };
    }
    function floodFill(x,y){
      snapshot();

      const dpr = window.devicePixelRatio || 1;
      const w = paint.width / dpr;
      const h = paint.height / dpr;

      const imgData = pctx.getImageData(0,0,w,h);
      const data = imgData.data;

      const ix = Math.floor(x), iy = Math.floor(y);
      if(ix<0||iy<0||ix>=w||iy>=h) return;

      const idx = (iy*w + ix)*4;
      const target = { r:data[idx], g:data[idx+1], b:data[idx+2], a:data[idx+3] };
      const fill = hexToRgba(colour, opacity);

      if (Math.abs(target.r-fill.r)<3 && Math.abs(target.g-fill.g)<3 && Math.abs(target.b-fill.b)<3 && Math.abs(target.a-fill.a)<3){
        return;
      }

      const stack = [[ix,iy]];
      const seen = new Uint8Array(w*h);

      const match = (i)=> data[i]===target.r && data[i+1]===target.g && data[i+2]===target.b && data[i+3]===target.a;

      while(stack.length){
        const [cx,cy] = stack.pop();
        if(cx<0||cy<0||cx>=w||cy>=h) continue;
        const si = cy*w + cx;
        if(seen[si]) continue;
        seen[si]=1;

        const di = si*4;
        if(!match(di)) continue;

        data[di]=fill.r; data[di+1]=fill.g; data[di+2]=fill.b; data[di+3]=fill.a;

        stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
      }

      pctx.putImageData(imgData,0,0);
      beep(520,0.07,"sine");
    }

    // FX
    function addFX(x,y){
      snapshot();
      const base = { x,y, size:Math.max(10, brushSize*0.9), born:performance.now(), life:2500+Math.random()*1200, hue:Math.random()*360, alpha:0.9 };
      if(fxMode==="stars"){
        fxParticles.push({ ...base, type:"star", spin:(Math.random()*2-1)*0.012 }); beep(880,0.05,"triangle");
      } else if(fxMode==="glitter"){
        for(let i=0;i<8;i++){
          fxParticles.push({ ...base, x:x+(Math.random()*2-1)*18, y:y+(Math.random()*2-1)*18, size:Math.max(6, base.size*0.45), type:"spark", spin:(Math.random()*2-1)*0.02 });
        }
        beep(980,0.05,"sine");
      } else {
        for(let i=0;i<16;i++){
          fxParticles.push({ ...base, x:x+(Math.random()*2-1)*12, y:y+(Math.random()*2-1)*12, size:Math.max(6, base.size*0.35), type:"confetti", vx:(Math.random()*2-1)*0.7, vy:-0.9-Math.random()*0.8, spin:(Math.random()*2-1)*0.06 });
        }
        beep(700,0.05,"square");
      }
    }

    function renderFX(t){
      const dpr = window.devicePixelRatio || 1;
      const w = fx.width / dpr;
      const h = fx.height / dpr;
      fctx.clearRect(0,0,w,h);

      for(let i=fxParticles.length-1;i>=0;i--){
        const p = fxParticles[i];
        const age = t - p.born;
        const u = age / p.life;
        if(u >= 1){ fxParticles.splice(i,1); continue; }

        const fade = 1 - u;
        const tw = 0.6 + 0.4*Math.sin((age/120) + i);
        const a = Math.max(0, p.alpha * fade * tw);

        fctx.save();
        fctx.globalAlpha = a;
        fctx.fillStyle = (Math.random()<0.6) ? colour : `hsl(${p.hue} 90% 65%)`;

        if(p.type==="star"){
          fctx.translate(p.x,p.y); fctx.rotate(age*p.spin);
          drawStar(fctx,0,0,p.size*0.55,p.size*0.25,5);
        } else if(p.type==="spark"){
          fctx.translate(p.x,p.y); fctx.rotate(age*p.spin);
          drawStar(fctx,0,0,p.size*0.55,p.size*0.15,6);
        } else {
          p.x += p.vx; p.y += p.vy; p.vy += 0.03;
          fctx.translate(p.x,p.y); fctx.rotate(age*p.spin);
          fctx.fillRect(-p.size/2,-p.size/2,p.size,Math.max(4,p.size*0.45));
        }

        fctx.restore();
      }

      requestAnimationFrame(renderFX);
    }

    // Pointer
    function onDown(e){
      const pos = getPos(e);
      if(mode==="paint" || mode==="erase"){
        snapshot(); drawing = true; last = pos; stampPaint(pos.x,pos.y);
      } else if(mode==="fill"){
        floodFill(pos.x,pos.y);
      } else {
        addFX(pos.x,pos.y);
      }
    }
    function onMove(e){
      if(!drawing) return;
      const pos = getPos(e);
      const sx = lerp(last.x, pos.x, 1 - smooth);
      const sy = lerp(last.y, pos.y, 1 - smooth);
      drawStroke(last, {x:sx,y:sy});
      last = {x:sx,y:sy};
    }
    function onUp(){ drawing=false; last=null; }

    stage.addEventListener("pointerdown", onDown);
    stage.addEventListener("pointermove", onMove);
    window.addEventListener("pointerup", onUp);
    window.addEventListener("pointercancel", onUp);
    stage.addEventListener("touchstart", (e)=>e.preventDefault(), {passive:false});
    stage.addEventListener("touchmove", (e)=>e.preventDefault(), {passive:false});

    // Buttons
    btnModePaint.onclick = ()=> setMode("paint");
    btnModeFill.onclick  = ()=> setMode("fill");
    btnModeErase.onclick = ()=> setMode("erase");
    btnModeFX.onclick    = ()=> setMode("fx");

    btnUndo.onclick = undo;
    btnClear.onclick = clearAll;
    btnBack.onclick = ()=> loadPage(pageIndex-1);
    btnNext.onclick = ()=> loadPage(pageIndex+1);

    btnSFX.onclick = ()=>{
      sfxOn = !sfxOn;
      chipSFX.textContent = sfxOn ? "On" : "Off";
      beep(600,0.05,"sine");
    };

    btnSave.onclick = ()=>{
      const rect = stage.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const out = document.createElement("canvas");
      out.width = Math.round(rect.width * dpr);
      out.height = Math.round(rect.height * dpr);
      const octx = out.getContext("2d");

      octx.fillStyle = "#ffffff";
      octx.fillRect(0,0,out.width,out.height);

      octx.setTransform(dpr,0,0,dpr,0,0);
      octx.drawImage(img, 0,0, rect.width, rect.height);
      octx.drawImage(paint,0,0, rect.width, rect.height);
      octx.drawImage(fx,0,0, rect.width, rect.height);

      const a = document.createElement("a");
      a.download = `colouring-page-${pageIndex+1}.png`;
      a.href = out.toDataURL("image/png");
      a.click();
      beep(980,0.07,"triangle");
    };

    // Brushes
    brushRow.addEventListener("click", (e)=>{
      const btn = e.target.closest(".brush-btn");
      if(!btn) return;
      const b = btn.getAttribute("data-brush");
      document.querySelectorAll("#brushRow .brush-btn").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      setBrush(b);
    });

    // FX selector
    fxChips.addEventListener("click", (e)=>{
      const btn = e.target.closest(".brush-btn");
      if(!btn) return;
      const f = btn.getAttribute("data-fx");
      document.querySelectorAll("#fxChips .brush-btn").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      setFX(f);
    });

    // Sliders
    function syncSliders(){
      brushSize = parseInt(sizeEl.value, 10);
      opacity = parseFloat(opacityEl.value);
      smooth = parseFloat(smoothEl.value);
      valSize.textContent = brushSize;
      valOpacity.textContent = opacity.toFixed(2);
      valSmooth.textContent = smooth.toFixed(2);
    }
    sizeEl.oninput = syncSliders;
    opacityEl.oninput = syncSliders;
    smoothEl.oninput = syncSliders;

    // Image error handling (fix "no colouring images")
    img.addEventListener("error", ()=>{
      img.style.display = "none";
      imgError.style.display = "flex";
    });
    img.addEventListener("load", ()=>{
      imgError.style.display = "none";
      img.style.display = "block";
      resizeCanvases();
    });

    // Init
    function init(){
      resizeCanvases();
      buildPalette();
      syncSliders();
      setColour(colour);
      chipBrush.textContent = "Round";
      chipFX.textContent = "Stars";
      chipSFX.textContent = "On";
      loadPage(0);
      requestAnimationFrame(renderFX);
    }

    window.addEventListener("resize", ()=>{
      const pData = paint.toDataURL("image/png");
      const fData = fx.toDataURL("image/png");
      resizeCanvases();

      const dpr = window.devicePixelRatio || 1;
      const w = paint.width / dpr;
      const h = paint.height / dpr;

      const ip = new Image();
      ip.onload = ()=>{ pctx.clearRect(0,0,w,h); pctx.drawImage(ip,0,0,w,h); };
      ip.src = pData;

      const iff = new Image();
      iff.onload = ()=>{ fctx.clearRect(0,0,w,h); fctx.drawImage(iff,0,0,w,h); };
      iff.src = fData;
    });

    init();
  </script>
</body>
</html>
