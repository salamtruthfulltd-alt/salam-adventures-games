<!DOCTYPE html>
<html>
<head>
    <title>Neon Stacker: HUD Fixed</title>
    <style>
        :root { --neon: #00f2ff; --pink: #ff00de; --gold: #ffcc00; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; overflow: hidden; }

        /* CYBER HUD BORDER */
        #hud-frame {
            position: relative;
            padding: 20px;
            background: #111;
            border: 1px solid rgba(0, 242, 255, 0.2);
            width: 350px;
            box-shadow: 0 0 20px rgba(0,0,0,1);
        }
        .corner { position: absolute; width: 25px; height: 25px; border: 4px solid var(--neon); animation: pulse 2s infinite; }
        .tl { top: -5px; left: -5px; border-right: none; border-bottom: none; }
        .tr { top: -5px; right: -5px; border-left: none; border-bottom: none; }
        .bl { bottom: -5px; left: -5px; border-right: none; border-top: none; }
        .br { bottom: -5px; right: -5px; border-left: none; border-top: none; }
        @keyframes pulse { 0%, 100% { border-color: var(--neon); opacity: 1; } 50% { border-color: var(--pink); opacity: 0.5; } }

        #scan { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: rgba(0, 242, 255, 0.2); animation: scan 3s linear infinite; pointer-events: none; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .stats { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; letter-spacing: 1px; }
        canvas { background: #000; display: block; border: 1px solid #222; cursor: pointer; }

        /* Victory Overlay */
        #victory { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .stars { font-size: 3rem; color: var(--gold); text-shadow: 0 0 10px var(--gold); }
        .btn { background: var(--neon); border: none; padding: 12px 25px; font-weight: bold; cursor: pointer; width: 80%; margin-top: 15px; }
    </style>
</head>
<body onload="updateBoard()">

<div id="hud-frame">
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>
    <div id="scan"></div>

    <div class="stats">
        <div>LVL: <span id="ui-lvl">1</span></div>
        <div>PTS: <span id="ui-pts">0</span></div>
        <div>⏳ <span id="ui-time">60</span></div>
    </div>

    <div id="victory">
        <div class="stars" id="star-box">★ ★ ★</div>
        <h2 style="color:var(--gold)">MISSION SUCCESS</h2>
        <button class="btn" onclick="nextLevel()">NEXT PHASE</button>
    </div>

    <canvas id="gameCanvas" width="350" height="450" onclick="dropBlock()"></canvas>
    
    <button id="start-btn" class="btn" onclick="initGame()" style="width:100%">START ENGINE</button>

    <table style="width:100%; font-size:0.7rem; margin-top:10px; border-top:1px solid #333;">
        <tbody id="board"></tbody>
    </table>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let state = {
        score: 0, total: 0, level: 1, timeLeft: 60,
        stack: [], // Stores {x, w, color}
        current: {x: 0, w: 150, speed: 3, dir: 1},
        active: false,
        goal: 1000
    };
    let timer, loop;

    function initGame() {
        state.active = true;
        state.score = 0;
        state.stack = [{x: 75, w: 200, color: '#333'}]; // Base
        state.current = {x: 0, w: 200, speed: 3 + state.level, dir: 1};
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('victory').style.display = 'none';
        
        if(timer) clearInterval(timer);
        timer = setInterval(() => {
            state.timeLeft--;
            document.getElementById('ui-time').innerText = state.timeLeft;
            if(state.timeLeft <= 0) gameOver();
        }, 1000);
        
        gameLoop();
    }

    function gameLoop() {
        if(!state.active) return;
        
        ctx.clearRect(0,0,350,450);
        
        // Move current block
        state.current.x += (state.current.speed * state.current.dir);
        if(state.current.x + state.current.w > 350 || state.current.x < 0) state.current.dir *= -1;

        // Draw Stacked blocks
        state.stack.forEach((b, i) => {
            ctx.fillStyle = b.color;
            // Draw from bottom up
            ctx.fillRect(b.x, 450 - ((i+1) * 30), b.w, 28);
        });

        // Draw Moving block
        ctx.fillStyle = state.stack.length % 2 === 0 ? '#00f2ff' : '#ff00de';
        ctx.fillRect(state.current.x, 450 - ((state.stack.length + 1) * 30), state.current.w, 28);

        loop = requestAnimationFrame(gameLoop);
    }

    function dropBlock() {
        if(!state.active) return;

        const last = state.stack[state.stack.length - 1];
        const curr = state.current;

        // Intersection Logic
        let x1 = Math.max(last.x, curr.x);
        let x2 = Math.min(last.x + last.w, curr.x + curr.w);
        let newWidth = x2 - x1;

        if(newWidth <= 0) {
            gameOver("STACK COLLAPSED!");
            return;
        }

        // Add to stack
        state.stack.push({
            x: x1, 
            w: newWidth, 
            color: state.stack.length % 2 === 0 ? '#ff00de' : '#00f2ff'
        });

        state.score += 100;
        document.getElementById('ui-pts').innerText = state.score + state.total;

        // Setup next block
        state.current = {
            x: 0, 
            w: newWidth, 
            speed: 3 + state.level + (state.stack.length * 0.2), 
            dir: 1
        };

        // Scroll tower down if it gets too high
        if(state.stack.length > 10) {
            state.stack.shift();
        }

        if(state.score >= state.goal) winLevel();
    }

    function winLevel() {
        state.active = false;
        state.total += state.score;
        cancelAnimationFrame(loop);
        
        let stars = state.timeLeft > 40 ? "★ ★ ★" : (state.timeLeft > 20 ? "★ ★" : "★");
        document.getElementById('star-box').innerText = stars;
        document.getElementById('victory').style.display = 'flex';
    }

    function nextLevel() {
        state.level++;
        state.goal += 500;
        state.timeLeft += 20;
        document.getElementById('ui-lvl').innerText = state.level;
        initGame();
    }

    function gameOver(msg = "TIME EXPIRED") {
        state.active = false;
        clearInterval(timer);
        cancelAnimationFrame(loop);
        let name = prompt(msg + "\nFinal Score: " + (state.score + state.total) + "\nEnter Callsign:");
        if(name) {
            let h = JSON.parse(localStorage.getItem('stack_v5') || '[]');
            h.push({n: name.substring(0,10).toUpperCase(), s: (state.score + state.total)});
            h.sort((a,b) => b.s - a.s);
            localStorage.setItem('stack_v5', JSON.stringify(h.slice(0,5)));
        }
        location.reload();
    }

    function updateBoard() {
        let h = JSON.parse(localStorage.getItem('stack_v5') || '[]');
        document.getElementById('board').innerHTML = h.map((x, i) => 
            `<tr><td>#${i+1}</td><td>${x.n}</td><td>${x.s}</td></tr>`).join('');
    }
</script>
</body>
</html>
