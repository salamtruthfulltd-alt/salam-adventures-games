<!DOCTYPE html>
<html>
<head>
    <title>Cyber Arcade: Fixed Edition</title>
    <style>
        :root { --neon: #00f2ff; --pink: #ff00de; --gold: #ffcc00; --bg: #0a0a0a; }
        body { background: var(--bg); color: white; font-family: 'Courier New', Courier, monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        
        #game-box {
            border: 6px solid var(--neon);
            padding: 20px; border-radius: 20px; background: #111;
            text-align: center; width: 420px;
            animation: borderFlash 2s infinite alternate;
        }
        @keyframes borderFlash {
            from { border-color: var(--neon); box-shadow: 0 0 15px var(--neon); }
            to { border-color: var(--pink); box-shadow: 0 0 35px var(--pink); }
        }

        .stats { display: flex; justify-content: space-around; background: #000; padding: 10px; border-radius: 10px; margin: 10px 0; border: 1px solid #333; }
        .timer-warning { color: #ff3131; font-weight: bold; animation: shake 0.2s infinite; }
        @keyframes shake { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .btn { cursor: pointer; border: none; padding: 12px; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        #bonus-btn { background: var(--gold); color: black; width: 100%; margin-bottom: 15px; border:none; }
        #bonus-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        #screen { min-height: 220px; background: #000; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 15px; border: 1px inset #222; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 80%; }
        .tile { height: 70px; border-radius: 10px; border: 2px solid white; cursor: pointer; opacity: 0.4; }
        .tile.lit { opacity: 1; box-shadow: 0 0 20px white; background-color: white !important; }

        input { font-size: 2rem; width: 120px; text-align: center; background: #222; color: var(--neon); border: 2px solid #444; border-radius: 5px; outline: none; }
        table { width: 100%; font-size: 0.8rem; border-collapse: collapse; margin-top: 10px; }
        th { color: var(--neon); border-bottom: 1px solid #444; padding: 5px; }
        td { padding: 5px; border-bottom: 1px solid #222; }
    </style>
</head>
<body onload="renderLeaderboard()">

<div id="game-box">
    <h2 id="lvl-head" style="margin:0; color: var(--neon);">START MISSION</h2>
    
    <div class="stats">
        <div>‚è≥ <span id="timer-val">30</span>s</div>
        <div>üéØ <span id="score-val">0</span>/<span id="goal-val">5</span></div>
    </div>

    <button id="bonus-btn" class="btn" onclick="useBonus()">‚òÖ SKIP QUESTION ‚òÖ</button>

    <div id="screen">
        <div id="content">
            <button class="btn" style="background:var(--neon); font-size: 1.5rem; color:black;" onclick="initGame()">PLAY NOW</button>
        </div>
    </div>

    <div id="leaderboard">
        <strong>RANKING (LOCAL TOP 10)</strong>
        <table>
            <thead><tr><th>#</th><th>NAME</th><th>LEVEL</th></tr></thead>
            <tbody id="score-body"></tbody>
        </table>
    </div>
</div>

<script>
    let score = 0, level = 1, timeLeft = 30, goal = 5, timerId = null;
    let currentAns = "", sequence = [], userSequence = [], isWatching = false;

    function beep(f, d = 0.2) {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.frequency.value = f;
            o.connect(g); g.connect(ctx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + d);
            o.stop(ctx.currentTime + d);
        } catch(e) { console.log("Audio blocked"); }
    }

    function initGame() {
        score = 0; level = 1; timeLeft = 30; goal = 5;
        document.getElementById('bonus-btn').disabled = false;
        if(timerId) clearInterval(timerId);
        timerId = setInterval(tick, 1000);
        loadTask();
    }

    function tick() {
        timeLeft--;
        document.getElementById('timer-val').innerText = timeLeft;
        if(timeLeft <= 5) document.getElementById('timer-val').classList.add('timer-warning');
        if(timeLeft <= 0) gameOver();
    }

    function loadTask() {
        const stage = document.getElementById('content');
        document.getElementById('score-val').innerText = score;
        document.getElementById('goal-val').innerText = goal;
        document.getElementById('lvl-head').innerText = "PHASE " + level;

        if (level === 1) {
            let a = Math.floor(Math.random() * 9) + 2;
            let b = Math.floor(Math.random() * 9) + 1;
            currentAns = a * b;
            stage.innerHTML = `<h3>Quick Math</h3><h1>${a} √ó ${b}</h1>
                               <input type="number" id="in" autofocus onkeydown="if(event.key==='Enter') verify()">`;
            setTimeout(()=>document.getElementById('in').focus(), 10);
        } 
        else if (level === 2) {
            const colors = ["RED", "BLUE", "GREEN", "YELLOW"];
            const hex = ["#FF4444", "#4444FF", "#44FF44", "#FFFF44"];
            let tIdx = Math.floor(Math.random() * 4);
            let cIdx = Math.floor(Math.random() * 4);
            if(tIdx === cIdx) cIdx = (cIdx + 1) % 4;
            currentAns = colors[cIdx];
            stage.innerHTML = `<h3>Click the INK COLOR</h3>
                               <h1 style="color:${hex[cIdx]}; margin:10px;">${colors[tIdx]}</h1>
                               <div class="grid">
                                   ${colors.map((c, i) => `<button class="btn" style="background:${hex[i]}; color:black; margin:2px;" onclick="verify('${c}')">${c}</button>`).join('')}
                               </div>`;
        }
        else {
            stage.innerHTML = `<h3>Watch & Repeat</h3>
                               <div class="grid" id="memory-grid">
                                   <div class="tile" style="background:#FF4444" id="t0" onclick="tileClick(0)"></div>
                                   <div class="tile" style="background:#4444FF" id="t1" onclick="tileClick(1)"></div>
                                   <div class="tile" style="background:#44FF44" id="t2" onclick="tileClick(2)"></div>
                                   <div class="tile" style="background:#FFFF44" id="t3" onclick="tileClick(3)"></div>
                               </div>`;
            startSequence();
        }
    }

    function verify(choice) {
        let val = choice || document.getElementById('in').value;
        if(val.toString().toUpperCase() == currentAns) {
            score++;
            beep(600);
            if(score >= goal) levelUp(); 
            else loadTask();
        } else {
            beep(100); 
            if(level === 1) document.getElementById('in').value = "";
        }
    }

    function startSequence() {
        isWatching = true;
        userSequence = [];
        sequence.push(Math.floor(Math.random() * 4));
        playSequence();
    }

    async function playSequence() {
        for (let i = 0; i < sequence.length; i++) {
            await new Promise(r => setTimeout(r, 600));
            let tile = document.getElementById('t' + sequence[i]);
            if(tile) {
                tile.classList.add('lit');
                beep(400 + (sequence[i]*50));
                setTimeout(() => tile.classList.remove('lit'), 300);
            }
        }
        isWatching = false;
    }

    function tileClick(id) {
        if(isWatching) return;
        userSequence.push(id);
        beep(400 + (id*50));
        if(userSequence[userSequence.length-1] !== sequence[userSequence.length-1]) {
            beep(50, 0.5);
            sequence = []; score = 0; loadTask(); // Reset level score on memory fail
            return;
        }
        if(userSequence.length === sequence.length) {
            score++;
            if(score >= goal) levelUp(); 
            else setTimeout(startSequence, 800);
        }
    }

    function levelUp() {
        level++; score = 0; timeLeft += 15;
        goal = (level === 3) ? 3 : 5; // Pass marks
        beep(800, 0.5);
        alert("LEVEL UP! Prepare for Phase " + level);
        loadTask();
    }

    function useBonus() {
        document.getElementById('bonus-btn').disabled = true;
        score++;
        if(score >= goal) levelUp(); else loadTask();
    }

    function gameOver() {
        clearInterval(timerId);
        beep(50, 1);
        // Timeout used to ensure the screen updates before the prompt freezes the browser
        setTimeout(() => {
            let n = prompt("MISSION FAILED! You reached Phase " + level + ". Enter Name:");
            if(n) saveScore(n, level);
            document.getElementById('content').innerHTML = `<button class="btn" style="background:var(--neon); color:black;" onclick="initGame()">RESTART</button>`;
        }, 100);
    }

    function saveScore(n, l) {
        let s = JSON.parse(localStorage.getItem('finalScores') || '[]');
        s.push({n: n.substring(0,10).toUpperCase(), l: l});
        s.sort((a,b) => b.l - a.l);
        localStorage.setItem('finalScores', JSON.stringify(s.slice(0,10)));
        renderLeaderboard();
    }

    function renderLeaderboard() {
        let s = JSON.parse(localStorage.getItem('finalScores') || '[]');
        document.getElementById('score-body').innerHTML = s.map((x, i) => `<tr><td>${i+1}</td><td>${x.n}</td><td>${x.l}</td></tr>`).join('');
    }
</script>
</body>
</html>
